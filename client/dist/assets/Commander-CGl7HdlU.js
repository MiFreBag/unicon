import{j as s,B as N,l as I,o as D,m as T,n as J,I as L,f as _}from"./index-BA9dT0pI.js";import{R as y}from"./vendor-CnGqnXYo.js";import"./icons-oCSk50xQ.js";function U(){const[h,g]=y.useState(null),[m,S]=y.useState("."),[B,k]=y.useState([]),[d,j]=y.useState(new Set),[F,$]=y.useState(!1),C=y.useCallback(async r=>{if(!h||h.status!=="connected")return;const v=r??m;$(!0);try{const l=await D(h.id,"list",{path:v});l!=null&&l.success&&(k(l.data||[]),S(v),j(new Set))}finally{$(!1)}},[h,m]);return{conn:h,setConn:g,cwd:m,setCwd:S,items:B,sel:d,setSel:j,list:C,goUp:()=>{if(!m||m==="."||m==="/"){C("/");return}const r=String(m).replace(/\\+/g,"/").split("/");r.pop(),C(r.join("/")||"/")},open:r=>{if(r.isDirectory===!0||r.type==="d"||r.type===1){const l=m==="/"?`/${r.name}`:`${m}/${r.name}`;C(l)}else{const l=new Set(d);l.has(r.name)?l.delete(r.name):l.add(r.name),j(l)}},loading:F}}function H(){const h=U(),g=U(),[m,S]=y.useState([]),[B,k]=y.useState(!1),[d,j]=y.useState({totalFiles:0,doneFiles:0,totalBytes:0,doneBytes:0,running:!1,phase:""}),F=async()=>{const n=((await I()).connections||[]).filter(o=>["localfs","ftp","sftp"].includes(o.type));S(n)};y.useEffect(()=>{F()},[]);const $=async e=>{e.conn&&(e.conn.status!=="connected"&&(await _(e.conn.id),e.setConn({...e.conn,status:"connected"})),await e.list("."))};function C(e){return String(e||"").replace(/\\+/g,"/").replace(/\/+/,"/")}function b(e,n){return!e||e==="."?n||"":e.endsWith("/")?n?`${e}${n}`:e:n?`${e}/${n}`:e}function z(e){const o=C(e).split("/");return o.pop(),o.join("/")||"/"}async function r(e,n){const o=C(n);if(!o||o==="."||o==="/")return;const t=o.split("/");let a="";for(const c of t){a=a?`${a}/${c}`:c;try{await D(e.conn.id,"mkdir",{path:a})}catch{}}}async function v(e,n,o){const t=[];let a=0;const c=C(e.cwd),x=new Map((e.items||[]).map(f=>[f.name,f]));async function u(f,i){const p=await D(e.conn.id,"list",{path:f}),A=(p==null?void 0:p.data)||[];for(const w of A){const E=b(f,w.name),O=b(i,w.name);if(w.isDirectory===!0||w.type==="d"||w.type===1)await u(E,O);else{const R=Number(w.size||0);a+=R,t.push({srcPath:E,rel:O,size:R})}}}for(const f of o){const i=x.get(f),p=b(c,f);if(i&&(i.isDirectory===!0||i.type==="d"||i.type===1))await u(p,f);else{const w=Number((i==null?void 0:i.size)||0);a+=w,t.push({srcPath:p,rel:f,size:w})}}return{files:t,totalBytes:a}}const l=async(e,n)=>{var t;if(!e.conn||!n.conn)return;const o=Array.from(e.sel);if(o.length){k(!0);try{j({totalFiles:0,doneFiles:0,totalBytes:0,doneBytes:0,running:!0,phase:"Scanning…"});const{files:a,totalBytes:c}=await v(e,n,o);j({totalFiles:a.length,doneFiles:0,totalBytes:c,doneBytes:0,running:!0,phase:"Copying…"});for(let x=0;x<a.length;x++){const u=a[x],f=b(n.cwd,u.rel);await r(n,z(u.rel));const i=await D(e.conn.id,"download",{path:u.srcPath});if(!(i!=null&&i.success))throw new Error((i==null?void 0:i.error)||"download failed");await D(n.conn.id,"upload",{path:f,base64:(t=i.data)==null?void 0:t.base64}),j(p=>({...p,doneFiles:x+1,doneBytes:Math.min(p.totalBytes,p.doneBytes+(u.size||0))}))}await n.list(n.cwd),j(x=>({...x,running:!1,phase:"Done"}))}catch(a){j(c=>({...c,running:!1,phase:"Error"})),alert(a.message||"copy failed")}finally{k(!1)}}},P=({pane:e})=>{var n;return s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(T,{value:((n=e.conn)==null?void 0:n.id)||"",onChange:o=>{const t=o.target.value,a=m.find(c=>c.id===t)||null;e.setConn(a),(a==null?void 0:a.status)==="connected"&&e.list(".")},children:[s.jsx("option",{value:"",children:"Pick connection…"}),m.map(o=>s.jsxs("option",{value:o.id,children:[o.type.toUpperCase()," • ",o.name]},o.id))]}),s.jsx(N,{variant:"secondary",onClick:()=>$(e),disabled:!e.conn||e.conn.status==="connected",children:"Connect"}),s.jsx(N,{variant:"secondary",onClick:async()=>{e.conn&&(await J(e.conn.id),e.setConn({...e.conn,status:"disconnected"}))},disabled:!e.conn||e.conn.status!=="connected",children:"Disconnect"})]})},M=({pane:e,side:n,onDropFromOther:o})=>s.jsxs("div",{className:"flex-1 flex flex-col border rounded",children:[s.jsxs("div",{className:"flex items-center gap-2 p-2 border-b",children:[s.jsx(N,{variant:"secondary",onClick:e.goUp,children:"Up"}),s.jsx(N,{variant:"secondary",onClick:()=>e.list(e.cwd),children:"Refresh"}),s.jsx(L,{className:"flex-1",value:e.cwd,onChange:t=>e.setCwd(t.target.value)}),s.jsx(N,{onClick:()=>e.list(e.cwd),disabled:!e.conn||e.conn.status!=="connected",children:"Go"})]}),s.jsx("div",{className:"flex-1 overflow-auto",onDragOver:t=>t.preventDefault(),onDrop:t=>{try{const a=t.dataTransfer.getData("application/x-unicon");if(!a)return;const c=JSON.parse(a);c.from&&c.from!==n&&Array.isArray(c.names)&&c.names.length&&o(c.names,c.from)}catch{}},children:s.jsxs("table",{className:"w-full text-sm",children:[s.jsx("thead",{className:"bg-gray-50",children:s.jsxs("tr",{children:[s.jsx("th",{className:"px-2 py-1 w-6"}),s.jsx("th",{className:"text-left px-2 py-1",children:"Name"}),s.jsx("th",{className:"text-left px-2 py-1",children:"Type"}),s.jsx("th",{className:"text-left px-2 py-1",children:"Size"})]})}),s.jsxs("tbody",{children:[e.items.map((t,a)=>{const c=t.isDirectory===!0||t.type==="d"||t.type===1,x=e.sel.has(t.name);return s.jsxs("tr",{className:`border-b ${x?"bg-blue-50":""}`,draggable:!0,onDragStart:u=>{const f=e.sel.has(t.name)?Array.from(e.sel):[t.name];u.dataTransfer.setData("application/x-unicon",JSON.stringify({from:n,names:f}))},children:[s.jsx("td",{className:"px-2 py-1",children:!c&&s.jsx("input",{type:"checkbox",checked:x,onChange:()=>{const u=new Set(e.sel);u.has(t.name)?u.delete(t.name):u.add(t.name),e.setSel(u)}})}),s.jsx("td",{className:"px-2 py-1",children:s.jsx("button",{className:"hover:underline",onClick:()=>e.open(t),children:t.name})}),s.jsx("td",{className:"px-2 py-1",children:c?"dir":"file"}),s.jsx("td",{className:"px-2 py-1",children:t.size??""})]},a)}),!e.items.length&&s.jsx("tr",{children:s.jsx("td",{className:"px-3 py-6 text-center text-gray-500",colSpan:4,children:e.loading?"Loading…":"Empty"})})]})]})})]});return s.jsxs("div",{className:"h-full flex flex-col gap-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("div",{className:"flex items-center gap-2",children:s.jsx("b",{children:"File Commander"})}),s.jsx(N,{variant:"secondary",onClick:F,children:"Reload connections"})]}),s.jsxs("div",{className:"flex items-center gap-6",children:[s.jsx(P,{pane:h}),s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(N,{onClick:()=>l(g,h),disabled:B||!g.sel.size,children:"← Copy"}),s.jsx(N,{onClick:()=>l(h,g),disabled:B||!h.sel.size,children:"Copy →"}),d.running&&s.jsxs("div",{className:"min-w-[240px] text-xs text-gray-700",children:[s.jsx("div",{className:"w-full h-2 bg-gray-200 rounded overflow-hidden mb-1",children:s.jsx("div",{className:"h-2 bg-blue-600",style:{width:`${d.totalBytes>0?Math.floor(100*(d.doneBytes/d.totalBytes)):Math.floor(100*(d.doneFiles/Math.max(1,d.totalFiles)))}%`}})}),s.jsxs("div",{children:[d.phase," ",d.doneFiles,"/",d.totalFiles," files · ",Math.round(d.doneBytes/1024)," / ",Math.round(d.totalBytes/1024)," KB"]})]})]}),s.jsx(P,{pane:g})]}),s.jsxs("div",{className:"flex gap-3 min-h-[400px]",children:[s.jsx(M,{side:"left",pane:h,onDropFromOther:e=>l(g,h)}),s.jsx(M,{side:"right",pane:g,onDropFromOther:e=>l(h,g)})]})]})}export{H as default};
//# sourceMappingURL=Commander-CGl7HdlU.js.map
