{"version":3,"names":["OPCUAServer","Variant","DataType","StatusCodes","require","net","request","fs","os","path","jest","setTimeout","getFreePort","Promise","resolve","reject","srv","createServer","listen","port","address","close","on","tmpDir","mkdtempSync","join","tmpdir","process","env","CONNECTION_DATA_DIR","PERSISTENCE","PORT","WS_PORT","startServers","uaServer","started","api","endpoint","beforeAll","hostname","alternateHostname","initialize","addressSpace","engine","namespace","getOwnNamespace","counter","arr","obj","addObject","organizedBy","rootFolder","objects","browseName","addVariable","componentOf","nodeId","dataType","accessLevel","userAccessLevel","minimumSamplingInterval","value","get","Int32","set","v","Good","valueRank","arrayDimensions","Array","isArray","BadTypeMismatch","length","start","afterAll","server","wsServer","shutdown","test","create","post","send","name","type","config","endpointUrl","expect","body","success","toBe","id","connection","con","connectionId","w","operation","params","r","nodes","dv","data","list","conn","connections","find","c","w1","w2","w3"],"sources":["opcua.coercion.test.js"],"sourcesContent":["const { OPCUAServer, Variant, DataType, StatusCodes } = require('node-opcua');\r\nconst net = require('net');\r\nconst request = require('supertest');\r\nconst fs = require('fs');\r\nconst os = require('os');\r\nconst path = require('path');\r\n\r\njest.setTimeout(45000);\r\n\r\nfunction getFreePort() {\r\n  return new Promise((resolve, reject) => {\r\n    const srv = net.createServer();\r\n    srv.listen(0, '127.0.0.1', () => {\r\n      const { port } = srv.address();\r\n      srv.close(() => resolve(port));\r\n    });\r\n    srv.on('error', reject);\r\n  });\r\n}\r\n\r\nconst tmpDir = fs.mkdtempSync(path.join(os.tmpdir(), 'unicon-opcua-coerce-'));\r\nprocess.env.CONNECTION_DATA_DIR = tmpDir;\r\nprocess.env.PERSISTENCE = 'file';\r\nprocess.env.PORT = '3105';\r\nprocess.env.WS_PORT = '8185';\r\n\r\nconst { startServers } = require('../universal-server');\r\n\r\nlet uaServer; let started; let api; let endpoint;\r\n\r\nbeforeAll(async () => {\r\n  const port = await getFreePort();\r\n  uaServer = new OPCUAServer({ port, hostname: '127.0.0.1', alternateHostname: ['127.0.0.1','localhost'] });\r\n  await uaServer.initialize();\r\n  const addressSpace = uaServer.engine.addressSpace;\r\n  const namespace = addressSpace.getOwnNamespace();\r\n  let counter = 0;\r\n  let arr = [1,2,3];\r\n  const obj = namespace.addObject({ organizedBy: addressSpace.rootFolder.objects, browseName: 'Dev' });\r\n  namespace.addVariable({\r\n    componentOf: obj,\r\n    browseName: 'Counter',\r\n    nodeId: 'ns=1;s=Counter',\r\n    dataType: 'Int32',\r\n    accessLevel: 'CurrentRead | CurrentWrite',\r\n    userAccessLevel: 'CurrentRead | CurrentWrite',\r\n    minimumSamplingInterval: 100,\r\n    value: {\r\n      get: () => new Variant({ dataType: DataType.Int32, value: counter }),\r\n      set: (v) => { counter = v.value; return StatusCodes.Good; }\r\n    }\r\n  });\r\n\r\n  namespace.addVariable({\r\n    componentOf: obj,\r\n    browseName: 'Array3',\r\n    nodeId: 'ns=1;s=Array3',\r\n    dataType: 'Int32',\r\n    valueRank: 1,\r\n    arrayDimensions: [3],\r\n    accessLevel: 'CurrentRead | CurrentWrite',\r\n    userAccessLevel: 'CurrentRead | CurrentWrite',\r\n    minimumSamplingInterval: 100,\r\n    value: {\r\n      get: () => new Variant({ dataType: DataType.Int32, value: arr }),\r\n      set: (v) => { if (!Array.isArray(v.value)) return StatusCodes.BadTypeMismatch; if (v.value.length!==3) return StatusCodes.BadTypeMismatch; arr = v.value; return StatusCodes.Good; }\r\n    }\r\n  });\r\n  await uaServer.start();\r\n  endpoint = `opc.tcp://127.0.0.1:${port}`;\r\n\r\n  started = await startServers();\r\n  api = request(`http://localhost:${process.env.PORT}`);\r\n});\r\n\r\nafterAll(async () => {\r\n  if (started?.server) started.server.close();\r\n  if (started?.wsServer) started.wsServer.close();\r\n  if (uaServer) await uaServer.shutdown(500);\r\n});\r\n\r\ntest('String numeric writes to Int32 get coerced', async () => {\r\n  const create = await api.post('/unicon/api/connections').send({ name: 'opcua', type: 'opcua', config: { endpointUrl: endpoint } });\r\n  expect(create.body.success).toBe(true);\r\n  const id = create.body.connection.id;\r\n  const con = await api.post('/unicon/api/connect').send({ connectionId: id });\r\n  expect(con.body && con.body.success).toBe(true);\r\n\r\n  const w = await api.post('/unicon/api/operation').send({ connectionId: id, operation: 'write', params: { nodeId: 'ns=1;s=Counter', value: '123' } });\r\n  expect(w.body.success).toBe(true);\r\n\r\n  const r = await api.post('/unicon/api/operation').send({ connectionId: id, operation: 'read', params: { nodes: ['ns=1;s=Counter'] } });\r\n  expect(r.body.success).toBe(true);\r\n  const dv = r.body.data[0];\r\n  expect(dv.value.value).toBe(123);\r\n});\r\n\r\ntest('Non-numeric string to Int32 fails', async () => {\r\n  const list = await api.get('/unicon/api/connections');\r\n  const conn = list.body.connections.find(c => c.type === 'opcua');\r\n  const w = await api.post('/unicon/api/operation').send({ connectionId: conn.id, operation: 'write', params: { nodeId: 'ns=1;s=Counter', value: 'abc' } });\r\n  expect(w.body.success).toBe(false);\r\n});\r\n\r\ntest('Array rank/shape: accept [1,2,3], reject scalar and wrong length', async () => {\r\n  const list = await api.get('/unicon/api/connections');\r\n  const conn = list.body.connections.find(c => c.type === 'opcua');\r\n\r\n  // Good write\r\n  const w1 = await api.post('/unicon/api/operation').send({ connectionId: conn.id, operation: 'write', params: { nodeId: 'ns=1;s=Array3', value: [4,5,6] } });\r\n  expect(w1.body.success).toBe(true);\r\n\r\n  // Reject scalar\r\n  const w2 = await api.post('/unicon/api/operation').send({ connectionId: conn.id, operation: 'write', params: { nodeId: 'ns=1;s=Array3', value: 7 } });\r\n  expect(w2.body.success).toBe(false);\r\n\r\n  // Reject wrong length\r\n  const w3 = await api.post('/unicon/api/operation').send({ connectionId: conn.id, operation: 'write', params: { nodeId: 'ns=1;s=Array3', value: [1,2] } });\r\n  expect(w3.body.success).toBe(false);\r\n});\r\n"],"mappings":"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","ignoreList":[]}