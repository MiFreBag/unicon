{"version":3,"names":["_getJestObj","mock","KubeConfig","loadFromString","loadFromFile","loadFromDefault","setCurrentContext","ctx","_ctx","getCurrentContext","getContexts","name","makeApiClient","cls","CoreV1Api","listNamespace","body","items","metadata","listNamespacedPod","ns","namespace","status","phase","spec","containers","Log","constructor","kc","log","pod","container","stream","_tty","follow","tailLines","process","nextTick","emit","Buffer","from","abort","Exec","exec","command","stdout","stderr","stdin","tty","jest","require","global","broadcast","fn","K8sHandler","describe","test","h","context","connRes","connect","expect","success","toBe","nsRes","listNamespaces","data","namespaces","toContain","podsRes","listPods","pods","logsStart","Promise","r","setTimeout","toHaveBeenCalled","logsStop","id","execOpen","execInput","execClose","disc","disconnect"],"sources":["k8s_handler.test.js"],"sourcesContent":["jest.mock('@kubernetes/client-node', () => {\r\n  class KubeConfig {\r\n    loadFromString() {}\r\n    loadFromFile() {}\r\n    loadFromDefault() {}\r\n    setCurrentContext(ctx) { this._ctx = ctx; }\r\n    getCurrentContext() { return this._ctx || 'mock-ctx'; }\r\n    getContexts() { return [{ name: 'mock-ctx' }, { name: 'other-ctx' }]; }\r\n    makeApiClient(cls) { return new CoreV1Api(); }\r\n  }\r\n  class CoreV1Api {\r\n    async listNamespace() { return { body: { items: [{ metadata: { name: 'default' } }, { metadata: { name: 'kube-system' } }] } }; }\r\n    async listNamespacedPod(ns) {\r\n      return { body: { items: [{ metadata: { name: 'p1', namespace: ns }, status: { phase: 'Running' }, spec: { containers: [{ name: 'c1' }] } }] } };\r\n    }\r\n  }\r\n  class Log {\r\n    constructor(kc) {}\r\n    async log(ns, pod, container, stream, _tty, follow, tailLines) {\r\n      process.nextTick(() => { stream.emit('data', Buffer.from('log-line\\n')); });\r\n      return { abort: () => {} };\r\n    }\r\n  }\r\n  class Exec {\r\n    constructor(kc) {}\r\n    async exec(ns, pod, container, command, stdout, stderr, stdin, tty) {\r\n      process.nextTick(() => { stdout.emit('data', Buffer.from('exec-out')); });\r\n    }\r\n  }\r\n  return { KubeConfig, CoreV1Api, Log, Exec };\r\n});\r\n\r\nglobal.broadcast = jest.fn();\r\n\r\nconst K8sHandler = require('../handlers/k8s_handler');\r\n\r\ndescribe('K8sHandler', () => {\r\n  test('connect, list namespaces, list pods, logs and exec', async () => {\r\n    const h = new K8sHandler('k-1', { context: 'mock-ctx', namespace: 'default' });\r\n    const connRes = await h.connect();\r\n    expect(connRes.success).toBe(true);\r\n\r\n    const nsRes = await h.listNamespaces();\r\n    expect(nsRes.success).toBe(true);\r\n    expect(nsRes.data.namespaces).toContain('default');\r\n\r\n    const podsRes = await h.listPods('default');\r\n    expect(podsRes.success).toBe(true);\r\n    expect(podsRes.data.pods[0].name).toBe('p1');\r\n\r\n    const logsStart = await h.logsStart({ namespace: 'default', pod: 'p1' });\r\n    expect(logsStart.success).toBe(true);\r\n    // broadcast called with a log line\r\n    await new Promise((r) => setTimeout(r, 10));\r\n    expect(global.broadcast).toHaveBeenCalled();\r\n\r\n    await h.logsStop({ id: logsStart.data.id });\r\n\r\n    const execOpen = await h.execOpen({ namespace: 'default', pod: 'p1', command: ['/bin/sh'], tty: true });\r\n    expect(execOpen.success).toBe(true);\r\n    await h.execInput({ id: execOpen.data.id, data: 'echo x\\n' });\r\n    await h.execClose({ id: execOpen.data.id });\r\n\r\n    const disc = await h.disconnect();\r\n    expect(disc.success).toBe(true);\r\n  });\r\n});\r\n"],"mappings":"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","ignoreList":[]}