f42e32c96fec96d676436e9c0e661c26
// server/handlers/k8s_handler.js
const k8s = require('@kubernetes/client-node');
class K8sHandler {
  constructor(connectionId, config) {
    this.connectionId = connectionId;
    this.config = config || {};
    this.kc = null;
    this.core = null;
    this.currentContext = null;
    this.logStreams = new Map(); // id -> { cancel }
    this.execSessions = new Map(); // id -> { stdin, stdout, stderr }
  }
  async connect() {
    this.kc = new k8s.KubeConfig();
    const {
      kubeconfig,
      kubeconfigPath,
      context
    } = this.config;
    try {
      if (kubeconfig && typeof kubeconfig === 'string' && kubeconfig.trim()) {
        this.kc.loadFromString(kubeconfig);
      } else if (kubeconfigPath && typeof kubeconfigPath === 'string' && kubeconfigPath.trim()) {
        this.kc.loadFromFile(kubeconfigPath);
      } else {
        this.kc.loadFromDefault();
      }
      if (context) this.kc.setCurrentContext(context);
      this.core = this.kc.makeApiClient(k8s.CoreV1Api);
      this.currentContext = this.kc.getCurrentContext();
      return {
        success: true,
        data: {
          context: this.currentContext
        }
      };
    } catch (e) {
      throw new Error(`K8s config load failed: ${e.message}`);
    }
  }
  async disconnect() {
    // Stop any running streams
    for (const {
      cancel
    } of this.logStreams.values()) {
      try {
        cancel && cancel();
      } catch (_) {}
    }
    this.logStreams.clear();
    for (const {
      stdin
    } of this.execSessions.values()) {
      try {
        stdin && stdin.end();
      } catch (_) {}
    }
    this.execSessions.clear();
    return {
      success: true
    };
  }
  listContexts() {
    const contexts = this.kc.getContexts() || [];
    const current = this.kc.getCurrentContext();
    return {
      success: true,
      data: {
        contexts,
        current
      }
    };
  }
  useContext(name) {
    this.kc.setCurrentContext(name);
    this.currentContext = name;
    this.core = this.kc.makeApiClient(k8s.CoreV1Api);
    return {
      success: true,
      data: {
        current: name
      }
    };
  }
  async listNamespaces() {
    const res = await this.core.listNamespace();
    const items = (res.body.items || []).map(ns => ns.metadata?.name);
    return {
      success: true,
      data: {
        namespaces: items
      }
    };
  }
  async listPods(namespace = this.config.namespace || 'default') {
    const res = await this.core.listNamespacedPod(namespace);
    const pods = (res.body.items || []).map(p => ({
      name: p.metadata?.name,
      namespace: p.metadata?.namespace,
      phase: p.status?.phase,
      containers: (p.spec?.containers || []).map(c => c.name)
    }));
    return {
      success: true,
      data: {
        pods
      }
    };
  }
  async logsStart({
    namespace = this.config.namespace || 'default',
    pod,
    container,
    tailLines = 200
  }) {
    if (!pod) throw new Error('pod required');
    const log = new k8s.Log(this.kc);
    const stream = new (require('stream').PassThrough)();
    const id = `${pod}-${Date.now()}`;
    stream.on('data', chunk => {
      const line = chunk.toString();
      this._broadcast({
        type: 'k8s',
        data: {
          event: 'logLine',
          connectionId: this.connectionId,
          id,
          pod,
          container,
          line
        }
      });
    });
    const cancel = await log.log(namespace, pod, container || undefined, stream, undefined, true, tailLines, false).catch(e => {
      throw new Error(`logs failed: ${e.message}`);
    });
    // @kubernetes/client-node returns a request; set cancel function
    const abort = () => {
      try {
        cancel && cancel.abort && cancel.abort();
      } catch (_) {}
      try {
        stream.end();
      } catch (_) {}
    };
    this.logStreams.set(id, {
      cancel: abort
    });
    return {
      success: true,
      data: {
        id
      }
    };
  }
  async logsStop({
    id
  }) {
    const s = this.logStreams.get(id);
    if (s && s.cancel) s.cancel();
    this.logStreams.delete(id);
    return {
      success: true
    };
  }
  async execOpen({
    namespace = this.config.namespace || 'default',
    pod,
    container,
    command = ['/bin/sh'],
    tty = true
  }) {
    if (!pod) throw new Error('pod required');
    const exec = new k8s.Exec(this.kc);
    const {
      PassThrough
    } = require('stream');
    const stdout = new PassThrough();
    const stderr = new PassThrough();
    const stdin = new PassThrough();
    const id = `${pod}-exec-${Date.now()}`;
    const onData = (buf, streamName) => {
      this._broadcast({
        type: 'k8s',
        data: {
          event: 'execOut',
          connectionId: this.connectionId,
          id,
          pod,
          container,
          stream: streamName,
          data: buf.toString('utf8')
        }
      });
    };
    stdout.on('data', b => onData(b, 'stdout'));
    stderr.on('data', b => onData(b, 'stderr'));
    await exec.exec(namespace, pod, container || undefined, command, stdout, stderr, stdin, tty);
    this.execSessions.set(id, {
      stdin,
      stdout,
      stderr
    });
    return {
      success: true,
      data: {
        id
      }
    };
  }
  async execInput({
    id,
    data
  }) {
    const s = this.execSessions.get(id);
    if (!s) throw new Error('exec session not found');
    s.stdin.write(data);
    return {
      success: true
    };
  }
  async execClose({
    id
  }) {
    const s = this.execSessions.get(id);
    if (!s) return {
      success: true
    };
    try {
      s.stdin.end();
    } catch (_) {}
    this.execSessions.delete(id);
    return {
      success: true
    };
  }
  _broadcast(message) {
    if (global.broadcast) global.broadcast(message);
  }
}
module.exports = K8sHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJrOHMiLCJyZXF1aXJlIiwiSzhzSGFuZGxlciIsImNvbnN0cnVjdG9yIiwiY29ubmVjdGlvbklkIiwiY29uZmlnIiwia2MiLCJjb3JlIiwiY3VycmVudENvbnRleHQiLCJsb2dTdHJlYW1zIiwiTWFwIiwiZXhlY1Nlc3Npb25zIiwiY29ubmVjdCIsIkt1YmVDb25maWciLCJrdWJlY29uZmlnIiwia3ViZWNvbmZpZ1BhdGgiLCJjb250ZXh0IiwidHJpbSIsImxvYWRGcm9tU3RyaW5nIiwibG9hZEZyb21GaWxlIiwibG9hZEZyb21EZWZhdWx0Iiwic2V0Q3VycmVudENvbnRleHQiLCJtYWtlQXBpQ2xpZW50IiwiQ29yZVYxQXBpIiwiZ2V0Q3VycmVudENvbnRleHQiLCJzdWNjZXNzIiwiZGF0YSIsImUiLCJFcnJvciIsIm1lc3NhZ2UiLCJkaXNjb25uZWN0IiwiY2FuY2VsIiwidmFsdWVzIiwiXyIsImNsZWFyIiwic3RkaW4iLCJlbmQiLCJsaXN0Q29udGV4dHMiLCJjb250ZXh0cyIsImdldENvbnRleHRzIiwiY3VycmVudCIsInVzZUNvbnRleHQiLCJuYW1lIiwibGlzdE5hbWVzcGFjZXMiLCJyZXMiLCJsaXN0TmFtZXNwYWNlIiwiaXRlbXMiLCJib2R5IiwibWFwIiwibnMiLCJtZXRhZGF0YSIsIm5hbWVzcGFjZXMiLCJsaXN0UG9kcyIsIm5hbWVzcGFjZSIsImxpc3ROYW1lc3BhY2VkUG9kIiwicG9kcyIsInAiLCJwaGFzZSIsInN0YXR1cyIsImNvbnRhaW5lcnMiLCJzcGVjIiwiYyIsImxvZ3NTdGFydCIsInBvZCIsImNvbnRhaW5lciIsInRhaWxMaW5lcyIsImxvZyIsIkxvZyIsInN0cmVhbSIsIlBhc3NUaHJvdWdoIiwiaWQiLCJEYXRlIiwibm93Iiwib24iLCJjaHVuayIsImxpbmUiLCJ0b1N0cmluZyIsIl9icm9hZGNhc3QiLCJ0eXBlIiwiZXZlbnQiLCJ1bmRlZmluZWQiLCJjYXRjaCIsImFib3J0Iiwic2V0IiwibG9nc1N0b3AiLCJzIiwiZ2V0IiwiZGVsZXRlIiwiZXhlY09wZW4iLCJjb21tYW5kIiwidHR5IiwiZXhlYyIsIkV4ZWMiLCJzdGRvdXQiLCJzdGRlcnIiLCJvbkRhdGEiLCJidWYiLCJzdHJlYW1OYW1lIiwiYiIsImV4ZWNJbnB1dCIsIndyaXRlIiwiZXhlY0Nsb3NlIiwiZ2xvYmFsIiwiYnJvYWRjYXN0IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbIms4c19oYW5kbGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHNlcnZlci9oYW5kbGVycy9rOHNfaGFuZGxlci5qc1xyXG5jb25zdCBrOHMgPSByZXF1aXJlKCdAa3ViZXJuZXRlcy9jbGllbnQtbm9kZScpO1xyXG5cclxuY2xhc3MgSzhzSGFuZGxlciB7XHJcbiAgY29uc3RydWN0b3IoY29ubmVjdGlvbklkLCBjb25maWcpIHtcclxuICAgIHRoaXMuY29ubmVjdGlvbklkID0gY29ubmVjdGlvbklkO1xyXG4gICAgdGhpcy5jb25maWcgPSBjb25maWcgfHwge307XHJcbiAgICB0aGlzLmtjID0gbnVsbDtcclxuICAgIHRoaXMuY29yZSA9IG51bGw7XHJcbiAgICB0aGlzLmN1cnJlbnRDb250ZXh0ID0gbnVsbDtcclxuICAgIHRoaXMubG9nU3RyZWFtcyA9IG5ldyBNYXAoKTsgLy8gaWQgLT4geyBjYW5jZWwgfVxyXG4gICAgdGhpcy5leGVjU2Vzc2lvbnMgPSBuZXcgTWFwKCk7IC8vIGlkIC0+IHsgc3RkaW4sIHN0ZG91dCwgc3RkZXJyIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIGNvbm5lY3QoKSB7XHJcbiAgICB0aGlzLmtjID0gbmV3IGs4cy5LdWJlQ29uZmlnKCk7XHJcbiAgICBjb25zdCB7IGt1YmVjb25maWcsIGt1YmVjb25maWdQYXRoLCBjb250ZXh0IH0gPSB0aGlzLmNvbmZpZztcclxuICAgIHRyeSB7XHJcbiAgICAgIGlmIChrdWJlY29uZmlnICYmIHR5cGVvZiBrdWJlY29uZmlnID09PSAnc3RyaW5nJyAmJiBrdWJlY29uZmlnLnRyaW0oKSkge1xyXG4gICAgICAgIHRoaXMua2MubG9hZEZyb21TdHJpbmcoa3ViZWNvbmZpZyk7XHJcbiAgICAgIH0gZWxzZSBpZiAoa3ViZWNvbmZpZ1BhdGggJiYgdHlwZW9mIGt1YmVjb25maWdQYXRoID09PSAnc3RyaW5nJyAmJiBrdWJlY29uZmlnUGF0aC50cmltKCkpIHtcclxuICAgICAgICB0aGlzLmtjLmxvYWRGcm9tRmlsZShrdWJlY29uZmlnUGF0aCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy5rYy5sb2FkRnJvbURlZmF1bHQoKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoY29udGV4dCkgdGhpcy5rYy5zZXRDdXJyZW50Q29udGV4dChjb250ZXh0KTtcclxuICAgICAgdGhpcy5jb3JlID0gdGhpcy5rYy5tYWtlQXBpQ2xpZW50KGs4cy5Db3JlVjFBcGkpO1xyXG4gICAgICB0aGlzLmN1cnJlbnRDb250ZXh0ID0gdGhpcy5rYy5nZXRDdXJyZW50Q29udGV4dCgpO1xyXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCBkYXRhOiB7IGNvbnRleHQ6IHRoaXMuY3VycmVudENvbnRleHQgfSB9O1xyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEs4cyBjb25maWcgbG9hZCBmYWlsZWQ6ICR7ZS5tZXNzYWdlfWApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgZGlzY29ubmVjdCgpIHtcclxuICAgIC8vIFN0b3AgYW55IHJ1bm5pbmcgc3RyZWFtc1xyXG4gICAgZm9yIChjb25zdCB7IGNhbmNlbCB9IG9mIHRoaXMubG9nU3RyZWFtcy52YWx1ZXMoKSkge1xyXG4gICAgICB0cnkgeyBjYW5jZWwgJiYgY2FuY2VsKCk7IH0gY2F0Y2ggKF8pIHt9XHJcbiAgICB9XHJcbiAgICB0aGlzLmxvZ1N0cmVhbXMuY2xlYXIoKTtcclxuICAgIGZvciAoY29uc3QgeyBzdGRpbiB9IG9mIHRoaXMuZXhlY1Nlc3Npb25zLnZhbHVlcygpKSB7XHJcbiAgICAgIHRyeSB7IHN0ZGluICYmIHN0ZGluLmVuZCgpOyB9IGNhdGNoIChfKSB7fVxyXG4gICAgfVxyXG4gICAgdGhpcy5leGVjU2Vzc2lvbnMuY2xlYXIoKTtcclxuICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcclxuICB9XHJcblxyXG4gIGxpc3RDb250ZXh0cygpIHtcclxuICAgIGNvbnN0IGNvbnRleHRzID0gdGhpcy5rYy5nZXRDb250ZXh0cygpIHx8IFtdO1xyXG4gICAgY29uc3QgY3VycmVudCA9IHRoaXMua2MuZ2V0Q3VycmVudENvbnRleHQoKTtcclxuICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIGRhdGE6IHsgY29udGV4dHMsIGN1cnJlbnQgfSB9O1xyXG4gIH1cclxuXHJcbiAgdXNlQ29udGV4dChuYW1lKSB7XHJcbiAgICB0aGlzLmtjLnNldEN1cnJlbnRDb250ZXh0KG5hbWUpO1xyXG4gICAgdGhpcy5jdXJyZW50Q29udGV4dCA9IG5hbWU7XHJcbiAgICB0aGlzLmNvcmUgPSB0aGlzLmtjLm1ha2VBcGlDbGllbnQoazhzLkNvcmVWMUFwaSk7XHJcbiAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCBkYXRhOiB7IGN1cnJlbnQ6IG5hbWUgfSB9O1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgbGlzdE5hbWVzcGFjZXMoKSB7XHJcbiAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmNvcmUubGlzdE5hbWVzcGFjZSgpO1xyXG4gICAgY29uc3QgaXRlbXMgPSAocmVzLmJvZHkuaXRlbXMgfHwgW10pLm1hcChucyA9PiBucy5tZXRhZGF0YT8ubmFtZSk7XHJcbiAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCBkYXRhOiB7IG5hbWVzcGFjZXM6IGl0ZW1zIH0gfTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGxpc3RQb2RzKG5hbWVzcGFjZSA9IHRoaXMuY29uZmlnLm5hbWVzcGFjZSB8fCAnZGVmYXVsdCcpIHtcclxuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuY29yZS5saXN0TmFtZXNwYWNlZFBvZChuYW1lc3BhY2UpO1xyXG4gICAgY29uc3QgcG9kcyA9IChyZXMuYm9keS5pdGVtcyB8fCBbXSkubWFwKHAgPT4gKHtcclxuICAgICAgbmFtZTogcC5tZXRhZGF0YT8ubmFtZSxcclxuICAgICAgbmFtZXNwYWNlOiBwLm1ldGFkYXRhPy5uYW1lc3BhY2UsXHJcbiAgICAgIHBoYXNlOiBwLnN0YXR1cz8ucGhhc2UsXHJcbiAgICAgIGNvbnRhaW5lcnM6IChwLnNwZWM/LmNvbnRhaW5lcnMgfHwgW10pLm1hcChjID0+IGMubmFtZSksXHJcbiAgICB9KSk7XHJcbiAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCBkYXRhOiB7IHBvZHMgfSB9O1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgbG9nc1N0YXJ0KHsgbmFtZXNwYWNlID0gdGhpcy5jb25maWcubmFtZXNwYWNlIHx8ICdkZWZhdWx0JywgcG9kLCBjb250YWluZXIsIHRhaWxMaW5lcyA9IDIwMCB9KSB7XHJcbiAgICBpZiAoIXBvZCkgdGhyb3cgbmV3IEVycm9yKCdwb2QgcmVxdWlyZWQnKTtcclxuICAgIGNvbnN0IGxvZyA9IG5ldyBrOHMuTG9nKHRoaXMua2MpO1xyXG4gICAgY29uc3Qgc3RyZWFtID0gbmV3IChyZXF1aXJlKCdzdHJlYW0nKS5QYXNzVGhyb3VnaCkoKTtcclxuICAgIGNvbnN0IGlkID0gYCR7cG9kfS0ke0RhdGUubm93KCl9YDtcclxuICAgIHN0cmVhbS5vbignZGF0YScsIChjaHVuaykgPT4ge1xyXG4gICAgICBjb25zdCBsaW5lID0gY2h1bmsudG9TdHJpbmcoKTtcclxuICAgICAgdGhpcy5fYnJvYWRjYXN0KHsgdHlwZTogJ2s4cycsIGRhdGE6IHsgZXZlbnQ6ICdsb2dMaW5lJywgY29ubmVjdGlvbklkOiB0aGlzLmNvbm5lY3Rpb25JZCwgaWQsIHBvZCwgY29udGFpbmVyLCBsaW5lIH0gfSk7XHJcbiAgICB9KTtcclxuICAgIGNvbnN0IGNhbmNlbCA9IGF3YWl0IGxvZy5sb2cobmFtZXNwYWNlLCBwb2QsIGNvbnRhaW5lciB8fCB1bmRlZmluZWQsIHN0cmVhbSwgdW5kZWZpbmVkLCB0cnVlLCB0YWlsTGluZXMsIGZhbHNlKS5jYXRjaCgoZSkgPT4geyB0aHJvdyBuZXcgRXJyb3IoYGxvZ3MgZmFpbGVkOiAke2UubWVzc2FnZX1gKTsgfSk7XHJcbiAgICAvLyBAa3ViZXJuZXRlcy9jbGllbnQtbm9kZSByZXR1cm5zIGEgcmVxdWVzdDsgc2V0IGNhbmNlbCBmdW5jdGlvblxyXG4gICAgY29uc3QgYWJvcnQgPSAoKSA9PiB7XHJcbiAgICAgIHRyeSB7IGNhbmNlbCAmJiBjYW5jZWwuYWJvcnQgJiYgY2FuY2VsLmFib3J0KCk7IH0gY2F0Y2ggKF8pIHt9XHJcbiAgICAgIHRyeSB7IHN0cmVhbS5lbmQoKTsgfSBjYXRjaCAoXykge31cclxuICAgIH07XHJcbiAgICB0aGlzLmxvZ1N0cmVhbXMuc2V0KGlkLCB7IGNhbmNlbDogYWJvcnQgfSk7XHJcbiAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCBkYXRhOiB7IGlkIH0gfTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGxvZ3NTdG9wKHsgaWQgfSkge1xyXG4gICAgY29uc3QgcyA9IHRoaXMubG9nU3RyZWFtcy5nZXQoaWQpO1xyXG4gICAgaWYgKHMgJiYgcy5jYW5jZWwpIHMuY2FuY2VsKCk7XHJcbiAgICB0aGlzLmxvZ1N0cmVhbXMuZGVsZXRlKGlkKTtcclxuICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGV4ZWNPcGVuKHsgbmFtZXNwYWNlID0gdGhpcy5jb25maWcubmFtZXNwYWNlIHx8ICdkZWZhdWx0JywgcG9kLCBjb250YWluZXIsIGNvbW1hbmQgPSBbJy9iaW4vc2gnXSwgdHR5ID0gdHJ1ZSB9KSB7XHJcbiAgICBpZiAoIXBvZCkgdGhyb3cgbmV3IEVycm9yKCdwb2QgcmVxdWlyZWQnKTtcclxuICAgIGNvbnN0IGV4ZWMgPSBuZXcgazhzLkV4ZWModGhpcy5rYyk7XHJcbiAgICBjb25zdCB7IFBhc3NUaHJvdWdoIH0gPSByZXF1aXJlKCdzdHJlYW0nKTtcclxuICAgIGNvbnN0IHN0ZG91dCA9IG5ldyBQYXNzVGhyb3VnaCgpO1xyXG4gICAgY29uc3Qgc3RkZXJyID0gbmV3IFBhc3NUaHJvdWdoKCk7XHJcbiAgICBjb25zdCBzdGRpbiA9IG5ldyBQYXNzVGhyb3VnaCgpO1xyXG4gICAgY29uc3QgaWQgPSBgJHtwb2R9LWV4ZWMtJHtEYXRlLm5vdygpfWA7XHJcbiAgICBjb25zdCBvbkRhdGEgPSAoYnVmLCBzdHJlYW1OYW1lKSA9PiB7XHJcbiAgICAgIHRoaXMuX2Jyb2FkY2FzdCh7IHR5cGU6ICdrOHMnLCBkYXRhOiB7IGV2ZW50OiAnZXhlY091dCcsIGNvbm5lY3Rpb25JZDogdGhpcy5jb25uZWN0aW9uSWQsIGlkLCBwb2QsIGNvbnRhaW5lciwgc3RyZWFtOiBzdHJlYW1OYW1lLCBkYXRhOiBidWYudG9TdHJpbmcoJ3V0ZjgnKSB9IH0pO1xyXG4gICAgfTtcclxuICAgIHN0ZG91dC5vbignZGF0YScsIChiKSA9PiBvbkRhdGEoYiwgJ3N0ZG91dCcpKTtcclxuICAgIHN0ZGVyci5vbignZGF0YScsIChiKSA9PiBvbkRhdGEoYiwgJ3N0ZGVycicpKTtcclxuICAgIGF3YWl0IGV4ZWMuZXhlYyhuYW1lc3BhY2UsIHBvZCwgY29udGFpbmVyIHx8IHVuZGVmaW5lZCwgY29tbWFuZCwgc3Rkb3V0LCBzdGRlcnIsIHN0ZGluLCB0dHkpO1xyXG4gICAgdGhpcy5leGVjU2Vzc2lvbnMuc2V0KGlkLCB7IHN0ZGluLCBzdGRvdXQsIHN0ZGVyciB9KTtcclxuICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIGRhdGE6IHsgaWQgfSB9O1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZXhlY0lucHV0KHsgaWQsIGRhdGEgfSkge1xyXG4gICAgY29uc3QgcyA9IHRoaXMuZXhlY1Nlc3Npb25zLmdldChpZCk7XHJcbiAgICBpZiAoIXMpIHRocm93IG5ldyBFcnJvcignZXhlYyBzZXNzaW9uIG5vdCBmb3VuZCcpO1xyXG4gICAgcy5zdGRpbi53cml0ZShkYXRhKTtcclxuICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGV4ZWNDbG9zZSh7IGlkIH0pIHtcclxuICAgIGNvbnN0IHMgPSB0aGlzLmV4ZWNTZXNzaW9ucy5nZXQoaWQpO1xyXG4gICAgaWYgKCFzKSByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07XHJcbiAgICB0cnkgeyBzLnN0ZGluLmVuZCgpOyB9IGNhdGNoIChfKSB7fVxyXG4gICAgdGhpcy5leGVjU2Vzc2lvbnMuZGVsZXRlKGlkKTtcclxuICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcclxuICB9XHJcblxyXG4gIF9icm9hZGNhc3QobWVzc2FnZSkge1xyXG4gICAgaWYgKGdsb2JhbC5icm9hZGNhc3QpIGdsb2JhbC5icm9hZGNhc3QobWVzc2FnZSk7XHJcbiAgfVxyXG59XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IEs4c0hhbmRsZXI7XHJcbiJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQSxNQUFNQSxHQUFHLEdBQUdDLE9BQU8sQ0FBQyx5QkFBeUIsQ0FBQztBQUU5QyxNQUFNQyxVQUFVLENBQUM7RUFDZkMsV0FBV0EsQ0FBQ0MsWUFBWSxFQUFFQyxNQUFNLEVBQUU7SUFDaEMsSUFBSSxDQUFDRCxZQUFZLEdBQUdBLFlBQVk7SUFDaEMsSUFBSSxDQUFDQyxNQUFNLEdBQUdBLE1BQU0sSUFBSSxDQUFDLENBQUM7SUFDMUIsSUFBSSxDQUFDQyxFQUFFLEdBQUcsSUFBSTtJQUNkLElBQUksQ0FBQ0MsSUFBSSxHQUFHLElBQUk7SUFDaEIsSUFBSSxDQUFDQyxjQUFjLEdBQUcsSUFBSTtJQUMxQixJQUFJLENBQUNDLFVBQVUsR0FBRyxJQUFJQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDN0IsSUFBSSxDQUFDQyxZQUFZLEdBQUcsSUFBSUQsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0VBQ2pDO0VBRUEsTUFBTUUsT0FBT0EsQ0FBQSxFQUFHO0lBQ2QsSUFBSSxDQUFDTixFQUFFLEdBQUcsSUFBSU4sR0FBRyxDQUFDYSxVQUFVLENBQUMsQ0FBQztJQUM5QixNQUFNO01BQUVDLFVBQVU7TUFBRUMsY0FBYztNQUFFQztJQUFRLENBQUMsR0FBRyxJQUFJLENBQUNYLE1BQU07SUFDM0QsSUFBSTtNQUNGLElBQUlTLFVBQVUsSUFBSSxPQUFPQSxVQUFVLEtBQUssUUFBUSxJQUFJQSxVQUFVLENBQUNHLElBQUksQ0FBQyxDQUFDLEVBQUU7UUFDckUsSUFBSSxDQUFDWCxFQUFFLENBQUNZLGNBQWMsQ0FBQ0osVUFBVSxDQUFDO01BQ3BDLENBQUMsTUFBTSxJQUFJQyxjQUFjLElBQUksT0FBT0EsY0FBYyxLQUFLLFFBQVEsSUFBSUEsY0FBYyxDQUFDRSxJQUFJLENBQUMsQ0FBQyxFQUFFO1FBQ3hGLElBQUksQ0FBQ1gsRUFBRSxDQUFDYSxZQUFZLENBQUNKLGNBQWMsQ0FBQztNQUN0QyxDQUFDLE1BQU07UUFDTCxJQUFJLENBQUNULEVBQUUsQ0FBQ2MsZUFBZSxDQUFDLENBQUM7TUFDM0I7TUFDQSxJQUFJSixPQUFPLEVBQUUsSUFBSSxDQUFDVixFQUFFLENBQUNlLGlCQUFpQixDQUFDTCxPQUFPLENBQUM7TUFDL0MsSUFBSSxDQUFDVCxJQUFJLEdBQUcsSUFBSSxDQUFDRCxFQUFFLENBQUNnQixhQUFhLENBQUN0QixHQUFHLENBQUN1QixTQUFTLENBQUM7TUFDaEQsSUFBSSxDQUFDZixjQUFjLEdBQUcsSUFBSSxDQUFDRixFQUFFLENBQUNrQixpQkFBaUIsQ0FBQyxDQUFDO01BQ2pELE9BQU87UUFBRUMsT0FBTyxFQUFFLElBQUk7UUFBRUMsSUFBSSxFQUFFO1VBQUVWLE9BQU8sRUFBRSxJQUFJLENBQUNSO1FBQWU7TUFBRSxDQUFDO0lBQ2xFLENBQUMsQ0FBQyxPQUFPbUIsQ0FBQyxFQUFFO01BQ1YsTUFBTSxJQUFJQyxLQUFLLENBQUMsMkJBQTJCRCxDQUFDLENBQUNFLE9BQU8sRUFBRSxDQUFDO0lBQ3pEO0VBQ0Y7RUFFQSxNQUFNQyxVQUFVQSxDQUFBLEVBQUc7SUFDakI7SUFDQSxLQUFLLE1BQU07TUFBRUM7SUFBTyxDQUFDLElBQUksSUFBSSxDQUFDdEIsVUFBVSxDQUFDdUIsTUFBTSxDQUFDLENBQUMsRUFBRTtNQUNqRCxJQUFJO1FBQUVELE1BQU0sSUFBSUEsTUFBTSxDQUFDLENBQUM7TUFBRSxDQUFDLENBQUMsT0FBT0UsQ0FBQyxFQUFFLENBQUM7SUFDekM7SUFDQSxJQUFJLENBQUN4QixVQUFVLENBQUN5QixLQUFLLENBQUMsQ0FBQztJQUN2QixLQUFLLE1BQU07TUFBRUM7SUFBTSxDQUFDLElBQUksSUFBSSxDQUFDeEIsWUFBWSxDQUFDcUIsTUFBTSxDQUFDLENBQUMsRUFBRTtNQUNsRCxJQUFJO1FBQUVHLEtBQUssSUFBSUEsS0FBSyxDQUFDQyxHQUFHLENBQUMsQ0FBQztNQUFFLENBQUMsQ0FBQyxPQUFPSCxDQUFDLEVBQUUsQ0FBQztJQUMzQztJQUNBLElBQUksQ0FBQ3RCLFlBQVksQ0FBQ3VCLEtBQUssQ0FBQyxDQUFDO0lBQ3pCLE9BQU87TUFBRVQsT0FBTyxFQUFFO0lBQUssQ0FBQztFQUMxQjtFQUVBWSxZQUFZQSxDQUFBLEVBQUc7SUFDYixNQUFNQyxRQUFRLEdBQUcsSUFBSSxDQUFDaEMsRUFBRSxDQUFDaUMsV0FBVyxDQUFDLENBQUMsSUFBSSxFQUFFO0lBQzVDLE1BQU1DLE9BQU8sR0FBRyxJQUFJLENBQUNsQyxFQUFFLENBQUNrQixpQkFBaUIsQ0FBQyxDQUFDO0lBQzNDLE9BQU87TUFBRUMsT0FBTyxFQUFFLElBQUk7TUFBRUMsSUFBSSxFQUFFO1FBQUVZLFFBQVE7UUFBRUU7TUFBUTtJQUFFLENBQUM7RUFDdkQ7RUFFQUMsVUFBVUEsQ0FBQ0MsSUFBSSxFQUFFO0lBQ2YsSUFBSSxDQUFDcEMsRUFBRSxDQUFDZSxpQkFBaUIsQ0FBQ3FCLElBQUksQ0FBQztJQUMvQixJQUFJLENBQUNsQyxjQUFjLEdBQUdrQyxJQUFJO0lBQzFCLElBQUksQ0FBQ25DLElBQUksR0FBRyxJQUFJLENBQUNELEVBQUUsQ0FBQ2dCLGFBQWEsQ0FBQ3RCLEdBQUcsQ0FBQ3VCLFNBQVMsQ0FBQztJQUNoRCxPQUFPO01BQUVFLE9BQU8sRUFBRSxJQUFJO01BQUVDLElBQUksRUFBRTtRQUFFYyxPQUFPLEVBQUVFO01BQUs7SUFBRSxDQUFDO0VBQ25EO0VBRUEsTUFBTUMsY0FBY0EsQ0FBQSxFQUFHO0lBQ3JCLE1BQU1DLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQ3JDLElBQUksQ0FBQ3NDLGFBQWEsQ0FBQyxDQUFDO0lBQzNDLE1BQU1DLEtBQUssR0FBRyxDQUFDRixHQUFHLENBQUNHLElBQUksQ0FBQ0QsS0FBSyxJQUFJLEVBQUUsRUFBRUUsR0FBRyxDQUFDQyxFQUFFLElBQUlBLEVBQUUsQ0FBQ0MsUUFBUSxFQUFFUixJQUFJLENBQUM7SUFDakUsT0FBTztNQUFFakIsT0FBTyxFQUFFLElBQUk7TUFBRUMsSUFBSSxFQUFFO1FBQUV5QixVQUFVLEVBQUVMO01BQU07SUFBRSxDQUFDO0VBQ3ZEO0VBRUEsTUFBTU0sUUFBUUEsQ0FBQ0MsU0FBUyxHQUFHLElBQUksQ0FBQ2hELE1BQU0sQ0FBQ2dELFNBQVMsSUFBSSxTQUFTLEVBQUU7SUFDN0QsTUFBTVQsR0FBRyxHQUFHLE1BQU0sSUFBSSxDQUFDckMsSUFBSSxDQUFDK0MsaUJBQWlCLENBQUNELFNBQVMsQ0FBQztJQUN4RCxNQUFNRSxJQUFJLEdBQUcsQ0FBQ1gsR0FBRyxDQUFDRyxJQUFJLENBQUNELEtBQUssSUFBSSxFQUFFLEVBQUVFLEdBQUcsQ0FBQ1EsQ0FBQyxLQUFLO01BQzVDZCxJQUFJLEVBQUVjLENBQUMsQ0FBQ04sUUFBUSxFQUFFUixJQUFJO01BQ3RCVyxTQUFTLEVBQUVHLENBQUMsQ0FBQ04sUUFBUSxFQUFFRyxTQUFTO01BQ2hDSSxLQUFLLEVBQUVELENBQUMsQ0FBQ0UsTUFBTSxFQUFFRCxLQUFLO01BQ3RCRSxVQUFVLEVBQUUsQ0FBQ0gsQ0FBQyxDQUFDSSxJQUFJLEVBQUVELFVBQVUsSUFBSSxFQUFFLEVBQUVYLEdBQUcsQ0FBQ2EsQ0FBQyxJQUFJQSxDQUFDLENBQUNuQixJQUFJO0lBQ3hELENBQUMsQ0FBQyxDQUFDO0lBQ0gsT0FBTztNQUFFakIsT0FBTyxFQUFFLElBQUk7TUFBRUMsSUFBSSxFQUFFO1FBQUU2QjtNQUFLO0lBQUUsQ0FBQztFQUMxQztFQUVBLE1BQU1PLFNBQVNBLENBQUM7SUFBRVQsU0FBUyxHQUFHLElBQUksQ0FBQ2hELE1BQU0sQ0FBQ2dELFNBQVMsSUFBSSxTQUFTO0lBQUVVLEdBQUc7SUFBRUMsU0FBUztJQUFFQyxTQUFTLEdBQUc7RUFBSSxDQUFDLEVBQUU7SUFDbkcsSUFBSSxDQUFDRixHQUFHLEVBQUUsTUFBTSxJQUFJbkMsS0FBSyxDQUFDLGNBQWMsQ0FBQztJQUN6QyxNQUFNc0MsR0FBRyxHQUFHLElBQUlsRSxHQUFHLENBQUNtRSxHQUFHLENBQUMsSUFBSSxDQUFDN0QsRUFBRSxDQUFDO0lBQ2hDLE1BQU04RCxNQUFNLEdBQUcsS0FBS25FLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQ29FLFdBQVcsRUFBRSxDQUFDO0lBQ3BELE1BQU1DLEVBQUUsR0FBRyxHQUFHUCxHQUFHLElBQUlRLElBQUksQ0FBQ0MsR0FBRyxDQUFDLENBQUMsRUFBRTtJQUNqQ0osTUFBTSxDQUFDSyxFQUFFLENBQUMsTUFBTSxFQUFHQyxLQUFLLElBQUs7TUFDM0IsTUFBTUMsSUFBSSxHQUFHRCxLQUFLLENBQUNFLFFBQVEsQ0FBQyxDQUFDO01BQzdCLElBQUksQ0FBQ0MsVUFBVSxDQUFDO1FBQUVDLElBQUksRUFBRSxLQUFLO1FBQUVwRCxJQUFJLEVBQUU7VUFBRXFELEtBQUssRUFBRSxTQUFTO1VBQUUzRSxZQUFZLEVBQUUsSUFBSSxDQUFDQSxZQUFZO1VBQUVrRSxFQUFFO1VBQUVQLEdBQUc7VUFBRUMsU0FBUztVQUFFVztRQUFLO01BQUUsQ0FBQyxDQUFDO0lBQ3pILENBQUMsQ0FBQztJQUNGLE1BQU01QyxNQUFNLEdBQUcsTUFBTW1DLEdBQUcsQ0FBQ0EsR0FBRyxDQUFDYixTQUFTLEVBQUVVLEdBQUcsRUFBRUMsU0FBUyxJQUFJZ0IsU0FBUyxFQUFFWixNQUFNLEVBQUVZLFNBQVMsRUFBRSxJQUFJLEVBQUVmLFNBQVMsRUFBRSxLQUFLLENBQUMsQ0FBQ2dCLEtBQUssQ0FBRXRELENBQUMsSUFBSztNQUFFLE1BQU0sSUFBSUMsS0FBSyxDQUFDLGdCQUFnQkQsQ0FBQyxDQUFDRSxPQUFPLEVBQUUsQ0FBQztJQUFFLENBQUMsQ0FBQztJQUMvSztJQUNBLE1BQU1xRCxLQUFLLEdBQUdBLENBQUEsS0FBTTtNQUNsQixJQUFJO1FBQUVuRCxNQUFNLElBQUlBLE1BQU0sQ0FBQ21ELEtBQUssSUFBSW5ELE1BQU0sQ0FBQ21ELEtBQUssQ0FBQyxDQUFDO01BQUUsQ0FBQyxDQUFDLE9BQU9qRCxDQUFDLEVBQUUsQ0FBQztNQUM3RCxJQUFJO1FBQUVtQyxNQUFNLENBQUNoQyxHQUFHLENBQUMsQ0FBQztNQUFFLENBQUMsQ0FBQyxPQUFPSCxDQUFDLEVBQUUsQ0FBQztJQUNuQyxDQUFDO0lBQ0QsSUFBSSxDQUFDeEIsVUFBVSxDQUFDMEUsR0FBRyxDQUFDYixFQUFFLEVBQUU7TUFBRXZDLE1BQU0sRUFBRW1EO0lBQU0sQ0FBQyxDQUFDO0lBQzFDLE9BQU87TUFBRXpELE9BQU8sRUFBRSxJQUFJO01BQUVDLElBQUksRUFBRTtRQUFFNEM7TUFBRztJQUFFLENBQUM7RUFDeEM7RUFFQSxNQUFNYyxRQUFRQSxDQUFDO0lBQUVkO0VBQUcsQ0FBQyxFQUFFO0lBQ3JCLE1BQU1lLENBQUMsR0FBRyxJQUFJLENBQUM1RSxVQUFVLENBQUM2RSxHQUFHLENBQUNoQixFQUFFLENBQUM7SUFDakMsSUFBSWUsQ0FBQyxJQUFJQSxDQUFDLENBQUN0RCxNQUFNLEVBQUVzRCxDQUFDLENBQUN0RCxNQUFNLENBQUMsQ0FBQztJQUM3QixJQUFJLENBQUN0QixVQUFVLENBQUM4RSxNQUFNLENBQUNqQixFQUFFLENBQUM7SUFDMUIsT0FBTztNQUFFN0MsT0FBTyxFQUFFO0lBQUssQ0FBQztFQUMxQjtFQUVBLE1BQU0rRCxRQUFRQSxDQUFDO0lBQUVuQyxTQUFTLEdBQUcsSUFBSSxDQUFDaEQsTUFBTSxDQUFDZ0QsU0FBUyxJQUFJLFNBQVM7SUFBRVUsR0FBRztJQUFFQyxTQUFTO0lBQUV5QixPQUFPLEdBQUcsQ0FBQyxTQUFTLENBQUM7SUFBRUMsR0FBRyxHQUFHO0VBQUssQ0FBQyxFQUFFO0lBQ3BILElBQUksQ0FBQzNCLEdBQUcsRUFBRSxNQUFNLElBQUluQyxLQUFLLENBQUMsY0FBYyxDQUFDO0lBQ3pDLE1BQU0rRCxJQUFJLEdBQUcsSUFBSTNGLEdBQUcsQ0FBQzRGLElBQUksQ0FBQyxJQUFJLENBQUN0RixFQUFFLENBQUM7SUFDbEMsTUFBTTtNQUFFK0Q7SUFBWSxDQUFDLEdBQUdwRSxPQUFPLENBQUMsUUFBUSxDQUFDO0lBQ3pDLE1BQU00RixNQUFNLEdBQUcsSUFBSXhCLFdBQVcsQ0FBQyxDQUFDO0lBQ2hDLE1BQU15QixNQUFNLEdBQUcsSUFBSXpCLFdBQVcsQ0FBQyxDQUFDO0lBQ2hDLE1BQU1sQyxLQUFLLEdBQUcsSUFBSWtDLFdBQVcsQ0FBQyxDQUFDO0lBQy9CLE1BQU1DLEVBQUUsR0FBRyxHQUFHUCxHQUFHLFNBQVNRLElBQUksQ0FBQ0MsR0FBRyxDQUFDLENBQUMsRUFBRTtJQUN0QyxNQUFNdUIsTUFBTSxHQUFHQSxDQUFDQyxHQUFHLEVBQUVDLFVBQVUsS0FBSztNQUNsQyxJQUFJLENBQUNwQixVQUFVLENBQUM7UUFBRUMsSUFBSSxFQUFFLEtBQUs7UUFBRXBELElBQUksRUFBRTtVQUFFcUQsS0FBSyxFQUFFLFNBQVM7VUFBRTNFLFlBQVksRUFBRSxJQUFJLENBQUNBLFlBQVk7VUFBRWtFLEVBQUU7VUFBRVAsR0FBRztVQUFFQyxTQUFTO1VBQUVJLE1BQU0sRUFBRTZCLFVBQVU7VUFBRXZFLElBQUksRUFBRXNFLEdBQUcsQ0FBQ3BCLFFBQVEsQ0FBQyxNQUFNO1FBQUU7TUFBRSxDQUFDLENBQUM7SUFDbkssQ0FBQztJQUNEaUIsTUFBTSxDQUFDcEIsRUFBRSxDQUFDLE1BQU0sRUFBR3lCLENBQUMsSUFBS0gsTUFBTSxDQUFDRyxDQUFDLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDN0NKLE1BQU0sQ0FBQ3JCLEVBQUUsQ0FBQyxNQUFNLEVBQUd5QixDQUFDLElBQUtILE1BQU0sQ0FBQ0csQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzdDLE1BQU1QLElBQUksQ0FBQ0EsSUFBSSxDQUFDdEMsU0FBUyxFQUFFVSxHQUFHLEVBQUVDLFNBQVMsSUFBSWdCLFNBQVMsRUFBRVMsT0FBTyxFQUFFSSxNQUFNLEVBQUVDLE1BQU0sRUFBRTNELEtBQUssRUFBRXVELEdBQUcsQ0FBQztJQUM1RixJQUFJLENBQUMvRSxZQUFZLENBQUN3RSxHQUFHLENBQUNiLEVBQUUsRUFBRTtNQUFFbkMsS0FBSztNQUFFMEQsTUFBTTtNQUFFQztJQUFPLENBQUMsQ0FBQztJQUNwRCxPQUFPO01BQUVyRSxPQUFPLEVBQUUsSUFBSTtNQUFFQyxJQUFJLEVBQUU7UUFBRTRDO01BQUc7SUFBRSxDQUFDO0VBQ3hDO0VBRUEsTUFBTTZCLFNBQVNBLENBQUM7SUFBRTdCLEVBQUU7SUFBRTVDO0VBQUssQ0FBQyxFQUFFO0lBQzVCLE1BQU0yRCxDQUFDLEdBQUcsSUFBSSxDQUFDMUUsWUFBWSxDQUFDMkUsR0FBRyxDQUFDaEIsRUFBRSxDQUFDO0lBQ25DLElBQUksQ0FBQ2UsQ0FBQyxFQUFFLE1BQU0sSUFBSXpELEtBQUssQ0FBQyx3QkFBd0IsQ0FBQztJQUNqRHlELENBQUMsQ0FBQ2xELEtBQUssQ0FBQ2lFLEtBQUssQ0FBQzFFLElBQUksQ0FBQztJQUNuQixPQUFPO01BQUVELE9BQU8sRUFBRTtJQUFLLENBQUM7RUFDMUI7RUFFQSxNQUFNNEUsU0FBU0EsQ0FBQztJQUFFL0I7RUFBRyxDQUFDLEVBQUU7SUFDdEIsTUFBTWUsQ0FBQyxHQUFHLElBQUksQ0FBQzFFLFlBQVksQ0FBQzJFLEdBQUcsQ0FBQ2hCLEVBQUUsQ0FBQztJQUNuQyxJQUFJLENBQUNlLENBQUMsRUFBRSxPQUFPO01BQUU1RCxPQUFPLEVBQUU7SUFBSyxDQUFDO0lBQ2hDLElBQUk7TUFBRTRELENBQUMsQ0FBQ2xELEtBQUssQ0FBQ0MsR0FBRyxDQUFDLENBQUM7SUFBRSxDQUFDLENBQUMsT0FBT0gsQ0FBQyxFQUFFLENBQUM7SUFDbEMsSUFBSSxDQUFDdEIsWUFBWSxDQUFDNEUsTUFBTSxDQUFDakIsRUFBRSxDQUFDO0lBQzVCLE9BQU87TUFBRTdDLE9BQU8sRUFBRTtJQUFLLENBQUM7RUFDMUI7RUFFQW9ELFVBQVVBLENBQUNoRCxPQUFPLEVBQUU7SUFDbEIsSUFBSXlFLE1BQU0sQ0FBQ0MsU0FBUyxFQUFFRCxNQUFNLENBQUNDLFNBQVMsQ0FBQzFFLE9BQU8sQ0FBQztFQUNqRDtBQUNGO0FBRUEyRSxNQUFNLENBQUNDLE9BQU8sR0FBR3ZHLFVBQVUiLCJpZ25vcmVMaXN0IjpbXX0=