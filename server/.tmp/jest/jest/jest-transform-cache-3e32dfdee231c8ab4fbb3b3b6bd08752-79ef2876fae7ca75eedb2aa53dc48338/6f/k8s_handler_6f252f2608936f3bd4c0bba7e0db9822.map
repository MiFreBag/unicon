{"version":3,"names":["k8s","require","K8sHandler","constructor","connectionId","config","kc","core","currentContext","logStreams","Map","execSessions","connect","KubeConfig","kubeconfig","kubeconfigPath","context","trim","loadFromString","loadFromFile","loadFromDefault","setCurrentContext","makeApiClient","CoreV1Api","getCurrentContext","success","data","e","Error","message","disconnect","cancel","values","_","clear","stdin","end","listContexts","contexts","getContexts","current","useContext","name","listNamespaces","res","listNamespace","items","body","map","ns","metadata","namespaces","listPods","namespace","listNamespacedPod","pods","p","phase","status","containers","spec","c","logsStart","pod","container","tailLines","log","Log","stream","PassThrough","id","Date","now","on","chunk","line","toString","_broadcast","type","event","undefined","catch","abort","set","logsStop","s","get","delete","execOpen","command","tty","exec","Exec","stdout","stderr","onData","buf","streamName","b","execInput","write","execClose","global","broadcast","module","exports"],"sources":["k8s_handler.js"],"sourcesContent":["// server/handlers/k8s_handler.js\r\nconst k8s = require('@kubernetes/client-node');\r\n\r\nclass K8sHandler {\r\n  constructor(connectionId, config) {\r\n    this.connectionId = connectionId;\r\n    this.config = config || {};\r\n    this.kc = null;\r\n    this.core = null;\r\n    this.currentContext = null;\r\n    this.logStreams = new Map(); // id -> { cancel }\r\n    this.execSessions = new Map(); // id -> { stdin, stdout, stderr }\r\n  }\r\n\r\n  async connect() {\r\n    this.kc = new k8s.KubeConfig();\r\n    const { kubeconfig, kubeconfigPath, context } = this.config;\r\n    try {\r\n      if (kubeconfig && typeof kubeconfig === 'string' && kubeconfig.trim()) {\r\n        this.kc.loadFromString(kubeconfig);\r\n      } else if (kubeconfigPath && typeof kubeconfigPath === 'string' && kubeconfigPath.trim()) {\r\n        this.kc.loadFromFile(kubeconfigPath);\r\n      } else {\r\n        this.kc.loadFromDefault();\r\n      }\r\n      if (context) this.kc.setCurrentContext(context);\r\n      this.core = this.kc.makeApiClient(k8s.CoreV1Api);\r\n      this.currentContext = this.kc.getCurrentContext();\r\n      return { success: true, data: { context: this.currentContext } };\r\n    } catch (e) {\r\n      throw new Error(`K8s config load failed: ${e.message}`);\r\n    }\r\n  }\r\n\r\n  async disconnect() {\r\n    // Stop any running streams\r\n    for (const { cancel } of this.logStreams.values()) {\r\n      try { cancel && cancel(); } catch (_) {}\r\n    }\r\n    this.logStreams.clear();\r\n    for (const { stdin } of this.execSessions.values()) {\r\n      try { stdin && stdin.end(); } catch (_) {}\r\n    }\r\n    this.execSessions.clear();\r\n    return { success: true };\r\n  }\r\n\r\n  listContexts() {\r\n    const contexts = this.kc.getContexts() || [];\r\n    const current = this.kc.getCurrentContext();\r\n    return { success: true, data: { contexts, current } };\r\n  }\r\n\r\n  useContext(name) {\r\n    this.kc.setCurrentContext(name);\r\n    this.currentContext = name;\r\n    this.core = this.kc.makeApiClient(k8s.CoreV1Api);\r\n    return { success: true, data: { current: name } };\r\n  }\r\n\r\n  async listNamespaces() {\r\n    const res = await this.core.listNamespace();\r\n    const items = (res.body.items || []).map(ns => ns.metadata?.name);\r\n    return { success: true, data: { namespaces: items } };\r\n  }\r\n\r\n  async listPods(namespace = this.config.namespace || 'default') {\r\n    const res = await this.core.listNamespacedPod(namespace);\r\n    const pods = (res.body.items || []).map(p => ({\r\n      name: p.metadata?.name,\r\n      namespace: p.metadata?.namespace,\r\n      phase: p.status?.phase,\r\n      containers: (p.spec?.containers || []).map(c => c.name),\r\n    }));\r\n    return { success: true, data: { pods } };\r\n  }\r\n\r\n  async logsStart({ namespace = this.config.namespace || 'default', pod, container, tailLines = 200 }) {\r\n    if (!pod) throw new Error('pod required');\r\n    const log = new k8s.Log(this.kc);\r\n    const stream = new (require('stream').PassThrough)();\r\n    const id = `${pod}-${Date.now()}`;\r\n    stream.on('data', (chunk) => {\r\n      const line = chunk.toString();\r\n      this._broadcast({ type: 'k8s', data: { event: 'logLine', connectionId: this.connectionId, id, pod, container, line } });\r\n    });\r\n    const cancel = await log.log(namespace, pod, container || undefined, stream, undefined, true, tailLines, false).catch((e) => { throw new Error(`logs failed: ${e.message}`); });\r\n    // @kubernetes/client-node returns a request; set cancel function\r\n    const abort = () => {\r\n      try { cancel && cancel.abort && cancel.abort(); } catch (_) {}\r\n      try { stream.end(); } catch (_) {}\r\n    };\r\n    this.logStreams.set(id, { cancel: abort });\r\n    return { success: true, data: { id } };\r\n  }\r\n\r\n  async logsStop({ id }) {\r\n    const s = this.logStreams.get(id);\r\n    if (s && s.cancel) s.cancel();\r\n    this.logStreams.delete(id);\r\n    return { success: true };\r\n  }\r\n\r\n  async execOpen({ namespace = this.config.namespace || 'default', pod, container, command = ['/bin/sh'], tty = true }) {\r\n    if (!pod) throw new Error('pod required');\r\n    const exec = new k8s.Exec(this.kc);\r\n    const { PassThrough } = require('stream');\r\n    const stdout = new PassThrough();\r\n    const stderr = new PassThrough();\r\n    const stdin = new PassThrough();\r\n    const id = `${pod}-exec-${Date.now()}`;\r\n    const onData = (buf, streamName) => {\r\n      this._broadcast({ type: 'k8s', data: { event: 'execOut', connectionId: this.connectionId, id, pod, container, stream: streamName, data: buf.toString('utf8') } });\r\n    };\r\n    stdout.on('data', (b) => onData(b, 'stdout'));\r\n    stderr.on('data', (b) => onData(b, 'stderr'));\r\n    await exec.exec(namespace, pod, container || undefined, command, stdout, stderr, stdin, tty);\r\n    this.execSessions.set(id, { stdin, stdout, stderr });\r\n    return { success: true, data: { id } };\r\n  }\r\n\r\n  async execInput({ id, data }) {\r\n    const s = this.execSessions.get(id);\r\n    if (!s) throw new Error('exec session not found');\r\n    s.stdin.write(data);\r\n    return { success: true };\r\n  }\r\n\r\n  async execClose({ id }) {\r\n    const s = this.execSessions.get(id);\r\n    if (!s) return { success: true };\r\n    try { s.stdin.end(); } catch (_) {}\r\n    this.execSessions.delete(id);\r\n    return { success: true };\r\n  }\r\n\r\n  _broadcast(message) {\r\n    if (global.broadcast) global.broadcast(message);\r\n  }\r\n}\r\n\r\nmodule.exports = K8sHandler;\r\n"],"mappings":"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","ignoreList":[]}