{"version":3,"names":["path","require","fs","sqlite3","verbose","ensureDir","p","existsSync","mkdirSync","recursive","DB","constructor","filePath","db","init","dirname","Database","_run","sql","params","Promise","resolve","reject","run","err","_all","all","rows","getConnections","map","r","id","name","type","config","JSON","parse","createdAt","status","upsertConnection","conn","stringify","deleteConnection","replaceConnections","conns","c","createUser","email","password_hash","salt","getUserByEmail","ensureRole","length","Date","now","Math","random","assignRoleToUser","userId","roleName","role","getRolesForUser","setUserPref","key","value","getUserPref","module","exports"],"sources":["db.js"],"sourcesContent":["// server/persistence/db.js\r\nconst path = require('path');\r\nconst fs = require('fs');\r\nconst sqlite3 = require('sqlite3').verbose();\r\n\r\nfunction ensureDir(p) { if (!fs.existsSync(p)) fs.mkdirSync(p, { recursive: true }); }\r\n\r\nclass DB {\r\n  constructor(filePath) {\r\n    this.filePath = filePath;\r\n    this.db = null;\r\n  }\r\n\r\n  async init() {\r\n    ensureDir(path.dirname(this.filePath));\r\n    this.db = new sqlite3.Database(this.filePath);\r\n    await this._run(`CREATE TABLE IF NOT EXISTS connections (\r\n      id TEXT PRIMARY KEY,\r\n      name TEXT NOT NULL,\r\n      type TEXT NOT NULL,\r\n      config TEXT NOT NULL,\r\n      createdAt TEXT NOT NULL\r\n    )`);\r\n    await this._run(`CREATE TABLE IF NOT EXISTS users (\r\n      id TEXT PRIMARY KEY,\r\n      email TEXT UNIQUE NOT NULL,\r\n      password_hash TEXT NOT NULL,\r\n      salt TEXT NOT NULL,\r\n      createdAt TEXT NOT NULL\r\n    )`);\r\n    await this._run(`CREATE TABLE IF NOT EXISTS roles (\r\n      id TEXT PRIMARY KEY,\r\n      name TEXT UNIQUE NOT NULL\r\n    )`);\r\n    await this._run(`CREATE TABLE IF NOT EXISTS user_roles (\r\n      user_id TEXT NOT NULL,\r\n      role_id TEXT NOT NULL,\r\n      PRIMARY KEY (user_id, role_id)\r\n    )`);\r\n    await this._run(`CREATE TABLE IF NOT EXISTS user_prefs (\r\n      user_id TEXT NOT NULL,\r\n      key TEXT NOT NULL,\r\n      value TEXT NOT NULL,\r\n      PRIMARY KEY (user_id, key)\r\n    )`);\r\n    return this;\r\n  }\r\n\r\n  _run(sql, params = []) {\r\n    return new Promise((resolve, reject) => {\r\n      this.db.run(sql, params, function (err) { if (err) reject(err); else resolve(this); });\r\n    });\r\n  }\r\n\r\n  _all(sql, params = []) {\r\n    return new Promise((resolve, reject) => {\r\n      this.db.all(sql, params, (err, rows) => { if (err) reject(err); else resolve(rows); });\r\n    });\r\n  }\r\n\r\n  async getConnections() {\r\n    const rows = await this._all('SELECT id, name, type, config, createdAt FROM connections ORDER BY createdAt ASC');\r\n    return rows.map(r => ({ id: r.id, name: r.name, type: r.type, config: JSON.parse(r.config), createdAt: r.createdAt, status: 'disconnected' }));\r\n  }\r\n\r\n  async upsertConnection(conn) {\r\n    await this._run(\r\n      `INSERT INTO connections (id, name, type, config, createdAt) VALUES (?, ?, ?, ?, ?)\r\n       ON CONFLICT(id) DO UPDATE SET name=excluded.name, type=excluded.type, config=excluded.config`,\r\n      [conn.id, conn.name, conn.type, JSON.stringify(conn.config || {}), conn.createdAt]\r\n    );\r\n  }\r\n\r\n  async deleteConnection(id) {\r\n    await this._run('DELETE FROM connections WHERE id = ?', [id]);\r\n  }\r\n\r\n  async replaceConnections(conns) {\r\n    await this._run('DELETE FROM connections');\r\n    for (const c of conns) await this.upsertConnection(c);\r\n  }\r\n\r\n  // Auth persistence\r\n  async createUser({ id, email, password_hash, salt, createdAt }) {\r\n    await this._run(\r\n      `INSERT INTO users (id, email, password_hash, salt, createdAt) VALUES (?, ?, ?, ?, ?)`,\r\n      [id, email, password_hash, salt, createdAt]\r\n    );\r\n  }\r\n\r\n  async getUserByEmail(email) {\r\n    const rows = await this._all('SELECT * FROM users WHERE email = ?', [email]);\r\n    return rows[0] || null;\r\n  }\r\n\r\n  async ensureRole(name) {\r\n    const rows = await this._all('SELECT * FROM roles WHERE name = ?', [name]);\r\n    if (rows.length) return rows[0];\r\n    const id = `${Date.now()}-${Math.random()}`;\r\n    await this._run('INSERT INTO roles (id, name) VALUES (?, ?)', [id, name]);\r\n    return { id, name };\r\n  }\r\n\r\n  async assignRoleToUser(userId, roleName) {\r\n    const role = await this.ensureRole(roleName);\r\n    await this._run('INSERT OR IGNORE INTO user_roles (user_id, role_id) VALUES (?, ?)', [userId, role.id]);\r\n  }\r\n\r\n  async getRolesForUser(userId) {\r\n    const rows = await this._all(\r\n      `SELECT r.name FROM roles r JOIN user_roles ur ON r.id = ur.role_id WHERE ur.user_id = ?`,\r\n      [userId]\r\n    );\r\n    return rows.map(r => r.name);\r\n  }\r\n\r\n  async setUserPref(userId, key, value) {\r\n    await this._run(\r\n      `INSERT INTO user_prefs (user_id, key, value) VALUES (?, ?, ?)\r\n       ON CONFLICT(user_id, key) DO UPDATE SET value=excluded.value`,\r\n      [userId, key, value]\r\n    );\r\n  }\r\n\r\n  async getUserPref(userId, key) {\r\n    const rows = await this._all('SELECT value FROM user_prefs WHERE user_id = ? AND key = ?', [userId, key]);\r\n    return rows[0]?.value ?? null;\r\n  }\r\n}\r\n\r\nmodule.exports = { DB };"],"mappings":"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","ignoreList":[]}