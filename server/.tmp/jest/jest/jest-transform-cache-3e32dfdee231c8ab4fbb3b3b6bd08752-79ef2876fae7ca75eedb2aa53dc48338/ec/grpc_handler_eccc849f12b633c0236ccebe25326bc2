549e1632122147261f6ca6fbef9f0789
// server/handlers/grpc_handler.js
const grpc = require('@grpc/grpc-js');
const protoLoader = require('@grpc/proto-loader');
const path = require('path');
class GrpcHandler {
  constructor(connectionId, config = {}) {
    this.connectionId = connectionId;
    this.config = config;
    this.client = null;
  }
  async connect() {
    // Minimal: create client from proto if provided
    if (!this.config.address || !this.config.proto || !this.config.package || !this.config.service) {
      // Allow connecting later when details provided
      return {
        success: true,
        message: 'gRPC config incomplete; ready for later init'
      };
    }
    const defs = await this._loadProto(this.config.proto);
    const svc = this._lookup(defs, this.config.package, this.config.service);
    this.client = new svc(this.config.address, grpc.credentials.createInsecure());
    return {
      success: true
    };
  }
  async disconnect() {
    if (this.client && this.client.close) this.client.close();
    this.client = null;
    return {
      success: true
    };
  }

  // Example unary call
  async unary(method, request) {
    if (!this.client || !this.client[method]) throw new Error('Client or method not available');
    return new Promise((resolve, reject) => {
      this.client[method](request, (err, resp) => {
        if (err) return reject(err);
        resolve({
          success: true,
          data: resp
        });
      });
    });
  }
  async _loadProto(protoRelPath) {
    const fullPath = path.isAbsolute(protoRelPath) ? protoRelPath : path.join(__dirname, '..', 'proto', protoRelPath);
    const packageDefinition = await protoLoader.load(fullPath, {
      keepCase: true,
      longs: String,
      enums: String,
      defaults: true,
      oneofs: true
    });
    return grpc.loadPackageDefinition(packageDefinition);
  }
  _lookup(defs, pkgName, svcName) {
    const parts = pkgName.split('.');
    let cur = defs;
    for (const p of parts) cur = cur[p];
    return cur[svcName];
  }
}
module.exports = GrpcHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJncnBjIiwicmVxdWlyZSIsInByb3RvTG9hZGVyIiwicGF0aCIsIkdycGNIYW5kbGVyIiwiY29uc3RydWN0b3IiLCJjb25uZWN0aW9uSWQiLCJjb25maWciLCJjbGllbnQiLCJjb25uZWN0IiwiYWRkcmVzcyIsInByb3RvIiwicGFja2FnZSIsInNlcnZpY2UiLCJzdWNjZXNzIiwibWVzc2FnZSIsImRlZnMiLCJfbG9hZFByb3RvIiwic3ZjIiwiX2xvb2t1cCIsImNyZWRlbnRpYWxzIiwiY3JlYXRlSW5zZWN1cmUiLCJkaXNjb25uZWN0IiwiY2xvc2UiLCJ1bmFyeSIsIm1ldGhvZCIsInJlcXVlc3QiLCJFcnJvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZXJyIiwicmVzcCIsImRhdGEiLCJwcm90b1JlbFBhdGgiLCJmdWxsUGF0aCIsImlzQWJzb2x1dGUiLCJqb2luIiwiX19kaXJuYW1lIiwicGFja2FnZURlZmluaXRpb24iLCJsb2FkIiwia2VlcENhc2UiLCJsb25ncyIsIlN0cmluZyIsImVudW1zIiwiZGVmYXVsdHMiLCJvbmVvZnMiLCJsb2FkUGFja2FnZURlZmluaXRpb24iLCJwa2dOYW1lIiwic3ZjTmFtZSIsInBhcnRzIiwic3BsaXQiLCJjdXIiLCJwIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbImdycGNfaGFuZGxlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBzZXJ2ZXIvaGFuZGxlcnMvZ3JwY19oYW5kbGVyLmpzXHJcbmNvbnN0IGdycGMgPSByZXF1aXJlKCdAZ3JwYy9ncnBjLWpzJyk7XHJcbmNvbnN0IHByb3RvTG9hZGVyID0gcmVxdWlyZSgnQGdycGMvcHJvdG8tbG9hZGVyJyk7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XHJcblxyXG5jbGFzcyBHcnBjSGFuZGxlciB7XHJcbiAgY29uc3RydWN0b3IoY29ubmVjdGlvbklkLCBjb25maWcgPSB7fSkge1xyXG4gICAgdGhpcy5jb25uZWN0aW9uSWQgPSBjb25uZWN0aW9uSWQ7XHJcbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcclxuICAgIHRoaXMuY2xpZW50ID0gbnVsbDtcclxuICB9XHJcblxyXG4gIGFzeW5jIGNvbm5lY3QoKSB7XHJcbiAgICAvLyBNaW5pbWFsOiBjcmVhdGUgY2xpZW50IGZyb20gcHJvdG8gaWYgcHJvdmlkZWRcclxuICAgIGlmICghdGhpcy5jb25maWcuYWRkcmVzcyB8fCAhdGhpcy5jb25maWcucHJvdG8gfHwgIXRoaXMuY29uZmlnLnBhY2thZ2UgfHwgIXRoaXMuY29uZmlnLnNlcnZpY2UpIHtcclxuICAgICAgLy8gQWxsb3cgY29ubmVjdGluZyBsYXRlciB3aGVuIGRldGFpbHMgcHJvdmlkZWRcclxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgbWVzc2FnZTogJ2dSUEMgY29uZmlnIGluY29tcGxldGU7IHJlYWR5IGZvciBsYXRlciBpbml0JyB9O1xyXG4gICAgfVxyXG4gICAgY29uc3QgZGVmcyA9IGF3YWl0IHRoaXMuX2xvYWRQcm90byh0aGlzLmNvbmZpZy5wcm90byk7XHJcbiAgICBjb25zdCBzdmMgPSB0aGlzLl9sb29rdXAoZGVmcywgdGhpcy5jb25maWcucGFja2FnZSwgdGhpcy5jb25maWcuc2VydmljZSk7XHJcbiAgICB0aGlzLmNsaWVudCA9IG5ldyBzdmModGhpcy5jb25maWcuYWRkcmVzcywgZ3JwYy5jcmVkZW50aWFscy5jcmVhdGVJbnNlY3VyZSgpKTtcclxuICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGRpc2Nvbm5lY3QoKSB7XHJcbiAgICBpZiAodGhpcy5jbGllbnQgJiYgdGhpcy5jbGllbnQuY2xvc2UpIHRoaXMuY2xpZW50LmNsb3NlKCk7XHJcbiAgICB0aGlzLmNsaWVudCA9IG51bGw7XHJcbiAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07XHJcbiAgfVxyXG5cclxuICAvLyBFeGFtcGxlIHVuYXJ5IGNhbGxcclxuICBhc3luYyB1bmFyeShtZXRob2QsIHJlcXVlc3QpIHtcclxuICAgIGlmICghdGhpcy5jbGllbnQgfHwgIXRoaXMuY2xpZW50W21ldGhvZF0pIHRocm93IG5ldyBFcnJvcignQ2xpZW50IG9yIG1ldGhvZCBub3QgYXZhaWxhYmxlJyk7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB0aGlzLmNsaWVudFttZXRob2RdKHJlcXVlc3QsIChlcnIsIHJlc3ApID0+IHtcclxuICAgICAgICBpZiAoZXJyKSByZXR1cm4gcmVqZWN0KGVycik7XHJcbiAgICAgICAgcmVzb2x2ZSh7IHN1Y2Nlc3M6IHRydWUsIGRhdGE6IHJlc3AgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBfbG9hZFByb3RvKHByb3RvUmVsUGF0aCkge1xyXG4gICAgY29uc3QgZnVsbFBhdGggPSBwYXRoLmlzQWJzb2x1dGUocHJvdG9SZWxQYXRoKVxyXG4gICAgICA/IHByb3RvUmVsUGF0aFxyXG4gICAgICA6IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLicsICdwcm90bycsIHByb3RvUmVsUGF0aCk7XHJcbiAgICBjb25zdCBwYWNrYWdlRGVmaW5pdGlvbiA9IGF3YWl0IHByb3RvTG9hZGVyLmxvYWQoZnVsbFBhdGgsIHtcclxuICAgICAga2VlcENhc2U6IHRydWUsXHJcbiAgICAgIGxvbmdzOiBTdHJpbmcsXHJcbiAgICAgIGVudW1zOiBTdHJpbmcsXHJcbiAgICAgIGRlZmF1bHRzOiB0cnVlLFxyXG4gICAgICBvbmVvZnM6IHRydWUsXHJcbiAgICB9KTtcclxuICAgIHJldHVybiBncnBjLmxvYWRQYWNrYWdlRGVmaW5pdGlvbihwYWNrYWdlRGVmaW5pdGlvbik7XHJcbiAgfVxyXG5cclxuICBfbG9va3VwKGRlZnMsIHBrZ05hbWUsIHN2Y05hbWUpIHtcclxuICAgIGNvbnN0IHBhcnRzID0gcGtnTmFtZS5zcGxpdCgnLicpO1xyXG4gICAgbGV0IGN1ciA9IGRlZnM7XHJcbiAgICBmb3IgKGNvbnN0IHAgb2YgcGFydHMpIGN1ciA9IGN1cltwXTtcclxuICAgIHJldHVybiBjdXJbc3ZjTmFtZV07XHJcbiAgfVxyXG59XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IEdycGNIYW5kbGVyOyJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxlQUFlLENBQUM7QUFDckMsTUFBTUMsV0FBVyxHQUFHRCxPQUFPLENBQUMsb0JBQW9CLENBQUM7QUFDakQsTUFBTUUsSUFBSSxHQUFHRixPQUFPLENBQUMsTUFBTSxDQUFDO0FBRTVCLE1BQU1HLFdBQVcsQ0FBQztFQUNoQkMsV0FBV0EsQ0FBQ0MsWUFBWSxFQUFFQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLEVBQUU7SUFDckMsSUFBSSxDQUFDRCxZQUFZLEdBQUdBLFlBQVk7SUFDaEMsSUFBSSxDQUFDQyxNQUFNLEdBQUdBLE1BQU07SUFDcEIsSUFBSSxDQUFDQyxNQUFNLEdBQUcsSUFBSTtFQUNwQjtFQUVBLE1BQU1DLE9BQU9BLENBQUEsRUFBRztJQUNkO0lBQ0EsSUFBSSxDQUFDLElBQUksQ0FBQ0YsTUFBTSxDQUFDRyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUNILE1BQU0sQ0FBQ0ksS0FBSyxJQUFJLENBQUMsSUFBSSxDQUFDSixNQUFNLENBQUNLLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQ0wsTUFBTSxDQUFDTSxPQUFPLEVBQUU7TUFDOUY7TUFDQSxPQUFPO1FBQUVDLE9BQU8sRUFBRSxJQUFJO1FBQUVDLE9BQU8sRUFBRTtNQUErQyxDQUFDO0lBQ25GO0lBQ0EsTUFBTUMsSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDQyxVQUFVLENBQUMsSUFBSSxDQUFDVixNQUFNLENBQUNJLEtBQUssQ0FBQztJQUNyRCxNQUFNTyxHQUFHLEdBQUcsSUFBSSxDQUFDQyxPQUFPLENBQUNILElBQUksRUFBRSxJQUFJLENBQUNULE1BQU0sQ0FBQ0ssT0FBTyxFQUFFLElBQUksQ0FBQ0wsTUFB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