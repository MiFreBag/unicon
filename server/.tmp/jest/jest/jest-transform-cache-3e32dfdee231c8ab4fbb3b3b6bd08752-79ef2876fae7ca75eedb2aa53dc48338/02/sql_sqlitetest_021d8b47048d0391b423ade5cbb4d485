839df89235c24d94cb94f69b18983149
const request = require('supertest');
const {
  startServers,
  buildState
} = require('..');
let srv;
let baseUrl;
beforeAll(() => {
  process.env.PORT = process.env.PORT || '3102';
  process.env.WS_PORT = process.env.WS_PORT || '8181';
  srv = startServers(buildState());
  baseUrl = `http://127.0.0.1:${process.env.PORT}`;
});
afterAll(done => {
  try {
    srv.server.close(() => done());
  } catch {
    done();
  }
});
test('sqlite :memory: create/insert/select', async () => {
  // Create SQL connection
  const createRes = await request(baseUrl).post('/unicon/api/connections').send({
    name: 'mem-sqlite',
    type: 'sql',
    config: {
      driver: 'sqlite',
      filename: ':memory:'
    }
  }).set('Content-Type', 'application/json');
  expect(createRes.status).toBe(200);
  const connectionId = createRes.body.connection.id;

  // Connect
  const connectRes = await request(baseUrl).post('/unicon/api/connect').send({
    connectionId
  }).set('Content-Type', 'application/json');
  expect(connectRes.status).toBe(200);

  // Create table
  let opRes = await request(baseUrl).post('/unicon/api/operation').send({
    connectionId,
    operation: 'query',
    params: {
      sql: 'CREATE TABLE t (id INTEGER PRIMARY KEY, name TEXT)'
    }
  }).set('Content-Type', 'application/json');
  expect(opRes.status).toBe(200);

  // Insert
  opRes = await request(baseUrl).post('/unicon/api/operation').send({
    connectionId,
    operation: 'query',
    params: {
      sql: 'INSERT INTO t (name) VALUES (?)',
      params: ['alice']
    }
  }).set('Content-Type', 'application/json');
  expect(opRes.status).toBe(200);

  // Select
  opRes = await request(baseUrl).post('/unicon/api/operation').send({
    connectionId,
    operation: 'query',
    params: {
      sql: 'SELECT * FROM t'
    }
  }).set('Content-Type', 'application/json');
  expect(opRes.status).toBe(200);
  expect(Array.isArray(opRes.body.data.rows) || Array.isArray(opRes.body.rows)).toBe(true);
  const rows = opRes.body.data?.rows || opRes.body.rows;
  expect(rows.length).toBe(1);
  expect(rows[0].name).toBe('alice');
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJyZXF1ZXN0IiwicmVxdWlyZSIsInN0YXJ0U2VydmVycyIsImJ1aWxkU3RhdGUiLCJzcnYiLCJiYXNlVXJsIiwiYmVmb3JlQWxsIiwicHJvY2VzcyIsImVudiIsIlBPUlQiLCJXU19QT1JUIiwiYWZ0ZXJBbGwiLCJkb25lIiwic2VydmVyIiwiY2xvc2UiLCJ0ZXN0IiwiY3JlYXRlUmVzIiwicG9zdCIsInNlbmQiLCJuYW1lIiwidHlwZSIsImNvbmZpZyIsImRyaXZlciIsImZpbGVuYW1lIiwic2V0IiwiZXhwZWN0Iiwic3RhdHVzIiwidG9CZSIsImNvbm5lY3Rpb25JZCIsImJvZHkiLCJjb25uZWN0aW9uIiwiaWQiLCJjb25uZWN0UmVzIiwib3BSZXMiLCJvcGVyYXRpb24iLCJwYXJhbXMiLCJzcWwiLCJBcnJheSIsImlzQXJyYXkiLCJkYXRhIiwicm93cyIsImxlbmd0aCJdLCJzb3VyY2VzIjpbInNxbF9zcWxpdGUudGVzdC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCByZXF1ZXN0ID0gcmVxdWlyZSgnc3VwZXJ0ZXN0Jyk7XHJcbmNvbnN0IHsgc3RhcnRTZXJ2ZXJzLCBidWlsZFN0YXRlIH0gPSByZXF1aXJlKCcuLicpO1xyXG5cclxubGV0IHNydjtcclxubGV0IGJhc2VVcmw7XHJcblxyXG5iZWZvcmVBbGwoKCkgPT4ge1xyXG4gIHByb2Nlc3MuZW52LlBPUlQgPSBwcm9jZXNzLmVudi5QT1JUIHx8ICczMTAyJztcclxuICBwcm9jZXNzLmVudi5XU19QT1JUID0gcHJvY2Vzcy5lbnYuV1NfUE9SVCB8fCAnODE4MSc7XHJcbiAgc3J2ID0gc3RhcnRTZXJ2ZXJzKGJ1aWxkU3RhdGUoKSk7XHJcbiAgYmFzZVVybCA9IGBodHRwOi8vMTI3LjAuMC4xOiR7cHJvY2Vzcy5lbnYuUE9SVH1gO1xyXG59KTtcclxuXHJcbmFmdGVyQWxsKChkb25lKSA9PiB7XHJcbiAgdHJ5IHsgc3J2LnNlcnZlci5jbG9zZSgoKSA9PiBkb25lKCkpOyB9IGNhdGNoIHsgZG9uZSgpOyB9XHJcbn0pO1xyXG5cclxudGVzdCgnc3FsaXRlIDptZW1vcnk6IGNyZWF0ZS9pbnNlcnQvc2VsZWN0JywgYXN5bmMgKCkgPT4ge1xyXG4gIC8vIENyZWF0ZSBTUUwgY29ubmVjdGlvblxyXG4gIGNvbnN0IGNyZWF0ZVJlcyA9IGF3YWl0IHJlcXVlc3QoYmFzZVVybClcclxuICAgIC5wb3N0KCcvdW5pY29uL2FwaS9jb25uZWN0aW9ucycpXHJcbiAgICAuc2VuZCh7IG5hbWU6ICdtZW0tc3FsaXRlJywgdHlwZTogJ3NxbCcsIGNvbmZpZzogeyBkcml2ZXI6ICdzcWxpdGUnLCBmaWxlbmFtZTogJzptZW1vcnk6JyB9IH0pXHJcbiAgICAuc2V0KCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpO1xyXG4gIGV4cGVjdChjcmVhdGVSZXMuc3RhdHVzKS50b0JlKDIwMCk7XHJcbiAgY29uc3QgY29ubmVjdGlvbklkID0gY3JlYXRlUmVzLmJvZHkuY29ubmVjdGlvbi5pZDtcclxuXHJcbiAgLy8gQ29ubmVjdFxyXG4gIGNvbnN0IGNvbm5lY3RSZXMgPSBhd2FpdCByZXF1ZXN0KGJhc2VVcmwpXHJcbiAgICAucG9zdCgnL3VuaWNvbi9hcGkvY29ubmVjdCcpXHJcbiAgICAuc2VuZCh7IGNvbm5lY3Rpb25JZCB9KVxyXG4gICAgLnNldCgnQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKTtcclxuICBleHBlY3QoY29ubmVjdFJlcy5zdGF0dXMpLnRvQmUoMjAwKTtcclxuXHJcbiAgLy8gQ3JlYXRlIHRhYmxlXHJcbiAgbGV0IG9wUmVzID0gYXdhaXQgcmVxdWVzdChiYXNlVXJsKVxyXG4gICAgLnBvc3QoJy91bmljb24vYXBpL29wZXJhdGlvbicpXHJcbiAgICAuc2VuZCh7IGNvbm5lY3Rpb25JZCwgb3BlcmF0aW9uOiAncXVlcnknLCBwYXJhbXM6IHsgc3FsOiAnQ1JFQVRFIFRBQkxFIHQgKGlkIElOVEVHRVIgUFJJTUFSWSBLRVksIG5hbWUgVEVYVCknIH0gfSlcclxuICAgIC5zZXQoJ0NvbnRlbnQtVHlwZScsICdhcHBsaWNhdGlvbi9qc29uJyk7XHJcbiAgZXhwZWN0KG9wUmVzLnN0YXR1cykudG9CZSgyMDApO1xyXG5cclxuICAvLyBJbnNlcnRcclxuICBvcFJlcyA9IGF3YWl0IHJlcXVlc3QoYmFzZVVybClcclxuICAgIC5wb3N0KCcvdW5pY29uL2FwaS9vcGVyYXRpb24nKVxyXG4gICAgLnNlbmQoeyBjb25uZWN0aW9uSWQsIG9wZXJhdGlvbjogJ3F1ZXJ5JywgcGFyYW1zOiB7IHNxbDogJ0lOU0VSVCBJTlRPIHQgKG5hbWUpIFZBTFVFUyAoPyknLCBwYXJhbXM6IFsnYWxpY2UnXSB9IH0pXHJcbiAgICAuc2V0KCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpO1xyXG4gIGV4cGVjdChvcFJlcy5zdGF0dXMpLnRvQmUoMjAwKTtcclxuXHJcbiAgLy8gU2VsZWN0XHJcbiAgb3BSZXMgPSBhd2FpdCByZXF1ZXN0KGJhc2VVcmwpXHJcbiAgICAucG9zdCgnL3VuaWNvbi9hcGkvb3BlcmF0aW9uJylcclxuICAgIC5zZW5kKHsgY29ubmVjdGlvbklkLCBvcGVyYXRpb246ICdxdWVyeScsIHBhcmFtczogeyBzcWw6ICdTRUxFQ1QgKiBGUk9NIHQnIH0gfSlcclxuICAgIC5zZXQoJ0NvbnRlbnQtVHlwZScsICdhcHBsaWNhdGlvbi9qc29uJyk7XHJcbiAgZXhwZWN0KG9wUmVzLnN0YXR1cykudG9CZSgyMDApO1xyXG4gIGV4cGVjdChBcnJheS5pc0FycmF5KG9wUmVzLmJvZHkuZGF0YS5yb3dzKSB8fCBBcnJheS5pc0FycmF5KG9wUmVzLmJvZHkucm93cykpLnRvQmUodHJ1ZSk7XHJcbiAgY29uc3Qgcm93cyA9IG9wUmVzLmJvZHkuZGF0YT8ucm93cyB8fCBvcFJlcy5ib2R5LnJvd3M7XHJcbiAgZXhwZWN0KHJvd3MubGVuZ3RoKS50b0JlKDEpO1xyXG4gIGV4cGVjdChyb3dzWzBdLm5hbWUpLnRvQmUoJ2FsaWNlJyk7XHJcbn0pO1xyXG4iXSwibWFwcGluZ3Mi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