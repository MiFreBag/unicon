{"version":3,"names":["OPCUAClient","AttributeIds","MessageSecurityMode","SecurityPolicy","Variant","VariantArrayType","DataType","require","OPCUAHandler","constructor","connectionId","config","client","session","isConnected","_metaCache","Map","connect","endpointUrl","Error","create","applicationName","securityMode","None","securityPolicy","endpointMustExist","connectionStrategy","initialDelay","maxRetry","timeoutMs","Number","connectPromise","timed","Promise","_","reject","setTimeout","race","createSession","success","disconnect","close","clear","browse","nodeId","result","data","references","read","nodes","nodesToRead","Array","isArray","map","n","attributeId","Value","dataValues","write","value","dataType","meta","_getNodeMeta","dt","rankCheck","_validateRankAndShape","ok","error","variant","_coerceVariant","statusCode","writeSingleNode","scStr","name","String","includes","_inferDataTypeForNode","dv","dtNodeId","namespace","valDV","vt","undefined","has","get","toRead","ValueRank","ArrayDimensions","dtDV","rankDV","dimsDV","valueRank","arrayDimensions","set","rank","length","fixedDims","every","d","val","Boolean","Int16","Int32","Int64","UInt16","UInt32","UInt64","Float","Double","DateTime","ByteString","first","isInteger","arrayType","coercedArr","v","_coerceJs","toTyped","arr","Int16Array","from","Int32Array","BigInt64Array","x","BigInt","Math","trunc","Uint16Array","Uint32Array","BigUint64Array","Float32Array","Float64Array","typed","coerced","toLowerCase","isFinite","module","exports"],"sources":["opcua_handler.js"],"sourcesContent":["// server/handlers/opcua_handler.js\r\nconst { OPCUAClient, AttributeIds, MessageSecurityMode, SecurityPolicy, Variant, VariantArrayType, DataType } = require('node-opcua');\r\n\r\nclass OPCUAHandler {\r\n  constructor(connectionId, config = {}) {\r\n    this.connectionId = connectionId;\r\n    this.config = config;\r\n    this.client = null;\r\n    this.session = null;\r\n    this.isConnected = false;\r\n    // Cache of node metadata: { dataType, valueRank, arrayDimensions }\r\n    this._metaCache = new Map();\r\n  }\r\n\r\n  async connect() {\r\n    const endpointUrl = this.config.endpointUrl;\r\n    if (!endpointUrl) throw new Error('OPC UA endpointUrl is required');\r\n\r\n    const client = OPCUAClient.create({\r\n      applicationName: 'Universal Test Client',\r\n      securityMode: MessageSecurityMode.None,\r\n      securityPolicy: SecurityPolicy.None,\r\n      endpointMustExist: false,\r\n      connectionStrategy: { initialDelay: 250, maxRetry: 1 }\r\n    });\r\n\r\n    const timeoutMs = Number(this.config.timeoutMs || 5000);\r\n    const connectPromise = client.connect(endpointUrl);\r\n    const timed = new Promise((_, reject) => setTimeout(() => reject(new Error('OPC UA connect timeout')), timeoutMs));\r\n    await Promise.race([connectPromise, timed]);\r\n\r\n    const session = await client.createSession();\r\n\r\n    this.client = client;\r\n    this.session = session;\r\n    this.isConnected = true;\r\n\r\n    return { success: true };\r\n  }\r\n\r\n  async disconnect() {\r\n    try { if (this.session) await this.session.close(); } catch {}\r\n    try { if (this.client) await this.client.disconnect(); } catch {}\r\n    this.client = null;\r\n    this.session = null;\r\n    this.isConnected = false;\r\n    this._metaCache.clear();\r\n    return { success: true };\r\n  }\r\n\r\n  async browse(nodeId = 'RootFolder') {\r\n    if (!this.session) throw new Error('Not connected');\r\n    const result = await this.session.browse(nodeId);\r\n    return { success: true, data: result.references || [] };\r\n  }\r\n\r\n  async read(nodes) {\r\n    if (!this.session) throw new Error('Not connected');\r\n    const nodesToRead = (Array.isArray(nodes) ? nodes : [nodes]).map((n) => ({ nodeId: n, attributeId: AttributeIds.Value }));\r\n    const dataValues = await this.session.read(nodesToRead);\r\n    return { success: true, data: dataValues };\r\n  }\r\n\r\n  async write(nodeId, value, dataType = null) {\r\n    if (!this.session) throw new Error('Not connected');\r\n    if (!nodeId) throw new Error('nodeId is required');\r\n\r\n    // Fetch and cache node meta (datatype, valueRank, arrayDimensions)\r\n    const meta = await this._getNodeMeta(nodeId);\r\n\r\n    // Choose dataType: explicit > meta-inferred > heuristic\r\n    let dt = dataType ?? meta?.dataType;\r\n\r\n    // Validate rank/shape before coercion/write\r\n    const rankCheck = this._validateRankAndShape(value, meta);\r\n    if (!rankCheck.ok) {\r\n      return { success: false, error: rankCheck.error };\r\n    }\r\n\r\n    const variant = this._coerceVariant(value, dt);\r\n    const statusCode = await this.session.writeSingleNode(nodeId, variant);\r\n    const scStr = statusCode?.name || String(statusCode || '');\r\n    const ok = !!statusCode && (statusCode.value === 0 || scStr.includes('Good'));\r\n    return { success: ok, statusCode: scStr };\r\n  }\r\n\r\n  async _inferDataTypeForNode(nodeId) {\r\n    const dv = await this.session.read({ nodeId, attributeId: AttributeIds.DataType });\r\n    const dtNodeId = dv?.value?.value;\r\n    if (dtNodeId && dtNodeId.namespace === 0 && typeof dtNodeId.value === 'number') {\r\n      return dtNodeId.value;\r\n    }\r\n    // Fallback: read current value's variant to infer dataType\r\n    const valDV = await this.session.read({ nodeId, attributeId: AttributeIds.Value });\r\n    const vt = valDV?.value?.dataType;\r\n    if (typeof vt === 'number') return vt;\r\n    return undefined;\r\n  }\r\n\r\n  async _getNodeMeta(nodeId) {\r\n    if (this._metaCache.has(nodeId)) return this._metaCache.get(nodeId);\r\n    const toRead = [\r\n      { nodeId, attributeId: AttributeIds.DataType },\r\n      { nodeId, attributeId: AttributeIds.ValueRank },\r\n      { nodeId, attributeId: AttributeIds.ArrayDimensions },\r\n    ];\r\n    const [dtDV, rankDV, dimsDV] = await this.session.read(toRead);\r\n    const meta = {\r\n      dataType: (dtDV?.value?.value && dtDV.value.value.namespace === 0) ? dtDV.value.value.value : undefined,\r\n      valueRank: typeof rankDV?.value?.value === 'number' ? rankDV.value.value : -1,\r\n      arrayDimensions: Array.isArray(dimsDV?.value?.value) ? dimsDV.value.value : [],\r\n    };\r\n    this._metaCache.set(nodeId, meta);\r\n    return meta;\r\n  }\r\n\r\n  _validateRankAndShape(value, meta) {\r\n    if (!meta) return { ok: true };\r\n    const rank = meta.valueRank;\r\n    if (rank == null || rank === -1) {\r\n      // Scalar expected\r\n      if (Array.isArray(value)) return { ok: false, error: 'BadTypeMismatch: scalar expected' };\r\n      return { ok: true };\r\n    }\r\n    // Array expected (rank >= 1)\r\n    if (!Array.isArray(value)) return { ok: false, error: 'BadTypeMismatch: array expected' };\r\n    // Validate dimension lengths if provided (zeros mean unspecified)\r\n    if (Array.isArray(meta.arrayDimensions) && meta.arrayDimensions.length > 0) {\r\n      const fixedDims = meta.arrayDimensions.every(d => typeof d === 'number' && d > 0);\r\n      if (fixedDims && meta.arrayDimensions.length === 1) {\r\n        if (value.length !== meta.arrayDimensions[0]) {\r\n          return { ok: false, error: `BadTypeMismatch: expected length ${meta.arrayDimensions[0]}` };\r\n        }\r\n      }\r\n      // For multi-dim arrays, validation would need nested shapes; omitted for now.\r\n    }\r\n    return { ok: true };\r\n  }\r\n\r\n  _coerceVariant(val, dt) {\r\n    // If val is already a Variant, pass through\r\n    if (val && val.dataType !== undefined && val.value !== undefined) {\r\n      return val;\r\n    }\r\n    const map = {\r\n      Boolean: DataType.Boolean,\r\n      Int16: DataType.Int16,\r\n      Int32: DataType.Int32,\r\n      Int64: DataType.Int64,\r\n      UInt16: DataType.UInt16,\r\n      UInt32: DataType.UInt32,\r\n      UInt64: DataType.UInt64,\r\n      Float: DataType.Float,\r\n      Double: DataType.Double,\r\n      String: DataType.String,\r\n      DateTime: DataType.DateTime,\r\n      ByteString: DataType.ByteString,\r\n    };\r\n    let dataType = dt && map[dt] !== undefined ? map[dt] : undefined;\r\n\r\n    // Infer when not provided\r\n    if (dataType === undefined) {\r\n      if (Array.isArray(val)) {\r\n        // Infer from first element\r\n        const first = val[0];\r\n        if (typeof first === 'number') dataType = Number.isInteger(first) ? DataType.Int32 : DataType.Double;\r\n        else if (typeof first === 'boolean') dataType = DataType.Boolean;\r\n        else dataType = DataType.String;\r\n        return new Variant({ dataType, arrayType: VariantArrayType.Array, value: val });\r\n      }\r\n      switch (typeof val) {\r\n        case 'number':\r\n          dataType = Number.isInteger(val) ? DataType.Int32 : DataType.Double; break;\r\n        case 'boolean':\r\n          dataType = DataType.Boolean; break;\r\n        case 'string':\r\n          dataType = DataType.String; break;\r\n        default:\r\n          // Fallback to String\r\n          dataType = DataType.String;\r\n      }\r\n      return new Variant({ dataType, value: val });\r\n    }\r\n\r\n    // Respect explicit dataType, support arrays with element coercion\r\n    if (Array.isArray(val)) {\r\n      const coercedArr = val.map(v => this._coerceJs(v, dataType));\r\n      // For numeric array types, use TypedArrays to satisfy node-opcua encoders\r\n      const toTyped = (arr, dt) => {\r\n        switch (dt) {\r\n          case DataType.Int16: return Int16Array.from(arr);\r\n          case DataType.Int32: return Int32Array.from(arr);\r\n          case DataType.Int64: return BigInt64Array.from(arr.map(x => BigInt(Math.trunc(x))));\r\n          case DataType.UInt16: return Uint16Array.from(arr);\r\n          case DataType.UInt32: return Uint32Array.from(arr);\r\n          case DataType.UInt64: return BigUint64Array.from(arr.map(x => BigInt(Math.trunc(x))));\r\n          case DataType.Float: return Float32Array.from(arr);\r\n          case DataType.Double: return Float64Array.from(arr);\r\n          default: return arr;\r\n        }\r\n      };\r\n      const typed = toTyped(coercedArr, dataType);\r\n      return new Variant({ dataType, arrayType: VariantArrayType.Array, value: typed });\r\n    }\r\n    const coerced = this._coerceJs(val, dataType);\r\n    return new Variant({ dataType, value: coerced });\r\n  }\r\n\r\n  _coerceJs(val, dataType) {\r\n    // If dataType is a numeric built-in id (0..n), map it to enum constant\r\n    if (typeof dataType === 'number') {\r\n      // dataType already numeric; fall-through\r\n    }\r\n    switch (dataType) {\r\n      case DataType.Boolean:\r\n        if (typeof val === 'string') return val.toLowerCase() === 'true';\r\n        return Boolean(val);\r\n      case DataType.Int16:\r\n      case DataType.Int32:\r\n      case DataType.Int64:\r\n      case DataType.UInt16:\r\n      case DataType.UInt32:\r\n      case DataType.UInt64:\r\n        if (typeof val === 'string') {\r\n          const n = Number(val);\r\n          return Number.isFinite(n) ? Math.trunc(n) : val;\r\n        }\r\n        return Math.trunc(val);\r\n      case DataType.Float:\r\n      case DataType.Double:\r\n        if (typeof val === 'string') {\r\n          const n = Number(val);\r\n          return Number.isFinite(n) ? n : val;\r\n        }\r\n        return Number(val);\r\n      case DataType.String:\r\n        return String(val);\r\n      default:\r\n        return val;\r\n    }\r\n  }\r\n}\r\n\r\nmodule.exports = OPCUAHandler;"],"mappings":"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","ignoreList":[]}