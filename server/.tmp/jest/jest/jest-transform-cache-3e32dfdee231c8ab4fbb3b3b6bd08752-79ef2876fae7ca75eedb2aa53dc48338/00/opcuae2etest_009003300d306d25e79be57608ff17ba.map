{"version":3,"names":["OPCUAServer","Variant","DataType","StatusCodes","require","net","path","fs","os","request","jest","setTimeout","getFreePort","Promise","resolve","reject","srv","createServer","listen","port","address","close","on","tmpDir","mkdtempSync","join","tmpdir","process","env","CONNECTION_DATA_DIR","PERSISTENCE","PORT","WS_PORT","startServers","uaServer","uaEndpoint","started","api","beforeAll","hostname","alternateHostname","buildInfo","productName","buildNumber","buildDate","Date","initialize","addressSpace","engine","namespace","getOwnNamespace","device","addObject","organizedBy","rootFolder","objects","browseName","counter","addVariable","componentOf","nodeId","dataType","accessLevel","userAccessLevel","minimumSamplingInterval","value","get","Int32","set","variant","Good","start","afterAll","server","wsServer","shutdown","test","create","post","send","name","type","config","endpointUrl","expect","body","success","toBe","id","connection","con","connectionId","browse","operation","params","Array","isArray","data","length","toBeGreaterThan","list","conn","connections","find","c","toBeTruthy","write","readBack","nodes","dv","read"],"sources":["opcua.e2e.test.js"],"sourcesContent":["const { OPCUAServer, Variant, DataType, StatusCodes } = require('node-opcua');\r\nconst net = require('net');\r\nconst path = require('path');\r\nconst fs = require('fs');\r\nconst os = require('os');\r\nconst request = require('supertest');\r\n\r\njest.setTimeout(60000);\r\n\r\nfunction getFreePort() {\r\n  return new Promise((resolve, reject) => {\r\n    const srv = net.createServer();\r\n    srv.listen(0, '127.0.0.1', () => {\r\n      const { port } = srv.address();\r\n      srv.close(() => resolve(port));\r\n    });\r\n    srv.on('error', reject);\r\n  });\r\n}\r\n\r\n// Use isolated data dir and dedicated ports for this suite\r\nconst tmpDir = fs.mkdtempSync(path.join(os.tmpdir(), 'unicon-opcua-'));\r\nprocess.env.CONNECTION_DATA_DIR = tmpDir;\r\nprocess.env.PERSISTENCE = 'file';\r\nprocess.env.PORT = '3104';\r\nprocess.env.WS_PORT = '8184';\r\n\r\nconst { startServers } = require('../universal-server');\r\n\r\nlet uaServer; let uaEndpoint; let started; let api;\r\n\r\nbeforeAll(async () => {\r\n  const port = await getFreePort();\r\n  uaServer = new OPCUAServer({\r\n    port,\r\n    hostname: '127.0.0.1',\r\n    alternateHostname: ['127.0.0.1','localhost'],\r\n    buildInfo: { productName: 'UniconTestOPCUA', buildNumber: '1', buildDate: new Date() },\r\n  });\r\n  await uaServer.initialize();\r\n  // Optional: create a custom variable\r\n  const addressSpace = uaServer.engine.addressSpace;\r\n  const namespace = addressSpace.getOwnNamespace();\r\n  const device = namespace.addObject({\r\n    organizedBy: addressSpace.rootFolder.objects,\r\n    browseName: 'TestDevice',\r\n  });\r\n  let counter = 42;\r\n  namespace.addVariable({\r\n    componentOf: device,\r\n    browseName: 'Counter',\r\n    nodeId: 'ns=1;s=Counter',\r\n    dataType: 'Int32',\r\n    accessLevel: 'CurrentRead | CurrentWrite',\r\n    userAccessLevel: 'CurrentRead | CurrentWrite',\r\n    minimumSamplingInterval: 100,\r\n    value: {\r\n      get: () => new Variant({ dataType: DataType.Int32, value: counter }),\r\n      set: (variant) => {\r\n        counter = variant.value;\r\n        return StatusCodes.Good;\r\n      }\r\n    },\r\n    minimumSamplingInterval: 100\r\n  });\r\n\r\n  await uaServer.start();\r\n  uaEndpoint = `opc.tcp://127.0.0.1:${port}`;\r\n\r\n  started = await startServers();\r\n  api = request(`http://localhost:${process.env.PORT}`);\r\n});\r\n\r\nafterAll(async () => {\r\n  if (started?.server) started.server.close();\r\n  if (started?.wsServer) started.wsServer.close();\r\n  if (uaServer) await uaServer.shutdown(1000);\r\n});\r\n\r\ntest('OPC UA: connect and browse RootFolder', async () => {\r\n  // Create connection\r\n  const create = await api.post('/unicon/api/connections').send({\r\n    name: 'opcua-local',\r\n    type: 'opcua',\r\n    config: { endpointUrl: uaEndpoint }\r\n  });\r\n  expect(create.body.success).toBe(true);\r\n  const id = create.body.connection.id;\r\n\r\n  // Connect\r\n  const con = await api.post('/unicon/api/connect').send({ connectionId: id });\r\n  expect(con.body.success).toBe(true);\r\n\r\n  // Browse\r\n  const browse = await api.post('/unicon/api/operation').send({\r\n    connectionId: id,\r\n    operation: 'browse',\r\n    params: { nodeId: 'RootFolder' }\r\n  });\r\n  expect(browse.body.success).toBe(true);\r\n  expect(Array.isArray(browse.body.data)).toBe(true);\r\n  expect(browse.body.data.length).toBeGreaterThan(0);\r\n});\r\n\r\ntest('OPC UA: write/read custom variable', async () => {\r\n  const list = await api.get('/unicon/api/connections');\r\n  const conn = list.body.connections.find(c => c.type === 'opcua');\r\n  expect(conn).toBeTruthy();\r\n\r\n  // Write a new value\r\n  const write = await api.post('/unicon/api/operation').send({\r\n    connectionId: conn.id,\r\n    operation: 'write',\r\n    params: { nodeId: 'ns=1;s=Counter', value: 99, dataType: 'Int32' }\r\n  });\r\n  expect(write.body.success).toBe(true);\r\n\r\n  // Read it back\r\n  const readBack = await api.post('/unicon/api/operation').send({\r\n    connectionId: conn.id,\r\n    operation: 'read',\r\n    params: { nodes: ['ns=1;s=Counter'] }\r\n  });\r\n  expect(readBack.body.success).toBe(true);\r\n  expect(Array.isArray(readBack.body.data)).toBe(true);\r\n  const dv = readBack.body.data[0];\r\n  expect(typeof dv.value?.value === 'number').toBe(true);\r\n});\r\n\r\ntest('OPC UA: read standard node ServerStatus.CurrentTime', async () => {\r\n  const list = await api.get('/unicon/api/connections');\r\n  const conn = list.body.connections.find(c => c.type === 'opcua');\r\n  expect(conn).toBeTruthy();\r\n\r\n  const read = await api.post('/unicon/api/operation').send({\r\n    connectionId: conn.id,\r\n    operation: 'read',\r\n    params: { nodes: ['ns=0;i=2258'] }\r\n  });\r\n  expect(read.body.success).toBe(true);\r\n  expect(Array.isArray(read.body.data)).toBe(true);\r\n  expect(read.body.data.length).toBe(1);\r\n});"],"mappings":"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","ignoreList":[]}