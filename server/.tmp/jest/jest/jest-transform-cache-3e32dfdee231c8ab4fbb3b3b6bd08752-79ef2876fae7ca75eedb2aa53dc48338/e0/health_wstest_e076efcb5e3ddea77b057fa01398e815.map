{"version":3,"names":["request","require","WebSocket","startServers","buildState","srv","baseUrl","beforeAll","process","env","PORT","WS_PORT","afterAll","done","server","close","e","test","res","get","expect","status","toBe","body","success","echoPort","echoServer","Server","port","on","ws","msg","send","appWsUrl","broadcastClient","conRes","post","name","type","config","url","set","connectionId","connection","id","connRes","Promise","resolve","reject","timer","setTimeout","Error","once","clearTimeout","expected","receive","raw","JSON","parse","toString","data","event","_","sendRes","operation","params","message","echoed"],"sources":["health_ws.test.js"],"sourcesContent":["const request = require('supertest');\r\nconst WebSocket = require('ws');\r\nconst { startServers, buildState } = require('..');\r\n\r\nlet srv;\r\nlet baseUrl;\r\n\r\nbeforeAll(() => {\r\n  // Use ports from package.json test script or defaults\r\n  process.env.PORT = process.env.PORT || '3101';\r\n  process.env.WS_PORT = process.env.WS_PORT || '8180';\r\n  srv = startServers(buildState());\r\n  baseUrl = `http://127.0.0.1:${process.env.PORT}`;\r\n});\r\n\r\nafterAll((done) => {\r\n  try {\r\n    srv.server.close(() => done());\r\n  } catch (e) {\r\n    done();\r\n  }\r\n});\r\n\r\ntest('GET /unicon/api/health returns success', async () => {\r\n  const res = await request(baseUrl).get('/unicon/api/health');\r\n  expect(res.status).toBe(200);\r\n  expect(res.body.success).toBe(true);\r\n});\r\n\r\ntest('WebSocket connector can send and receive (via broadcast)', async () => {\r\n  // Start a local echo WebSocket server\r\n  const echoPort = 9099;\r\n  const echoServer = new WebSocket.Server({ port: echoPort });\r\n  echoServer.on('connection', (ws) => ws.on('message', (msg) => ws.send(msg)));\r\n\r\n  // Subscribe to appâ€™s broadcast WS to capture messages from connector\r\n  const appWsUrl = `ws://127.0.0.1:${process.env.WS_PORT}`;\r\n  const broadcastClient = new WebSocket(appWsUrl);\r\n\r\n  // Create a websocket connection entry\r\n  const conRes = await request(baseUrl)\r\n    .post('/unicon/api/connections')\r\n    .send({ name: 'ws-echo', type: 'websocket', config: { url: `ws://127.0.0.1:${echoPort}` } })\r\n    .set('Content-Type', 'application/json');\r\n  expect(conRes.status).toBe(200);\r\n  const connectionId = conRes.body.connection.id;\r\n\r\n  // Connect it\r\n  const connRes = await request(baseUrl)\r\n    .post('/unicon/api/connect')\r\n    .send({ connectionId })\r\n    .set('Content-Type', 'application/json');\r\n  expect(connRes.status).toBe(200);\r\n\r\n  // Wait for broadcast open, then send and await echo\r\n  await new Promise((resolve, reject) => {\r\n    const timer = setTimeout(() => reject(new Error('broadcast ws open timeout')), 5000);\r\n    broadcastClient.once('open', () => { clearTimeout(timer); resolve(); });\r\n  });\r\n\r\n  const expected = 'hello-ws';\r\n  const receive = new Promise((resolve, reject) => {\r\n    const timer = setTimeout(() => reject(new Error('echo not received')), 8000);\r\n    broadcastClient.on('message', (raw) => {\r\n      try {\r\n        const msg = JSON.parse(raw.toString());\r\n        if (msg?.type === 'ws' && msg?.data?.event === 'message' && msg?.data?.connectionId === connectionId) {\r\n          clearTimeout(timer);\r\n          resolve(msg.data.data);\r\n        }\r\n      } catch (_) {}\r\n    });\r\n  });\r\n\r\n  const sendRes = await request(baseUrl)\r\n    .post('/unicon/api/operation')\r\n    .send({ connectionId, operation: 'send', params: { message: expected } })\r\n    .set('Content-Type', 'application/json');\r\n  expect(sendRes.status).toBe(200);\r\n\r\n  const echoed = await receive;\r\n  expect(echoed).toBe(expected);\r\n\r\n  // Cleanup\r\n  broadcastClient.close();\r\n  echoServer.close();\r\n});\r\n"],"mappings":"AAAA,MAAMA,OAAO,GAAGC,OAAO,CAAC,WAAW,CAAC;AACpC,MAAMC,SAAS,GAAGD,OAAO,CAAC,IAAI,CAAC;AAC/B,MAAM;EAAEE,YAAY;EAAEC;AAAW,CAAC,GAAGH,OAAO,CAAC,IAAI,CAAC;AAElD,IAAII,GAAG;AACP,IAAIC,OAAO;AAEXC,SAAS,CAAC,MAAM;EACd;EACAC,OAAO,CAACC,GAAG,CAACC,IAAI,GAAGF,OAAO,CAACC,GAAG,CAACC,IAAI,IAAI,MAAM;EAC7CF,OAAO,CAACC,GAAG,CAACE,OAAO,GAAGH,OAAO,CAACC,GAAG,CAACE,OAAO,IAAI,MAAM;EACnDN,GAAG,GAAGF,YAAY,CAACC,UAAU,CAAC,CAAC,CAAC;EAChCE,OAAO,GAAG,oBAAoBE,OAAO,CAACC,GAAG,CAACC,IAAI,EAAE;AAClD,CAAC,CAAC;AAEFE,QAAQ,CAAEC,IAAI,IAAK;EACjB,IAAI;IACFR,GAAG,CAACS,MAAM,CAACC,KAAK,CAAC,MAAMF,IAAI,CAAC,CAAC,CAAC;EAChC,CAAC,CAAC,OAAOG,CAAC,EAAE;IACVH,IAAI,CAAC,CAAC;EACR;AACF,CAAC,CAAC;AAEFI,IAAI,CAAC,wCAAwC,EAAE,YAAY;EACzD,MAAMC,GAAG,GAAG,MAAMlB,OAAO,CAACM,OAAO,CAAC,CAACa,GAAG,CAAC,oBAAoB,CAAC;EAC5DC,MAAM,CAACF,GAAG,CAACG,MAAM,CAAC,CAACC,IAAI,CAAC,GAAG,CAAC;EAC5BF,MAAM,CAACF,GAAG,CAACK,IAAI,CAACC,OAAO,CAAC,CAACF,IAAI,CAAC,IAAI,CAAC;AACrC,CAAC,CAAC;AAEFL,IAAI,CAAC,0DAA0D,EAAE,YAAY;EAC3E;EACA,MAAMQ,QAAQ,GAAG,IAAI;EACrB,MAAMC,UAAU,GAAG,IAAIxB,SAAS,CAACyB,MAAM,CAAC;IAAEC,IAAI,EAAEH;EAAS,CAAC,CAAC;EAC3DC,UAAU,CAACG,EAAE,CAAC,YAAY,EAAGC,EAAE,IAAKA,EAAE,CAACD,EAAE,CAAC,SAAS,EAAGE,GAAG,IAAKD,EAAE,CAACE,IAAI,CAACD,GAAG,CAAC,CAAC,CAAC;;EAE5E;EACA,MAAME,QAAQ,GAAG,kBAAkBzB,OAAO,CAACC,GAAG,CAACE,OAAO,EAAE;EACxD,MAAMuB,eAAe,GAAG,IAAIhC,SAAS,CAAC+B,QAAQ,CAAC;;EAE/C;EACA,MAAME,MAAM,GAAG,MAAMnC,OAAO,CAACM,OAAO,CAAC,CAClC8B,IAAI,CAAC,yBAAyB,CAAC,CAC/BJ,IAAI,CAAC;IAAEK,IAAI,EAAE,SAAS;IAAEC,IAAI,EAAE,WAAW;IAAEC,MAAM,EAAE;MAAEC,GAAG,EAAE,kBAAkBf,QAAQ;IAAG;EAAE,CAAC,CAAC,CAC3FgB,GAAG,CAAC,cAAc,EAAE,kBAAkB,CAAC;EAC1CrB,MAAM,CAACe,MAAM,CAACd,MAAM,CAAC,CAACC,IAAI,CAAC,GAAG,CAAC;EAC/B,MAAMoB,YAAY,GAAGP,MAAM,CAACZ,IAAI,CAACoB,UAAU,CAACC,EAAE;;EAE9C;EACA,MAAMC,OAAO,GAAG,MAAM7C,OAAO,CAACM,OAAO,CAAC,CACnC8B,IAAI,CAAC,qBAAqB,CAAC,CAC3BJ,IAAI,CAAC;IAAEU;EAAa,CAAC,CAAC,CACtBD,GAAG,CAAC,cAAc,EAAE,kBAAkB,CAAC;EAC1CrB,MAAM,CAACyB,OAAO,CAACxB,MAAM,CAAC,CAACC,IAAI,CAAC,GAAG,CAAC;;EAEhC;EACA,MAAM,IAAIwB,OAAO,CAAC,CAACC,OAAO,EAAEC,MAAM,KAAK;IACrC,MAAMC,KAAK,GAAGC,UAAU,CAAC,MAAMF,MAAM,CAAC,IAAIG,KAAK,CAAC,2BAA2B,CAAC,CAAC,EAAE,IAAI,CAAC;IACpFjB,eAAe,CAACkB,IAAI,CAAC,MAAM,EAAE,MAAM;MAAEC,YAAY,CAACJ,KAAK,CAAC;MAAEF,OAAO,CAAC,CAAC;IAAE,CAAC,CAAC;EACzE,CAAC,CAAC;EAEF,MAAMO,QAAQ,GAAG,UAAU;EAC3B,MAAMC,OAAO,GAAG,IAAIT,OAAO,CAAC,CAACC,OAAO,EAAEC,MAAM,KAAK;IAC/C,MAAMC,KAAK,GAAGC,UAAU,CAAC,MAAMF,MAAM,CAAC,IAAIG,KAAK,CAAC,mBAAmB,CAAC,CAAC,EAAE,IAAI,CAAC;IAC5EjB,eAAe,CAACL,EAAE,CAAC,SAAS,EAAG2B,GAAG,IAAK;MACrC,IAAI;QACF,MAAMzB,GAAG,GAAG0B,IAAI,CAACC,KAAK,CAACF,GAAG,CAACG,QAAQ,CAAC,CAAC,CAAC;QACtC,IAAI5B,GAAG,EAAEO,IAAI,KAAK,IAAI,IAAIP,GAAG,EAAE6B,IAAI,EAAEC,KAAK,KAAK,SAAS,IAAI9B,GAAG,EAAE6B,IAAI,EAAElB,YAAY,KAAKA,YAAY,EAAE;UACpGW,YAAY,CAACJ,KAAK,CAAC;UACnBF,OAAO,CAAChB,GAAG,CAAC6B,IAAI,CAACA,IAAI,CAAC;QACxB;MACF,CAAC,CAAC,OAAOE,CAAC,EAAE,CAAC;IACf,CAAC,CAAC;EACJ,CAAC,CAAC;EAEF,MAAMC,OAAO,GAAG,MAAM/D,OAAO,CAACM,OAAO,CAAC,CACnC8B,IAAI,CAAC,uBAAuB,CAAC,CAC7BJ,IAAI,CAAC;IAAEU,YAAY;IAAEsB,SAAS,EAAE,MAAM;IAAEC,MAAM,EAAE;MAAEC,OAAO,EAAEZ;IAAS;EAAE,CAAC,CAAC,CACxEb,GAAG,CAAC,cAAc,EAAE,kBAAkB,CAAC;EAC1CrB,MAAM,CAAC2C,OAAO,CAAC1C,MAAM,CAAC,CAACC,IAAI,CAAC,GAAG,CAAC;EAEhC,MAAM6C,MAAM,GAAG,MAAMZ,OAAO;EAC5BnC,MAAM,CAAC+C,MAAM,CAAC,CAAC7C,IAAI,CAACgC,QAAQ,CAAC;;EAE7B;EACApB,eAAe,CAACnB,KAAK,CAAC,CAAC;EACvBW,UAAU,CAACX,KAAK,CAAC,CAAC;AACpB,CAAC,CAAC","ignoreList":[]}