d1dcf1011b416ca1b71fa61a2c29cee7
// server/handlers/ws_handler.js
const WebSocket = require('ws');
class WSHandler {
  constructor(connectionId, config) {
    this.connectionId = connectionId;
    this.config = config || {};
    this.client = null; // WebSocket client to remote endpoint
    this.isConnected = false;
  }
  async connect() {
    const url = this.config.url;
    if (!url) throw new Error('WebSocket URL missing in config');
    return new Promise((resolve, reject) => {
      const ws = new WebSocket(url, this.config.protocol || undefined);
      this.client = ws;
      ws.on('open', () => {
        this.isConnected = true;
        this._broadcast({
          type: 'ws',
          data: {
            event: 'connected',
            connectionId: this.connectionId
          }
        });
        resolve({
          success: true
        });
      });
      ws.on('message', data => {
        this._broadcast({
          type: 'ws',
          data: {
            event: 'message',
            connectionId: this.connectionId,
            data: data.toString()
          }
        });
      });
      ws.on('close', (code, reason) => {
        this.isConnected = false;
        this._broadcast({
          type: 'ws',
          data: {
            event: 'closed',
            connectionId: this.connectionId,
            code,
            reason: reason?.toString()
          }
        });
      });
      ws.on('error', err => {
        if (!this.isConnected) reject(new Error(`WS connect error: ${err.message}`));
        this._broadcast({
          type: 'ws',
          data: {
            event: 'error',
            connectionId: this.connectionId,
            error: err.message
          }
        });
      });
    });
  }
  async disconnect() {
    if (this.client && this.client.readyState === WebSocket.OPEN) {
      this.client.close();
    }
    this.isConnected = false;
    return {
      success: true
    };
  }
  async send(message) {
    if (!this.client || this.client.readyState !== WebSocket.OPEN) throw new Error('WS not connected');
    this.client.send(typeof message === 'string' ? message : JSON.stringify(message));
    return {
      success: true
    };
  }
  _broadcast(message) {
    if (global.broadcast) global.broadcast(message);
  }
}
module.exports = WSHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJXZWJTb2NrZXQiLCJyZXF1aXJlIiwiV1NIYW5kbGVyIiwiY29uc3RydWN0b3IiLCJjb25uZWN0aW9uSWQiLCJjb25maWciLCJjbGllbnQiLCJpc0Nvbm5lY3RlZCIsImNvbm5lY3QiLCJ1cmwiLCJFcnJvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0Iiwid3MiLCJwcm90b2NvbCIsInVuZGVmaW5lZCIsIm9uIiwiX2Jyb2FkY2FzdCIsInR5cGUiLCJkYXRhIiwiZXZlbnQiLCJzdWNjZXNzIiwidG9TdHJpbmciLCJjb2RlIiwicmVhc29uIiwiZXJyIiwibWVzc2FnZSIsImVycm9yIiwiZGlzY29ubmVjdCIsInJlYWR5U3RhdGUiLCJPUEVOIiwiY2xvc2UiLCJzZW5kIiwiSlNPTiIsInN0cmluZ2lmeSIsImdsb2JhbCIsImJyb2FkY2FzdCIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyJ3c19oYW5kbGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHNlcnZlci9oYW5kbGVycy93c19oYW5kbGVyLmpzXHJcbmNvbnN0IFdlYlNvY2tldCA9IHJlcXVpcmUoJ3dzJyk7XHJcblxyXG5jbGFzcyBXU0hhbmRsZXIge1xyXG4gIGNvbnN0cnVjdG9yKGNvbm5lY3Rpb25JZCwgY29uZmlnKSB7XHJcbiAgICB0aGlzLmNvbm5lY3Rpb25JZCA9IGNvbm5lY3Rpb25JZDtcclxuICAgIHRoaXMuY29uZmlnID0gY29uZmlnIHx8IHt9O1xyXG4gICAgdGhpcy5jbGllbnQgPSBudWxsOyAvLyBXZWJTb2NrZXQgY2xpZW50IHRvIHJlbW90ZSBlbmRwb2ludFxyXG4gICAgdGhpcy5pc0Nvbm5lY3RlZCA9IGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgY29ubmVjdCgpIHtcclxuICAgIGNvbnN0IHVybCA9IHRoaXMuY29uZmlnLnVybDtcclxuICAgIGlmICghdXJsKSB0aHJvdyBuZXcgRXJyb3IoJ1dlYlNvY2tldCBVUkwgbWlzc2luZyBpbiBjb25maWcnKTtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGNvbnN0IHdzID0gbmV3IFdlYlNvY2tldCh1cmwsIHRoaXMuY29uZmlnLnByb3RvY29sIHx8IHVuZGVmaW5lZCk7XHJcbiAgICAgIHRoaXMuY2xpZW50ID0gd3M7XHJcblxyXG4gICAgICB3cy5vbignb3BlbicsICgpID0+IHtcclxuICAgICAgICB0aGlzLmlzQ29ubmVjdGVkID0gdHJ1ZTtcclxuICAgICAgICB0aGlzLl9icm9hZGNhc3QoeyB0eXBlOiAnd3MnLCBkYXRhOiB7IGV2ZW50OiAnY29ubmVjdGVkJywgY29ubmVjdGlvbklkOiB0aGlzLmNvbm5lY3Rpb25JZCB9IH0pO1xyXG4gICAgICAgIHJlc29sdmUoeyBzdWNjZXNzOiB0cnVlIH0pO1xyXG4gICAgICB9KTtcclxuICAgICAgd3Mub24oJ21lc3NhZ2UnLCAoZGF0YSkgPT4ge1xyXG4gICAgICAgIHRoaXMuX2Jyb2FkY2FzdCh7IHR5cGU6ICd3cycsIGRhdGE6IHsgZXZlbnQ6ICdtZXNzYWdlJywgY29ubmVjdGlvbklkOiB0aGlzLmNvbm5lY3Rpb25JZCwgZGF0YTogZGF0YS50b1N0cmluZygpIH0gfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgICB3cy5vbignY2xvc2UnLCAoY29kZSwgcmVhc29uKSA9PiB7XHJcbiAgICAgICAgdGhpcy5pc0Nvbm5lY3RlZCA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMuX2Jyb2FkY2FzdCh7IHR5cGU6ICd3cycsIGRhdGE6IHsgZXZlbnQ6ICdjbG9zZWQnLCBjb25uZWN0aW9uSWQ6IHRoaXMuY29ubmVjdGlvbklkLCBjb2RlLCByZWFzb246IHJlYXNvbj8udG9TdHJpbmcoKSB9IH0pO1xyXG4gICAgICB9KTtcclxuICAgICAgd3Mub24oJ2Vycm9yJywgKGVycikgPT4ge1xyXG4gICAgICAgIGlmICghdGhpcy5pc0Nvbm5lY3RlZCkgcmVqZWN0KG5ldyBFcnJvcihgV1MgY29ubmVjdCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKSk7XHJcbiAgICAgICAgdGhpcy5fYnJvYWRjYXN0KHsgdHlwZTogJ3dzJywgZGF0YTogeyBldmVudDogJ2Vycm9yJywgY29ubmVjdGlvbklkOiB0aGlzLmNvbm5lY3Rpb25JZCwgZXJyb3I6IGVyci5tZXNzYWdlIH0gfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBkaXNjb25uZWN0KCkge1xyXG4gICAgaWYgKHRoaXMuY2xpZW50ICYmIHRoaXMuY2xpZW50LnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5PUEVOKSB7XHJcbiAgICAgIHRoaXMuY2xpZW50LmNsb3NlKCk7XHJcbiAgICB9XHJcbiAgICB0aGlzLmlzQ29ubmVjdGVkID0gZmFsc2U7XHJcbiAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07XHJcbiAgfVxyXG5cclxuICBhc3luYyBzZW5kKG1lc3NhZ2UpIHtcclxuICAgIGlmICghdGhpcy5jbGllbnQgfHwgdGhpcy5jbGllbnQucmVhZHlTdGF0ZSAhPT0gV2ViU29ja2V0Lk9QRU4pIHRocm93IG5ldyBFcnJvcignV1Mgbm90IGNvbm5lY3RlZCcpO1xyXG4gICAgdGhpcy5jbGllbnQuc2VuZCh0eXBlb2YgbWVzc2FnZSA9PT0gJ3N0cmluZycgPyBtZXNzYWdlIDogSlNPTi5zdHJpbmdpZnkobWVzc2FnZSkpO1xyXG4gICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9O1xyXG4gIH1cclxuXHJcbiAgX2Jyb2FkY2FzdChtZXNzYWdlKSB7XHJcbiAgICBpZiAoZ2xvYmFsLmJyb2FkY2FzdCkgZ2xvYmFsLmJyb2FkY2FzdChtZXNzYWdlKTtcclxuICB9XHJcbn1cclxuXHJcbm1vZHVsZS5leHBvcnRzID0gV1NIYW5kbGVyO1xyXG4iXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0EsTUFBTUEsU0FBUyxHQUFHQyxPQUFPLENBQUMsSUFBSSxDQUFDO0FBRS9CLE1BQU1DLFNBQVMsQ0FBQztFQUNkQyxXQUFXQSxDQUFDQyxZQUFZLEVBQUVDLE1BQU0sRUFBRTtJQUNoQyxJQUFJLENBQUNELFlBQVksR0FBR0EsWUFBWTtJQUNoQyxJQUFJLENBQUNDLE1BQU0sR0FBR0EsTUFBTSxJQUFJLENBQUMsQ0FBQztJQUMxQixJQUFJLENBQUNDLE1BQU0sR0FBRyxJQUFJLENBQUMsQ0FBQztJQUNwQixJQUFJLENBQUNDLFdBQVcsR0FBRyxLQUFLO0VBQzFCO0VBRUEsTUFBTUMsT0FBT0EsQ0FBQSxFQUFHO0lBQ2QsTUFBTUMsR0FBRyxHQUFHLElBQUksQ0FBQ0osTUFBTSxDQUFDSSxHQUFHO0lBQzNCLElBQUksQ0FBQ0EsR0FBRyxFQUFFLE1BQU0sSUFBSUMsS0FBSyxDQUFDLGlDQUFpQyxDQUFDO0lBQzVELE9BQU8sSUFBSUMsT0FBTyxDQUFDLENBQUNDLE9BQU8sRUFBRUMsTUFBTSxLQUFLO01BQ3RDLE1BQU1DLEVBQUUsR0FBRyxJQUFJZCxTQUFTLENBQUNTLEdBQUcsRUFBRSxJQUFJLENBQUNKLE1BQU0sQ0FBQ1UsUUFBUSxJQUFJQyxTQUFTLENBQUM7TUFDaEUsSUFBSSxDQUFDVixNQUFNLEdBQUdRLEVBQUU7TUFFaEJBLEVBQUUsQ0FBQ0csRUFBRSxDQUFDLE1BQU0sRUFBRSxNQUFNO1FBQ2xCLElBQUksQ0FBQ1YsV0FBVyxHQUFHLElBQUk7UUFDdkIsSUFBSSxDQUFDVyxVQUFVLENBQUM7VUFBRUMsSUFBSSxFQUFFLElBQUk7VUFBRUMsSUFBSSxFQUFFO1lBQUVDLEtBQUssRUFBRSxXQUFXO1lBQUVqQixZQUFZLEVBQUUsSUFBSSxDQUFDQTtVQUFhO1FBQUUsQ0FBQyxDQUFDO1FBQzlGUSxPQUFPLENBQUM7VUFBRVUsT0FBTyxFQUFFO1FBQUssQ0FBQyxDQUFDO01BQzVCLENBQUMsQ0FBQztNQUNGUixFQUFFLENBQUNHLEVBQUUsQ0FBQyxTQUFTLEVBQUdHLElBQUksSUFBSztRQUN6QixJQUFJLENBQUNGLFVBQVUsQ0FBQztVQUFFQyxJQUFJLEVBQUUsSUFBSTtVQUFFQyxJQUFJLEVBQUU7WUFBRUMsS0FBSyxFQUFFLFNBQVM7WUFBRWpCLFlBQVksRUFBRSxJQUFJLENBQUNBLFlBQVk7WUFBRWdCLElBQUksRUFBRUEsSUFBSSxDQUFDRyxRQUFRLENBQUM7VUFBRTtRQUFFLENBQUMsQ0FBQztNQUNySCxDQUFDLENBQUM7TUFDRlQsRUFBRSxDQUFDRyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUNPLElBQUksRUFBRUMsTUFBTSxLQUFLO1FBQy9CLElBQUksQ0FBQ2xCLFdBQVcsR0FBRyxLQUFLO1FBQ3hCLElBQUksQ0FBQ1csVUFBVSxDQUFDO1VBQUVDLElBQUksRUFBRSxJQUFJO1VBQUVDLElBQUksRUFBRTtZQUFFQyxLQUFLLEVBQUUsUUFBUTtZQUFFakIsWUFBWSxFQUFFLElBQUksQ0FBQ0EsWUFBWTtZQUFFb0IsSUFBSTtZQUFFQyxNQUFNLEVBQUVBLE1BQU0sRUFBRUYsUUFBUSxDQUFDO1VBQUU7UUFBRSxDQUFDLENBQUM7TUFDL0gsQ0FBQyxDQUFDO01BQ0ZULEVBQUUsQ0FBQ0csRUFBRSxDQUFDLE9BQU8sRUFBR1MsR0FBRyxJQUFLO1FBQ3RCLElBQUksQ0FBQyxJQUFJLENBQUNuQixXQUFXLEVBQUVNLE1BQU0sQ0FBQyxJQUFJSCxLQUFLLENBQUMscUJBQXFCZ0IsR0FBRyxDQUFDQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1FBQzVFLElBQUksQ0FBQ1QsVUFBVSxDQUFDO1VBQUVDLElBQUksRUFBRSxJQUFJO1VBQUVDLElBQUksRUFBRTtZQUFFQyxLQUFLLEVBQUUsT0FBTztZQUFFakIsWUFBWSxFQUFFLElBQUksQ0FBQ0EsWUFBWTtZQUFFd0IsS0FBSyxFQUFFRixHQUFHLENBQUNDO1VBQVE7UUFBRSxDQUFDLENBQUM7TUFDaEgsQ0FBQyxDQUFDO0lBQ0osQ0FBQyxDQUFDO0VBQ0o7RUFFQSxNQUFNRSxVQUFVQSxDQUFBLEVBQUc7SUFDakIsSUFBSSxJQUFJLENBQUN2QixNQUFNLElBQUksSUFBSSxDQUFDQSxNQUFNLENBQUN3QixVQUFVLEtBQUs5QixTQUFTLENBQUMrQixJQUFJLEVBQUU7TUFDNUQsSUFBSSxDQUFDekIsTUFBTSxDQUFDMEIsS0FBSyxDQUFDLENBQUM7SUFDckI7SUFDQSxJQUFJLENBQUN6QixXQUFXLEdBQUcsS0FBSztJQUN4QixPQUFPO01BQUVlLE9BQU8sRUFBRTtJQUFLLENBQUM7RUFDMUI7RUFFQSxNQUFNVyxJQUFJQSxDQUFDTixPQUFPLEVBQUU7SUFDbEIsSUFBSSxDQUFDLElBQUksQ0FBQ3JCLE1BQU0sSUFBSSxJQUFJLENBQUNBLE1BQU0sQ0FBQ3dCLFVBQVUsS0FBSzlCLFNBQVMsQ0FBQytCLElBQUksRUFBRSxNQUFNLElBQUlyQixLQUFLLENBQUMsa0JBQWtCLENBQUM7SUFDbEcsSUFBSSxDQUFDSixNQUFNLENBQUMyQixJQUFJLENBQUMsT0FBT04sT0FBTyxLQUFLLFFBQVEsR0FBR0EsT0FBTyxHQUFHTyxJQUFJLENBQUNDLFNBQVMsQ0FBQ1IsT0FBTyxDQUFDLENBQUM7SUFDakYsT0FBTztNQUFFTCxPQUFPLEVBQUU7SUFBSyxDQUFDO0VBQzFCO0VBRUFKLFVBQVVBLENBQUNTLE9BQU8sRUFBRTtJQUNsQixJQUFJUyxNQUFNLENBQUNDLFNBQVMsRUFBRUQsTUFBTSxDQUFDQyxTQUFTLENBQUNWLE9BQU8sQ0FBQztFQUNqRDtBQUNGO0FBRUFXLE1BQU0sQ0FBQ0MsT0FBTyxHQUFHckMsU0FBUyIsImlnbm9yZUxpc3QiOltdfQ==