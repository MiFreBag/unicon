{"version":3,"names":["WebSocket","require","WSHandler","constructor","connectionId","config","client","isConnected","connect","url","Error","Promise","resolve","reject","ws","protocol","undefined","on","_broadcast","type","data","event","success","toString","code","reason","err","message","error","disconnect","readyState","OPEN","close","send","JSON","stringify","global","broadcast","module","exports"],"sources":["ws_handler.js"],"sourcesContent":["// server/handlers/ws_handler.js\r\nconst WebSocket = require('ws');\r\n\r\nclass WSHandler {\r\n  constructor(connectionId, config) {\r\n    this.connectionId = connectionId;\r\n    this.config = config || {};\r\n    this.client = null; // WebSocket client to remote endpoint\r\n    this.isConnected = false;\r\n  }\r\n\r\n  async connect() {\r\n    const url = this.config.url;\r\n    if (!url) throw new Error('WebSocket URL missing in config');\r\n    return new Promise((resolve, reject) => {\r\n      const ws = new WebSocket(url, this.config.protocol || undefined);\r\n      this.client = ws;\r\n\r\n      ws.on('open', () => {\r\n        this.isConnected = true;\r\n        this._broadcast({ type: 'ws', data: { event: 'connected', connectionId: this.connectionId } });\r\n        resolve({ success: true });\r\n      });\r\n      ws.on('message', (data) => {\r\n        this._broadcast({ type: 'ws', data: { event: 'message', connectionId: this.connectionId, data: data.toString() } });\r\n      });\r\n      ws.on('close', (code, reason) => {\r\n        this.isConnected = false;\r\n        this._broadcast({ type: 'ws', data: { event: 'closed', connectionId: this.connectionId, code, reason: reason?.toString() } });\r\n      });\r\n      ws.on('error', (err) => {\r\n        if (!this.isConnected) reject(new Error(`WS connect error: ${err.message}`));\r\n        this._broadcast({ type: 'ws', data: { event: 'error', connectionId: this.connectionId, error: err.message } });\r\n      });\r\n    });\r\n  }\r\n\r\n  async disconnect() {\r\n    if (this.client && this.client.readyState === WebSocket.OPEN) {\r\n      this.client.close();\r\n    }\r\n    this.isConnected = false;\r\n    return { success: true };\r\n  }\r\n\r\n  async send(message) {\r\n    if (!this.client || this.client.readyState !== WebSocket.OPEN) throw new Error('WS not connected');\r\n    this.client.send(typeof message === 'string' ? message : JSON.stringify(message));\r\n    return { success: true };\r\n  }\r\n\r\n  _broadcast(message) {\r\n    if (global.broadcast) global.broadcast(message);\r\n  }\r\n}\r\n\r\nmodule.exports = WSHandler;\r\n"],"mappings":"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","ignoreList":[]}