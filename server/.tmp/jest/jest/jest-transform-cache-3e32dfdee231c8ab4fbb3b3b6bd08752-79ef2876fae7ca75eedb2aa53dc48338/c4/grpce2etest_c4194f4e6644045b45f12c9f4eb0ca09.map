{"version":3,"names":["grpc","require","protoLoader","path","request","fs","os","jest","setTimeout","tmpDir","mkdtempSync","join","tmpdir","process","env","CONNECTION_DATA_DIR","PERSISTENCE","PORT","WS_PORT","startServers","server","started","api","address","startGrpcServer","protoPath","__dirname","defs","loadPackageDefinition","loadSync","keepCase","longs","String","enums","defaults","oneofs","testPkg","test","svc","Say","call","cb","message","name","s","Server","addService","Echo","service","Promise","resolve","bindAsync","ServerCredentials","createInsecure","err","port","start","beforeAll","afterAll","close","wsServer","forceShutdown","create","post","send","type","config","proto","package","expect","body","success","toBe","id","connection","con","connectionId","op","operation","params","method","data","toEqual"],"sources":["grpc.e2e.test.js"],"sourcesContent":["const grpc = require('@grpc/grpc-js');\r\nconst protoLoader = require('@grpc/proto-loader');\r\nconst path = require('path');\r\nconst request = require('supertest');\r\nconst fs = require('fs');\r\nconst os = require('os');\r\n\r\njest.setTimeout(30000);\r\n\r\nconst tmpDir = fs.mkdtempSync(path.join(os.tmpdir(), 'unicon-grpc-'));\r\nprocess.env.CONNECTION_DATA_DIR = tmpDir;\r\nprocess.env.PERSISTENCE = 'file';\r\nprocess.env.PORT = '3103';\r\nprocess.env.WS_PORT = '8183';\r\n\r\nconst { startServers } = require('../universal-server');\r\n\r\nlet server; let started; let api; let address;\r\n\r\nfunction startGrpcServer() {\r\n  const protoPath = path.join(__dirname, '..', 'proto', 'test.proto');\r\n  const defs = grpc.loadPackageDefinition(protoLoader.loadSync(protoPath, { keepCase: true, longs: String, enums: String, defaults: true, oneofs: true }));\r\n  const testPkg = defs.test;\r\n\r\n  const svc = {\r\n    Say: (call, cb) => cb(null, { message: `Hello ${call.request.name}` })\r\n  };\r\n\r\n  const s = new grpc.Server();\r\n  s.addService(testPkg.Echo.service, svc);\r\n  return new Promise(resolve => {\r\n    s.bindAsync('127.0.0.1:0', grpc.ServerCredentials.createInsecure(), (err, port) => {\r\n      if (err) throw err;\r\n      s.start();\r\n      resolve({ server: s, port });\r\n    });\r\n  });\r\n}\r\n\r\nbeforeAll(async () => {\r\n  const { server: s, port } = await startGrpcServer();\r\n  server = s;\r\n  address = `127.0.0.1:${port}`;\r\n  started = await startServers();\r\n  api = request(`http://localhost:${process.env.PORT}`);\r\n});\r\n\r\nafterAll(() => {\r\n  if (started?.server) started.server.close();\r\n  if (started?.wsServer) started.wsServer.close();\r\n  if (server) server.forceShutdown();\r\n});\r\n\r\ntest('gRPC: connect and unary call via /operation', async () => {\r\n  // write proto if not present\r\n  // (created by repo patch)\r\n  const create = await api.post('/unicon/api/connections').send({\r\n    name: 'grpc-local',\r\n    type: 'grpc',\r\n    config: {\r\n      address,\r\n      proto: 'test.proto',\r\n      package: 'test',\r\n      service: 'Echo'\r\n    }\r\n  });\r\n  expect(create.body.success).toBe(true);\r\n  const id = create.body.connection.id;\r\n\r\n  const con = await api.post('/unicon/api/connect').send({ connectionId: id });\r\n  expect(con.body.success).toBe(true);\r\n\r\n  const op = await api.post('/unicon/api/operation').send({\r\n    connectionId: id,\r\n    operation: 'unary',\r\n    params: { method: 'Say', request: { name: 'World' } }\r\n  });\r\n\r\n  expect(op.body.success).toBe(true);\r\n  expect(op.body.data).toEqual({ message: 'Hello World' });\r\n});"],"mappings":"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","ignoreList":[]}