9a8ab8e801ab9f14496adf87e2836909
const grpc = require('@grpc/grpc-js');
const protoLoader = require('@grpc/proto-loader');
const path = require('path');
const request = require('supertest');
const fs = require('fs');
const os = require('os');
jest.setTimeout(30000);
const tmpDir = fs.mkdtempSync(path.join(os.tmpdir(), 'unicon-grpc-'));
process.env.CONNECTION_DATA_DIR = tmpDir;
process.env.PERSISTENCE = 'file';
process.env.PORT = '3103';
process.env.WS_PORT = '8183';
const {
  startServers
} = require('../universal-server');
let server;
let started;
let api;
let address;
function startGrpcServer() {
  const protoPath = path.join(__dirname, '..', 'proto', 'test.proto');
  const defs = grpc.loadPackageDefinition(protoLoader.loadSync(protoPath, {
    keepCase: true,
    longs: String,
    enums: String,
    defaults: true,
    oneofs: true
  }));
  const testPkg = defs.test;
  const svc = {
    Say: (call, cb) => cb(null, {
      message: `Hello ${call.request.name}`
    })
  };
  const s = new grpc.Server();
  s.addService(testPkg.Echo.service, svc);
  return new Promise(resolve => {
    s.bindAsync('127.0.0.1:0', grpc.ServerCredentials.createInsecure(), (err, port) => {
      if (err) throw err;
      s.start();
      resolve({
        server: s,
        port
      });
    });
  });
}
beforeAll(async () => {
  const {
    server: s,
    port
  } = await startGrpcServer();
  server = s;
  address = `127.0.0.1:${port}`;
  started = await startServers();
  api = request(`http://localhost:${process.env.PORT}`);
});
afterAll(() => {
  if (started?.server) started.server.close();
  if (started?.wsServer) started.wsServer.close();
  if (server) server.forceShutdown();
});
test('gRPC: connect and unary call via /operation', async () => {
  // write proto if not present
  // (created by repo patch)
  const create = await api.post('/unicon/api/connections').send({
    name: 'grpc-local',
    type: 'grpc',
    config: {
      address,
      proto: 'test.proto',
      package: 'test',
      service: 'Echo'
    }
  });
  expect(create.body.success).toBe(true);
  const id = create.body.connection.id;
  const con = await api.post('/unicon/api/connect').send({
    connectionId: id
  });
  expect(con.body.success).toBe(true);
  const op = await api.post('/unicon/api/operation').send({
    connectionId: id,
    operation: 'unary',
    params: {
      method: 'Say',
      request: {
        name: 'World'
      }
    }
  });
  expect(op.body.success).toBe(true);
  expect(op.body.data).toEqual({
    message: 'Hello World'
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJncnBjIiwicmVxdWlyZSIsInByb3RvTG9hZGVyIiwicGF0aCIsInJlcXVlc3QiLCJmcyIsIm9zIiwiamVzdCIsInNldFRpbWVvdXQiLCJ0bXBEaXIiLCJta2R0ZW1wU3luYyIsImpvaW4iLCJ0bXBkaXIiLCJwcm9jZXNzIiwiZW52IiwiQ09OTkVDVElPTl9EQVRBX0RJUiIsIlBFUlNJU1RFTkNFIiwiUE9SVCIsIldTX1BPUlQiLCJzdGFydFNlcnZlcnMiLCJzZXJ2ZXIiLCJzdGFydGVkIiwiYXBpIiwiYWRkcmVzcyIsInN0YXJ0R3JwY1NlcnZlciIsInByb3RvUGF0aCIsIl9fZGlybmFtZSIsImRlZnMiLCJsb2FkUGFja2FnZURlZmluaXRpb24iLCJsb2FkU3luYyIsImtlZXBDYXNlIiwibG9uZ3MiLCJTdHJpbmciLCJlbnVtcyIsImRlZmF1bHRzIiwib25lb2ZzIiwidGVzdFBrZyIsInRlc3QiLCJzdmMiLCJTYXkiLCJjYWxsIiwiY2IiLCJtZXNzYWdlIiwibmFtZSIsInMiLCJTZXJ2ZXIiLCJhZGRTZXJ2aWNlIiwiRWNobyIsInNlcnZpY2UiLCJQcm9taXNlIiwicmVzb2x2ZSIsImJpbmRBc3luYyIsIlNlcnZlckNyZWRlbnRpYWxzIiwiY3JlYXRlSW5zZWN1cmUiLCJlcnIiLCJwb3J0Iiwic3RhcnQiLCJiZWZvcmVBbGwiLCJhZnRlckFsbCIsImNsb3NlIiwid3NTZXJ2ZXIiLCJmb3JjZVNodXRkb3duIiwiY3JlYXRlIiwicG9zdCIsInNlbmQiLCJ0eXBlIiwiY29uZmlnIiwicHJvdG8iLCJwYWNrYWdlIiwiZXhwZWN0IiwiYm9keSIsInN1Y2Nlc3MiLCJ0b0JlIiwiaWQiLCJjb25uZWN0aW9uIiwiY29uIiwiY29ubmVjdGlvbklkIiwib3AiLCJvcGVyYXRpb24iLCJwYXJhbXMiLCJtZXRob2QiLCJkYXRhIiwidG9FcXVhbCJdLCJzb3VyY2VzIjpbImdycGMuZTJlLnRlc3QuanMiXSwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgZ3JwYyA9IHJlcXVpcmUoJ0BncnBjL2dycGMtanMnKTtcclxuY29uc3QgcHJvdG9Mb2FkZXIgPSByZXF1aXJlKCdAZ3JwYy9wcm90by1sb2FkZXInKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxuY29uc3QgcmVxdWVzdCA9IHJlcXVpcmUoJ3N1cGVydGVzdCcpO1xyXG5jb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XHJcbmNvbnN0IG9zID0gcmVxdWlyZSgnb3MnKTtcclxuXHJcbmplc3Quc2V0VGltZW91dCgzMDAwMCk7XHJcblxyXG5jb25zdCB0bXBEaXIgPSBmcy5ta2R0ZW1wU3luYyhwYXRoLmpvaW4ob3MudG1wZGlyKCksICd1bmljb24tZ3JwYy0nKSk7XHJcbnByb2Nlc3MuZW52LkNPTk5FQ1RJT05fREFUQV9ESVIgPSB0bXBEaXI7XHJcbnByb2Nlc3MuZW52LlBFUlNJU1RFTkNFID0gJ2ZpbGUnO1xyXG5wcm9jZXNzLmVudi5QT1JUID0gJzMxMDMnO1xyXG5wcm9jZXNzLmVudi5XU19QT1JUID0gJzgxODMnO1xyXG5cclxuY29uc3QgeyBzdGFydFNlcnZlcnMgfSA9IHJlcXVpcmUoJy4uL3VuaXZlcnNhbC1zZXJ2ZXInKTtcclxuXHJcbmxldCBzZXJ2ZXI7IGxldCBzdGFydGVkOyBsZXQgYXBpOyBsZXQgYWRkcmVzcztcclxuXHJcbmZ1bmN0aW9uIHN0YXJ0R3JwY1NlcnZlcigpIHtcclxuICBjb25zdCBwcm90b1BhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4nLCAncHJvdG8nLCAndGVzdC5wcm90bycpO1xyXG4gIGNvbnN0IGRlZnMgPSBncnBjLmxvYWRQYWNrYWdlRGVmaW5pdGlvbihwcm90b0xvYWRlci5sb2FkU3luYyhwcm90b1BhdGgsIHsga2VlcENhc2U6IHRydWUsIGxvbmdzOiBTdHJpbmcsIGVudW1zOiBTdHJpbmcsIGRlZmF1bHRzOiB0cnVlLCBvbmVvZnM6IHRydWUgfSkpO1xyXG4gIGNvbnN0IHRlc3RQa2cgPSBkZWZzLnRlc3Q7XHJcblxyXG4gIGNvbnN0IHN2YyA9IHtcclxuICAgIFNheTogKGNhbGwsIGNiKSA9PiBjYihudWxsLCB7IG1lc3NhZ2U6IGBIZWxsbyAke2NhbGwucmVxdWVzdC5uYW1lfWAgfSlcclxuICB9O1xyXG5cclxuICBjb25zdCBzID0gbmV3IGdycGMuU2VydmVyKCk7XHJcbiAgcy5hZGRTZXJ2aWNlKHRlc3RQa2cuRWNoby5zZXJ2aWNlLCBzdmMpO1xyXG4gIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcclxuICAgIHMuYmluZEFzeW5jKCcxMjcuMC4wLjE6MCcsIGdycGMuU2VydmVyQ3JlZGVudGlhbHMuY3JlYXRlSW5zZWN1cmUoKSwgKGVyciwgcG9ydCkgPT4ge1xyXG4gICAgICBpZiAoZXJyKSB0aHJvdyBlcnI7XHJcbiAgICAgIHMuc3RhcnQoKTtcclxuICAgICAgcmVzb2x2ZSh7IHNlcnZlcjogcywgcG9ydCB9KTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59XHJcblxyXG5iZWZvcmVBbGwoYXN5bmMgKCkgPT4ge1xyXG4gIGNvbnN0IHsgc2VydmVyOiBzLCBwb3J0IH0gPSBhd2FpdCBzdGFydEdycGNTZXJ2ZXIoKTtcclxuICBzZXJ2ZXIgPSBzO1xyXG4gIGFkZHJlc3MgPSBgMTI3LjAuMC4xOiR7cG9ydH1gO1xyXG4gIHN0YXJ0ZWQgPSBhd2FpdCBzdGFydFNlcnZlcnMoKTtcclxuICBhcGkgPSByZXF1ZXN0KGBodHRwOi8vbG9jYWxob3N0OiR7cHJvY2Vzcy5lbnYuUE9SVH1gKTtcclxufSk7XHJcblxyXG5hZnRlckFsbCgoKSA9PiB7XHJcbiAgaWYgKHN0YXJ0ZWQ/LnNlcnZlcikgc3RhcnRlZC5zZXJ2ZXIuY2xvc2UoKTtcclxuICBpZiAoc3RhcnRlZD8ud3NTZXJ2ZXIpIHN0YXJ0ZWQud3NTZXJ2ZXIuY2xvc2UoKTtcclxuICBpZiAoc2VydmVyKSBzZXJ2ZXIuZm9yY2VTaHV0ZG93bigpO1xyXG59KTtcclxuXHJcbnRlc3QoJ2dSUEM6IGNvbm5lY3QgYW5kIHVuYXJ5IGNhbGwgdmlhIC9vcGVyYXRpb24nLCBhc3luYyAoKSA9PiB7XHJcbiAgLy8gd3JpdGUgcHJvdG8gaWYgbm90IHByZXNlbnRcclxuICAvLyAoY3JlYXRlZCBieSByZXBvIHBhdGNoKVxyXG4gIGNvbnN0IGNyZWF0ZSA9IGF3YWl0IGFwaS5wb3N0KCcvdW5pY29uL2FwaS9jb25uZWN0aW9ucycpLnNlbmQoe1xyXG4gICAgbmFtZTogJ2dycGMtbG9jYWwnLFxyXG4gICAgdHlwZTogJ2dycGMnLFxyXG4gICAgY29uZmlnOiB7XHJcbiAgICAgIGFkZHJlc3MsXHJcbiAgICAgIHByb3RvOiAndGVzdC5wcm90bycsXHJcbiAgICAgIHBhY2thZ2U6ICd0ZXN0JyxcclxuICAgICAgc2VydmljZTogJ0VjaG8nXHJcbiAgICB9XHJcbiAgfSk7XHJcbiAgZXhwZWN0KGNyZWF0ZS5ib2R5LnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XHJcbiAgY29uc3QgaWQgPSBjcmVhdGUuYm9keS5jb25uZWN0aW9uLmlkO1xyXG5cclxuICBjb25zdCBjb24gPSBhd2FpdCBhcGkucG9zdCgnL3VuaWNvbi9hcGkvY29ubmVjdCcpLnNlbmQoeyBjb25uZWN0aW9uSWQ6IGlkIH0pO1xyXG4gIGV4cGVjdChjb24uYm9keS5zdWNjZXNzKS50b0JlKHRydWUpO1xyXG5cclxuICBjb25zdCBvcCA9IGF3YWl0IGFwaS5wb3N0KCcvdW5pY29uL2FwaS9vcGVyYXRpb24nKS5zZW5kKHtcclxuICAgIGNvbm5lY3Rpb25JZDogaWQsXHJcbiAgICBvcGVyYXRpb246ICd1bmFyeScsXHJcbiAgICBwYXJhbXM6IHsgbWV0aG9kOiAnU2F5JywgcmVxdWVzdDogeyBuYW1lOiAnV29ybGQnIH0gfVxyXG4gIH0pO1xyXG5cclxuICBleHBlY3Qob3AuYm9keS5zdWNjZXNzKS50b0JlKHRydWUpO1xyXG4gIGV4cGVjdChvcC5ib2R5LmRhdGEpLnRvRXF1YWwoeyBtZXNzYWdlOiAnSGVsbG8gV29ybGQnIH0pO1xyXG59KTsiXSwibWFwcGluZ3MiOiJBQUFBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLGVBQWUsQ0FB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