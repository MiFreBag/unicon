{"version":3,"names":["grpc","require","protoLoader","path","GrpcHandler","constructor","connectionId","config","client","connect","address","proto","package","service","success","message","defs","_loadProto","svc","_lookup","credentials","createInsecure","disconnect","close","unary","method","request","Error","Promise","resolve","reject","err","resp","data","protoRelPath","fullPath","isAbsolute","join","__dirname","packageDefinition","load","keepCase","longs","String","enums","defaults","oneofs","loadPackageDefinition","pkgName","svcName","parts","split","cur","p","module","exports"],"sources":["grpc_handler.js"],"sourcesContent":["// server/handlers/grpc_handler.js\r\nconst grpc = require('@grpc/grpc-js');\r\nconst protoLoader = require('@grpc/proto-loader');\r\nconst path = require('path');\r\n\r\nclass GrpcHandler {\r\n  constructor(connectionId, config = {}) {\r\n    this.connectionId = connectionId;\r\n    this.config = config;\r\n    this.client = null;\r\n  }\r\n\r\n  async connect() {\r\n    // Minimal: create client from proto if provided\r\n    if (!this.config.address || !this.config.proto || !this.config.package || !this.config.service) {\r\n      // Allow connecting later when details provided\r\n      return { success: true, message: 'gRPC config incomplete; ready for later init' };\r\n    }\r\n    const defs = await this._loadProto(this.config.proto);\r\n    const svc = this._lookup(defs, this.config.package, this.config.service);\r\n    this.client = new svc(this.config.address, grpc.credentials.createInsecure());\r\n    return { success: true };\r\n  }\r\n\r\n  async disconnect() {\r\n    if (this.client && this.client.close) this.client.close();\r\n    this.client = null;\r\n    return { success: true };\r\n  }\r\n\r\n  // Example unary call\r\n  async unary(method, request) {\r\n    if (!this.client || !this.client[method]) throw new Error('Client or method not available');\r\n    return new Promise((resolve, reject) => {\r\n      this.client[method](request, (err, resp) => {\r\n        if (err) return reject(err);\r\n        resolve({ success: true, data: resp });\r\n      });\r\n    });\r\n  }\r\n\r\n  async _loadProto(protoRelPath) {\r\n    const fullPath = path.isAbsolute(protoRelPath)\r\n      ? protoRelPath\r\n      : path.join(__dirname, '..', 'proto', protoRelPath);\r\n    const packageDefinition = await protoLoader.load(fullPath, {\r\n      keepCase: true,\r\n      longs: String,\r\n      enums: String,\r\n      defaults: true,\r\n      oneofs: true,\r\n    });\r\n    return grpc.loadPackageDefinition(packageDefinition);\r\n  }\r\n\r\n  _lookup(defs, pkgName, svcName) {\r\n    const parts = pkgName.split('.');\r\n    let cur = defs;\r\n    for (const p of parts) cur = cur[p];\r\n    return cur[svcName];\r\n  }\r\n}\r\n\r\nmodule.exports = GrpcHandler;"],"mappings":"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","ignoreList":[]}