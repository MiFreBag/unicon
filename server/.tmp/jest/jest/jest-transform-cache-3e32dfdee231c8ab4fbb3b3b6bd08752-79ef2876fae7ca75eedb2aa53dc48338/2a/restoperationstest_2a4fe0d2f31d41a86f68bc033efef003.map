{"version":3,"names":["express","require","http","request","path","os","fs","jest","setTimeout","tmpDir","mkdtempSync","join","tmpdir","process","env","CONNECTION_DATA_DIR","PERSISTENCE","PORT","WS_PORT","startServers","started","api","demoServer","demoPort","beforeAll","app","get","req","res","json","ok","message","params","name","createServer","Promise","resolve","listen","address","port","afterAll","server","close","wsServer","test","create","post","send","type","config","baseUrl","expect","body","success","toBe","id","connection","con","connectionId","op","operation","method","endpoint","data","status","toEqual","openapi","info","title","version","paths","summary","parameters","in","required","schema","responses","description","list","rest","connections","find","c","toBeTruthy","upload","attach","Buffer","from","JSON","stringify","load","openApiFile","eps","Array","isArray","endpoints","ex","toContain","val","headers","valid"],"sources":["rest.operations.test.js"],"sourcesContent":["const express = require('express');\r\nconst http = require('http');\r\nconst request = require('supertest');\r\nconst path = require('path');\r\nconst os = require('os');\r\nconst fs = require('fs');\r\n\r\n// Increase timeout for server spin-up\r\njest.setTimeout(20000);\r\n\r\n// Use a temp data dir per run\r\nconst tmpDir = fs.mkdtempSync(path.join(os.tmpdir(), 'unicon-rest-'));\r\nprocess.env.CONNECTION_DATA_DIR = tmpDir;\r\nprocess.env.PERSISTENCE = 'file';\r\nprocess.env.PORT = '3102';\r\nprocess.env.WS_PORT = '8182';\r\n\r\nconst { startServers } = require('../universal-server');\r\n\r\nlet started; let api; let demoServer; let demoPort;\r\n\r\nbeforeAll(async () => {\r\n  // Start demo REST backend\r\n  const app = express();\r\n  app.get('/test', (req, res) => res.json({ ok: true }));\r\n  app.get('/hello/:name', (req, res) => res.json({ message: `Hello ${req.params.name}` }));\r\n  demoServer = http.createServer(app);\r\n  await new Promise(resolve => demoServer.listen(0, '127.0.0.1', resolve));\r\n  demoPort = demoServer.address().port;\r\n\r\n  // Start Unicon server\r\n  started = await startServers();\r\n  api = request(`http://localhost:${process.env.PORT}`);\r\n});\r\n\r\nafterAll(async () => {\r\n  if (started?.server) started.server.close();\r\n  if (started?.wsServer) started.wsServer.close();\r\n  if (demoServer) demoServer.close();\r\n});\r\n\r\ntest('REST: connect and perform GET /test via /operation', async () => {\r\n  // Create connection\r\n  const create = await api.post('/unicon/api/connections').send({\r\n    name: 'rest-local',\r\n    type: 'rest',\r\n    config: { baseUrl: `http://127.0.0.1:${demoPort}` }\r\n  });\r\n  expect(create.body.success).toBe(true);\r\n  const id = create.body.connection.id;\r\n\r\n  // Connect\r\n  const con = await api.post('/unicon/api/connect').send({ connectionId: id });\r\n  expect(con.body.success).toBe(true);\r\n\r\n  // Request operation\r\n  const op = await api.post('/unicon/api/operation').send({\r\n    connectionId: id,\r\n    operation: 'request',\r\n    params: { method: 'GET', endpoint: '/test' }\r\n  });\r\n  expect(op.body.success).toBe(true);\r\n  expect(op.body.data.status).toBe(200);\r\n  expect(op.body.data.data).toEqual({ ok: true });\r\n});\r\n\r\ntest('REST: upload OpenAPI, load, and generate example/validate', async () => {\r\n  const openapi = {\r\n    openapi: '3.0.0',\r\n    info: { title: 'Demo', version: '1.0.0' },\r\n    paths: {\r\n      '/hello/{name}': {\r\n        get: {\r\n          summary: 'Say hello',\r\n          parameters: [\r\n            { name: 'name', in: 'path', required: true, schema: { type: 'string' } },\r\n            { name: 'x-req-id', in: 'header', required: false, schema: { type: 'string' } }\r\n          ],\r\n          responses: { '200': { description: 'ok' } }\r\n        }\r\n      }\r\n    }\r\n  };\r\n\r\n  // Get a REST connection\r\n  const list = await api.get('/unicon/api/connections');\r\n  const rest = list.body.connections.find(c => c.type === 'rest');\r\n  expect(rest).toBeTruthy();\r\n\r\n  // Upload spec\r\n  const upload = await api\r\n    .post('/unicon/api/upload-openapi')\r\n    .attach('openApiFile', Buffer.from(JSON.stringify(openapi)), 'demo.json');\r\n  expect(upload.body.success).toBe(true);\r\n\r\n  // Load spec into handler\r\n  const load = await api.post('/unicon/api/operation').send({\r\n    connectionId: rest.id,\r\n    operation: 'loadOpenApi',\r\n    params: { openApiFile: 'demo.json' }\r\n  });\r\n  expect(load.body.success).toBe(true);\r\n\r\n  // Get endpoints\r\n  const eps = await api.post('/unicon/api/operation').send({\r\n    connectionId: rest.id,\r\n    operation: 'getEndpoints',\r\n    params: {}\r\n  });\r\n  expect(eps.body.success).toBe(true);\r\n  expect(Array.isArray(eps.body.data.endpoints)).toBe(true);\r\n\r\n  // Generate example\r\n  const ex = await api.post('/unicon/api/operation').send({\r\n    connectionId: rest.id,\r\n    operation: 'generateExample',\r\n    params: { path: '/hello/{name}', method: 'GET' }\r\n  });\r\n  expect(ex.body.success).toBe(true);\r\n  expect(ex.body.data.path).toContain('/hello/');\r\n\r\n  // Validate missing param -> error\r\n  const val = await api.post('/unicon/api/operation').send({\r\n    connectionId: rest.id,\r\n    operation: 'validateRequest',\r\n    params: { path: '/hello/{name}', method: 'GET', headers: {}, params: {} }\r\n  });\r\n  expect(val.body.success).toBe(true);\r\n  expect(val.body.data.valid).toBe(false);\r\n});"],"mappings":"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","ignoreList":[]}