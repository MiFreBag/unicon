0b01673f610f71df4af72fac5ed5c623
_getJestObj().mock('ssh2', () => {
  const {
    EventEmitter
  } = require('events');
  class MockStream extends EventEmitter {
    write(data) {
      this.emit('wrote', data);
    }
    end() {
      this.emit('end');
    }
    setWindow() {}
  }
  class Client extends EventEmitter {
    constructor() {
      super();
      this._connected = false;
    }
    connect(opts) {
      process.nextTick(() => this.emit('ready'));
      this._connected = true;
    }
    end() {
      this._connected = false;
      this.emit('close');
    }
    exec(command, _opts, cb) {
      const stream = new MockStream();
      cb && cb(null, stream);
      process.nextTick(() => {
        stream.emit('data', Buffer.from('ok'));
        stream.emit('close', 0, null);
      });
    }
    sftp(cb) {
      const sftp = {
        readdir: (path, cb2) => cb2(null, [{
          filename: 'file.txt',
          longname: '-rw-r--r-- 1 u g 0 file.txt',
          attrs: {}
        }]),
        createReadStream: () => {
          const rs = new EventEmitter();
          process.nextTick(() => {
            rs.emit('data', Buffer.from('hello'));
            rs.emit('end');
          });
          return rs;
        },
        createWriteStream: () => {
          const ws = new EventEmitter();
          process.nextTick(() => ws.emit('finish'));
          return ws;
        }
      };
      cb && cb(null, sftp);
    }
  }
  return {
    Client
  };
});
function _getJestObj() {
  const {
    jest
  } = require("@jest/globals");
  _getJestObj = () => jest;
  return jest;
}
global.broadcast = jest.fn();
const SSHHandler = require('../handlers/ssh_handler');
describe('SSHHandler', () => {
  test('connect, exec, sftp list/get/put', async () => {
    const h = new SSHHandler('conn-1', {
      host: 'x',
      username: 'u',
      password: 'p'
    });
    await expect(h.connect()).resolves.toEqual({
      success: true
    });
    const execRes = await h.exec('echo ok');
    expect(execRes.success).toBe(true);
    expect(execRes.data.stdout).toContain('ok');
    const listRes = await h.sftpList({
      path: '.'
    });
    expect(listRes.success).toBe(true);
    expect(Array.isArray(listRes.data.entries)).toBe(true);
    const getRes = await h.sftpGet({
      path: './file.txt'
    });
    expect(getRes.success).toBe(true);
    expect(getRes.data.base64).toBeDefined();
    const putRes = await h.sftpPut({
      path: './upload.txt',
      base64: Buffer.from('hi').toString('base64')
    });
    expect(putRes.success).toBe(true);
    await expect(h.disconnect()).resolves.toEqual({
      success: true
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfZ2V0SmVzdE9iaiIsIm1vY2siLCJFdmVudEVtaXR0ZXIiLCJyZXF1aXJlIiwiTW9ja1N0cmVhbSIsIndyaXRlIiwiZGF0YSIsImVtaXQiLCJlbmQiLCJzZXRXaW5kb3ciLCJDbGllbnQiLCJjb25zdHJ1Y3RvciIsIl9jb25uZWN0ZWQiLCJjb25uZWN0Iiwib3B0cyIsInByb2Nlc3MiLCJuZXh0VGljayIsImV4ZWMiLCJjb21tYW5kIiwiX29wdHMiLCJjYiIsInN0cmVhbSIsIkJ1ZmZlciIsImZyb20iLCJzZnRwIiwicmVhZGRpciIsInBhdGgiLCJjYjIiLCJmaWxlbmFtZSIsImxvbmduYW1lIiwiYXR0cnMiLCJjcmVhdGVSZWFkU3RyZWFtIiwicnMiLCJjcmVhdGVXcml0ZVN0cmVhbSIsIndzIiwiamVzdCIsImdsb2JhbCIsImJyb2FkY2FzdCIsImZuIiwiU1NISGFuZGxlciIsImRlc2NyaWJlIiwidGVzdCIsImgiLCJob3N0IiwidXNlcm5hbWUiLCJwYXNzd29yZCIsImV4cGVjdCIsInJlc29sdmVzIiwidG9FcXVhbCIsInN1Y2Nlc3MiLCJleGVjUmVzIiwidG9CZSIsInN0ZG91dCIsInRvQ29udGFpbiIsImxpc3RSZXMiLCJzZnRwTGlzdCIsIkFycmF5IiwiaXNBcnJheSIsImVudHJpZXMiLCJnZXRSZXMiLCJzZnRwR2V0IiwiYmFzZTY0IiwidG9CZURlZmluZWQiLCJwdXRSZXMiLCJzZnRwUHV0IiwidG9TdHJpbmciLCJkaXNjb25uZWN0Il0sInNvdXJjZXMiOlsic3NoX2hhbmRsZXIudGVzdC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJqZXN0Lm1vY2soJ3NzaDInLCAoKSA9PiB7XHJcbiAgY29uc3QgeyBFdmVudEVtaXR0ZXIgfSA9IHJlcXVpcmUoJ2V2ZW50cycpO1xyXG4gIGNsYXNzIE1vY2tTdHJlYW0gZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xyXG4gICAgd3JpdGUoZGF0YSkgeyB0aGlzLmVtaXQoJ3dyb3RlJywgZGF0YSk7IH1cclxuICAgIGVuZCgpIHsgdGhpcy5lbWl0KCdlbmQnKTsgfVxyXG4gICAgc2V0V2luZG93KCkge31cclxuICB9XHJcbiAgY2xhc3MgQ2xpZW50IGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcclxuICAgIGNvbnN0cnVjdG9yKCkgeyBzdXBlcigpOyB0aGlzLl9jb25uZWN0ZWQgPSBmYWxzZTsgfVxyXG4gICAgY29ubmVjdChvcHRzKSB7XHJcbiAgICAgIHByb2Nlc3MubmV4dFRpY2soKCkgPT4gdGhpcy5lbWl0KCdyZWFkeScpKTtcclxuICAgICAgdGhpcy5fY29ubmVjdGVkID0gdHJ1ZTtcclxuICAgIH1cclxuICAgIGVuZCgpIHsgdGhpcy5fY29ubmVjdGVkID0gZmFsc2U7IHRoaXMuZW1pdCgnY2xvc2UnKTsgfVxyXG4gICAgZXhlYyhjb21tYW5kLCBfb3B0cywgY2IpIHtcclxuICAgICAgY29uc3Qgc3RyZWFtID0gbmV3IE1vY2tTdHJlYW0oKTtcclxuICAgICAgY2IgJiYgY2IobnVsbCwgc3RyZWFtKTtcclxuICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB7XHJcbiAgICAgICAgc3RyZWFtLmVtaXQoJ2RhdGEnLCBCdWZmZXIuZnJvbSgnb2snKSk7XHJcbiAgICAgICAgc3RyZWFtLmVtaXQoJ2Nsb3NlJywgMCwgbnVsbCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgc2Z0cChjYikge1xyXG4gICAgICBjb25zdCBzZnRwID0ge1xyXG4gICAgICAgIHJlYWRkaXI6IChwYXRoLCBjYjIpID0+IGNiMihudWxsLCBbeyBmaWxlbmFtZTogJ2ZpbGUudHh0JywgbG9uZ25hbWU6ICctcnctci0tci0tIDEgdSBnIDAgZmlsZS50eHQnLCBhdHRyczoge30gfV0pLFxyXG4gICAgICAgIGNyZWF0ZVJlYWRTdHJlYW06ICgpID0+IHtcclxuICAgICAgICAgIGNvbnN0IHJzID0gbmV3IEV2ZW50RW1pdHRlcigpO1xyXG4gICAgICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB7XHJcbiAgICAgICAgICAgIHJzLmVtaXQoJ2RhdGEnLCBCdWZmZXIuZnJvbSgnaGVsbG8nKSk7XHJcbiAgICAgICAgICAgIHJzLmVtaXQoJ2VuZCcpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICByZXR1cm4gcnM7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBjcmVhdGVXcml0ZVN0cmVhbTogKCkgPT4ge1xyXG4gICAgICAgICAgY29uc3Qgd3MgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XHJcbiAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKCgpID0+IHdzLmVtaXQoJ2ZpbmlzaCcpKTtcclxuICAgICAgICAgIHJldHVybiB3cztcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICAgIGNiICYmIGNiKG51bGwsIHNmdHApO1xyXG4gICAgfVxyXG4gIH1cclxuICByZXR1cm4geyBDbGllbnQgfTtcclxufSk7XHJcblxyXG5nbG9iYWwuYnJvYWRjYXN0ID0gamVzdC5mbigpO1xyXG5cclxuY29uc3QgU1NISGFuZGxlciA9IHJlcXVpcmUoJy4uL2hhbmRsZXJzL3NzaF9oYW5kbGVyJyk7XHJcblxyXG5kZXNjcmliZSgnU1NISGFuZGxlcicsICgpID0+IHtcclxuICB0ZXN0KCdjb25uZWN0LCBleGVjLCBzZnRwIGxpc3QvZ2V0L3B1dCcsIGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IGggPSBuZXcgU1NISGFuZGxlcignY29ubi0xJywgeyBob3N0OiAneCcsIHVzZXJuYW1lOiAndScsIHBhc3N3b3JkOiAncCcgfSk7XHJcbiAgICBhd2FpdCBleHBlY3QoaC5jb25uZWN0KCkpLnJlc29sdmVzLnRvRXF1YWwoeyBzdWNjZXNzOiB0cnVlIH0pO1xyXG5cclxuICAgIGNvbnN0IGV4ZWNSZXMgPSBhd2FpdCBoLmV4ZWMoJ2VjaG8gb2snKTtcclxuICAgIGV4cGVjdChleGVjUmVzLnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XHJcbiAgICBleHBlY3QoZXhlY1Jlcy5kYXRhLnN0ZG91dCkudG9Db250YWluKCdvaycpO1xyXG5cclxuICAgIGNvbnN0IGxpc3RSZXMgPSBhd2FpdCBoLnNmdHBMaXN0KHsgcGF0aDogJy4nIH0pO1xyXG4gICAgZXhwZWN0KGxpc3RSZXMuc3VjY2VzcykudG9CZSh0cnVlKTtcclxuICAgIGV4cGVjdChBcnJheS5pc0FycmF5KGxpc3RSZXMuZGF0YS5lbnRyaWVzKSkudG9CZSh0cnVlKTtcclxuXHJcbiAgICBjb25zdCBnZXRSZXMgPSBhd2FpdCBoLnNmdHBHZXQoeyBwYXRoOiAnLi9maWxlLnR4dCcgfSk7XHJcbiAgICBleHBlY3QoZ2V0UmVzLnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XHJcbiAgICBleHBlY3QoZ2V0UmVzLmRhdGEuYmFzZTY0KS50b0JlRGVmaW5lZCgpO1xyXG5cclxuICAgIGNvbnN0IHB1dFJlcyA9IGF3YWl0IGguc2Z0cFB1dCh7IHBhdGg6ICcuL3VwbG9hZC50eHQnLCBiYXNlNjQ6IEJ1ZmZlci5mcm9tKCdoaScpLnRvU3RyaW5nKCdiYXNlNjQnKSB9KTtcclxuICAgIGV4cGVjdChwdXRSZXMuc3VjY2VzcykudG9CZSh0cnVlKTtcclxuXHJcbiAgICBhd2FpdCBleHBlY3QoaC5kaXNjb25uZWN0KCkpLnJlc29sdmVzLnRvRXF1YWwoeyBzdWNjZXNzOiB0cnVlIH0pO1xyXG4gIH0pO1xyXG59KTtcclxuIl0sIm1hcHBpbmdzIjoiQUFBQUEsV0FBQSxHQUFLQyxJQUFJLENBQUMsTUFBTSxFQUFFLE1BQU07RUFDdEIsTUFBTTtJQUFFQztFQUFhLENBQUMsR0FBR0MsT0FBTyxDQUFDLFFBQVEsQ0FBQztFQUMxQyxNQUFNQyxVQUFVLFNBQVNGLFlBQVksQ0FBQztJQUNwQ0csS0FBS0EsQ0FBQ0MsSUFBSSxFQUFFO01BQUUsSUFBSSxDQUFDQyxJQUFJLENBQUMsT0FBTyxFQUFFRCxJQUFJLENBQUM7SUFBRTtJQUN4Q0UsR0FBR0EsQ0FBQSxFQUFHO01BQUUsSUFBSSxDQUFDRCxJQUFJLENBQUMsS0FBSyxDQUFDO0lBQUU7SUFDMUJFLFNBQVNBLENBQUEsRUFBRyxDQUFDO0VBQ2Y7RUFDQSxNQUFNQyxNQUFN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