{"version":3,"names":["_getJestObj","mock","EventEmitter","require","MockStream","write","data","emit","end","setWindow","Client","constructor","_connected","connect","opts","process","nextTick","exec","command","_opts","cb","stream","Buffer","from","sftp","readdir","path","cb2","filename","longname","attrs","createReadStream","rs","createWriteStream","ws","jest","global","broadcast","fn","SSHHandler","describe","test","h","host","username","password","expect","resolves","toEqual","success","execRes","toBe","stdout","toContain","listRes","sftpList","Array","isArray","entries","getRes","sftpGet","base64","toBeDefined","putRes","sftpPut","toString","disconnect"],"sources":["ssh_handler.test.js"],"sourcesContent":["jest.mock('ssh2', () => {\r\n  const { EventEmitter } = require('events');\r\n  class MockStream extends EventEmitter {\r\n    write(data) { this.emit('wrote', data); }\r\n    end() { this.emit('end'); }\r\n    setWindow() {}\r\n  }\r\n  class Client extends EventEmitter {\r\n    constructor() { super(); this._connected = false; }\r\n    connect(opts) {\r\n      process.nextTick(() => this.emit('ready'));\r\n      this._connected = true;\r\n    }\r\n    end() { this._connected = false; this.emit('close'); }\r\n    exec(command, _opts, cb) {\r\n      const stream = new MockStream();\r\n      cb && cb(null, stream);\r\n      process.nextTick(() => {\r\n        stream.emit('data', Buffer.from('ok'));\r\n        stream.emit('close', 0, null);\r\n      });\r\n    }\r\n    sftp(cb) {\r\n      const sftp = {\r\n        readdir: (path, cb2) => cb2(null, [{ filename: 'file.txt', longname: '-rw-r--r-- 1 u g 0 file.txt', attrs: {} }]),\r\n        createReadStream: () => {\r\n          const rs = new EventEmitter();\r\n          process.nextTick(() => {\r\n            rs.emit('data', Buffer.from('hello'));\r\n            rs.emit('end');\r\n          });\r\n          return rs;\r\n        },\r\n        createWriteStream: () => {\r\n          const ws = new EventEmitter();\r\n          process.nextTick(() => ws.emit('finish'));\r\n          return ws;\r\n        }\r\n      };\r\n      cb && cb(null, sftp);\r\n    }\r\n  }\r\n  return { Client };\r\n});\r\n\r\nglobal.broadcast = jest.fn();\r\n\r\nconst SSHHandler = require('../handlers/ssh_handler');\r\n\r\ndescribe('SSHHandler', () => {\r\n  test('connect, exec, sftp list/get/put', async () => {\r\n    const h = new SSHHandler('conn-1', { host: 'x', username: 'u', password: 'p' });\r\n    await expect(h.connect()).resolves.toEqual({ success: true });\r\n\r\n    const execRes = await h.exec('echo ok');\r\n    expect(execRes.success).toBe(true);\r\n    expect(execRes.data.stdout).toContain('ok');\r\n\r\n    const listRes = await h.sftpList({ path: '.' });\r\n    expect(listRes.success).toBe(true);\r\n    expect(Array.isArray(listRes.data.entries)).toBe(true);\r\n\r\n    const getRes = await h.sftpGet({ path: './file.txt' });\r\n    expect(getRes.success).toBe(true);\r\n    expect(getRes.data.base64).toBeDefined();\r\n\r\n    const putRes = await h.sftpPut({ path: './upload.txt', base64: Buffer.from('hi').toString('base64') });\r\n    expect(putRes.success).toBe(true);\r\n\r\n    await expect(h.disconnect()).resolves.toEqual({ success: true });\r\n  });\r\n});\r\n"],"mappings":"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","ignoreList":[]}