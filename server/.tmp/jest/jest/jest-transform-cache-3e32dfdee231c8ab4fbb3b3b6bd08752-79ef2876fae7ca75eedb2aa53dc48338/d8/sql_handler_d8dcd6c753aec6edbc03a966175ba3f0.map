{"version":3,"names":["SQLHandler","constructor","connectionId","config","driver","toLowerCase","client","connect","sqlite3","require","Database","filename","Promise","resolve","reject","err","_run","success","data","Pool","connectionString","url","query","mysql","createPool","uri","Error","disconnect","close","end","_","sql","params","trim","isSelect","test","rows","_all","changes","lastID","res","rowCount","Array","isArray","all","run","module","exports"],"sources":["sql_handler.js"],"sourcesContent":["// server/handlers/sql_handler.js\r\n// Minimal SQL handler: sqlite (default), with optional pg/mysql2 support\r\n\r\nclass SQLHandler {\r\n  constructor(connectionId, config = {}) {\r\n    this.connectionId = connectionId;\r\n    this.config = config;\r\n    this.driver = (config.driver || 'sqlite').toLowerCase();\r\n    this.client = null; // sqlite Database or pg Pool or mysql2 Pool\r\n  }\r\n\r\n  async connect() {\r\n    if (this.driver === 'sqlite') {\r\n      const sqlite3 = require('sqlite3');\r\n      const { Database } = sqlite3;\r\n      const filename = this.config.filename || ':memory:';\r\n      await new Promise((resolve, reject) => {\r\n        this.client = new Database(filename, (err) => (err ? reject(err) : resolve()));\r\n      });\r\n      // Pragmas for reliability\r\n      await this._run('PRAGMA journal_mode=WAL;');\r\n      await this._run('PRAGMA foreign_keys=ON;');\r\n      return { success: true, data: { driver: 'sqlite', filename } };\r\n    }\r\n\r\n    if (this.driver === 'pg') {\r\n      const { Pool } = require('pg');\r\n      this.client = new Pool({ connectionString: this.config.url || this.config.connectionString });\r\n      // simple test\r\n      await this.client.query('SELECT 1');\r\n      return { success: true, data: { driver: 'pg' } };\r\n    }\r\n\r\n    if (this.driver === 'mysql') {\r\n      const mysql = require('mysql2/promise');\r\n      this.client = await mysql.createPool({ uri: this.config.url || this.config.connectionString });\r\n      await this.client.query('SELECT 1');\r\n      return { success: true, data: { driver: 'mysql' } };\r\n    }\r\n\r\n    throw new Error(`Unsupported SQL driver: ${this.driver}`);\r\n  }\r\n\r\n  async disconnect() {\r\n    if (!this.client) return { success: true };\r\n    try {\r\n      if (this.driver === 'sqlite') {\r\n        await new Promise((resolve) => this.client.close(() => resolve()));\r\n      } else if (this.driver === 'pg') {\r\n        await this.client.end();\r\n      } else if (this.driver === 'mysql') {\r\n        await this.client.end();\r\n      }\r\n    } catch (_) {}\r\n    this.client = null;\r\n    return { success: true };\r\n  }\r\n\r\n  async query(sql, params = []) {\r\n    if (!this.client) throw new Error('SQL not connected');\r\n    if (typeof sql !== 'string' || !sql.trim()) throw new Error('SQL statement required');\r\n\r\n    if (this.driver === 'sqlite') {\r\n      const isSelect = /^\\s*select\\s/i.test(sql);\r\n      if (isSelect) {\r\n        const rows = await this._all(sql, params);\r\n        return { success: true, data: { rows } };\r\n      }\r\n      const { changes, lastID } = await this._run(sql, params);\r\n      return { success: true, data: { changes, lastID } };\r\n    }\r\n\r\n    if (this.driver === 'pg') {\r\n      const res = await this.client.query(sql, params);\r\n      return { success: true, data: { rows: res.rows, rowCount: res.rowCount } };\r\n    }\r\n\r\n    if (this.driver === 'mysql') {\r\n      const [rows] = await this.client.query(sql, params);\r\n      // rows is array for SELECT, OkPacket for DML\r\n      if (Array.isArray(rows)) return { success: true, data: { rows } };\r\n      return { success: true, data: rows };\r\n    }\r\n\r\n    throw new Error('Driver not initialized');\r\n  }\r\n\r\n  // sqlite helpers\r\n  _all(sql, params = []) {\r\n    return new Promise((resolve, reject) => {\r\n      this.client.all(sql, params, (err, rows) => (err ? reject(err) : resolve(rows)));\r\n    });\r\n  }\r\n\r\n  _run(sql, params = []) {\r\n    return new Promise((resolve, reject) => {\r\n      this.client.run(sql, params, function (err) {\r\n        if (err) return reject(err);\r\n        resolve({ lastID: this.lastID, changes: this.changes });\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\nmodule.exports = SQLHandler;\r\n"],"mappings":"AAAA;AACA;;AAEA,MAAMA,UAAU,CAAC;EACfC,WAAWA,CAACC,YAAY,EAAEC,MAAM,GAAG,CAAC,CAAC,EAAE;IACrC,IAAI,CAACD,YAAY,GAAGA,YAAY;IAChC,IAAI,CAACC,MAAM,GAAGA,MAAM;IACpB,IAAI,CAACC,MAAM,GAAG,CAACD,MAAM,CAACC,MAAM,IAAI,QAAQ,EAAEC,WAAW,CAAC,CAAC;IACvD,IAAI,CAACC,MAAM,GAAG,IAAI,CAAC,CAAC;EACtB;EAEA,MAAMC,OAAOA,CAAA,EAAG;IACd,IAAI,IAAI,CAACH,MAAM,KAAK,QAAQ,EAAE;MAC5B,MAAMI,OAAO,GAAGC,OAAO,CAAC,SAAS,CAAC;MAClC,MAAM;QAAEC;MAAS,CAAC,GAAGF,OAAO;MAC5B,MAAMG,QAAQ,GAAG,IAAI,CAACR,MAAM,CAACQ,QAAQ,IAAI,UAAU;MACnD,MAAM,IAAIC,OAAO,CAAC,CAACC,OAAO,EAAEC,MAAM,KAAK;QACrC,IAAI,CAACR,MAAM,GAAG,IAAII,QAAQ,CAACC,QAAQ,EAAGI,GAAG,IAAMA,GAAG,GAAGD,MAAM,CAACC,GAAG,CAAC,GAAGF,OAAO,CAAC,CAAE,CAAC;MAChF,CAAC,CAAC;MACF;MACA,MAAM,IAAI,CAACG,IAAI,CAAC,0BAA0B,CAAC;MAC3C,MAAM,IAAI,CAACA,IAAI,CAAC,yBAAyB,CAAC;MAC1C,OAAO;QAAEC,OAAO,EAAE,IAAI;QAAEC,IAAI,EAAE;UAAEd,MAAM,EAAE,QAAQ;UAAEO;QAAS;MAAE,CAAC;IAChE;IAEA,IAAI,IAAI,CAACP,MAAM,KAAK,IAAI,EAAE;MACxB,MAAM;QAAEe;MAAK,CAAC,GAAGV,OAAO,CAAC,IAAI,CAAC;MAC9B,IAAI,CAACH,MAAM,GAAG,IAAIa,IAAI,CAAC;QAAEC,gBAAgB,EAAE,IAAI,CAACjB,MAAM,CAACkB,GAAG,IAAI,IAAI,CAAClB,MAAM,CAACiB;MAAiB,CAAC,CAAC;MAC7F;MACA,MAAM,IAAI,CAACd,MAAM,CAACgB,KAAK,CAAC,UAAU,CAAC;MACnC,OAAO;QAAEL,OAAO,EAAE,IAAI;QAAEC,IAAI,EAAE;UAAEd,MAAM,EAAE;QAAK;MAAE,CAAC;IAClD;IAEA,IAAI,IAAI,CAACA,MAAM,KAAK,OAAO,EAAE;MAC3B,MAAMmB,KAAK,GAAGd,OAAO,CAAC,gBAAgB,CAAC;MACvC,IAAI,CAACH,MAAM,GAAG,MAAMiB,KAAK,CAACC,UAAU,CAAC;QAAEC,GAAG,EAAE,IAAI,CAACtB,MAAM,CAACkB,GAAG,IAAI,IAAI,CAAClB,MAAM,CAACiB;MAAiB,CAAC,CAAC;MAC9F,MAAM,IAAI,CAACd,MAAM,CAACgB,KAAK,CAAC,UAAU,CAAC;MACnC,OAAO;QAAEL,OAAO,EAAE,IAAI;QAAEC,IAAI,EAAE;UAAEd,MAAM,EAAE;QAAQ;MAAE,CAAC;IACrD;IAEA,MAAM,IAAIsB,KAAK,CAAC,2BAA2B,IAAI,CAACtB,MAAM,EAAE,CAAC;EAC3D;EAEA,MAAMuB,UAAUA,CAAA,EAAG;IACjB,IAAI,CAAC,IAAI,CAACrB,MAAM,EAAE,OAAO;MAAEW,OAAO,EAAE;IAAK,CAAC;IAC1C,IAAI;MACF,IAAI,IAAI,CAACb,MAAM,KAAK,QAAQ,EAAE;QAC5B,MAAM,IAAIQ,OAAO,CAAEC,OAAO,IAAK,IAAI,CAACP,MAAM,CAACsB,KAAK,CAAC,MAAMf,OAAO,CAAC,CAAC,CAAC,CAAC;MACpE,CAAC,MAAM,IAAI,IAAI,CAACT,MAAM,KAAK,IAAI,EAAE;QAC/B,MAAM,IAAI,CAACE,MAAM,CAACuB,GAAG,CAAC,CAAC;MACzB,CAAC,MAAM,IAAI,IAAI,CAACzB,MAAM,KAAK,OAAO,EAAE;QAClC,MAAM,IAAI,CAACE,MAAM,CAACuB,GAAG,CAAC,CAAC;MACzB;IACF,CAAC,CAAC,OAAOC,CAAC,EAAE,CAAC;IACb,IAAI,CAACxB,MAAM,GAAG,IAAI;IAClB,OAAO;MAAEW,OAAO,EAAE;IAAK,CAAC;EAC1B;EAEA,MAAMK,KAAKA,CAACS,GAAG,EAAEC,MAAM,GAAG,EAAE,EAAE;IAC5B,IAAI,CAAC,IAAI,CAAC1B,MAAM,EAAE,MAAM,IAAIoB,KAAK,CAAC,mBAAmB,CAAC;IACtD,IAAI,OAAOK,GAAG,KAAK,QAAQ,IAAI,CAACA,GAAG,CAACE,IAAI,CAAC,CAAC,EAAE,MAAM,IAAIP,KAAK,CAAC,wBAAwB,CAAC;IAErF,IAAI,IAAI,CAACtB,MAAM,KAAK,QAAQ,EAAE;MAC5B,MAAM8B,QAAQ,GAAG,eAAe,CAACC,IAAI,CAACJ,GAAG,CAAC;MAC1C,IAAIG,QAAQ,EAAE;QACZ,MAAME,IAAI,GAAG,MAAM,IAAI,CAACC,IAAI,CAACN,GAAG,EAAEC,MAAM,CAAC;QACzC,OAAO;UAAEf,OAAO,EAAE,IAAI;UAAEC,IAAI,EAAE;YAAEkB;UAAK;QAAE,CAAC;MAC1C;MACA,MAAM;QAAEE,OAAO;QAAEC;MAAO,CAAC,GAAG,MAAM,IAAI,CAACvB,IAAI,CAACe,GAAG,EAAEC,MAAM,CAAC;MACxD,OAAO;QAAEf,OAAO,EAAE,IAAI;QAAEC,IAAI,EAAE;UAAEoB,OAAO;UAAEC;QAAO;MAAE,CAAC;IACrD;IAEA,IAAI,IAAI,CAACnC,MAAM,KAAK,IAAI,EAAE;MACxB,MAAMoC,GAAG,GAAG,MAAM,IAAI,CAAClC,MAAM,CAACgB,KAAK,CAACS,GAAG,EAAEC,MAAM,CAAC;MAChD,OAAO;QAAEf,OAAO,EAAE,IAAI;QAAEC,IAAI,EAAE;UAAEkB,IAAI,EAAEI,GAAG,CAACJ,IAAI;UAAEK,QAAQ,EAAED,GAAG,CAACC;QAAS;MAAE,CAAC;IAC5E;IAEA,IAAI,IAAI,CAACrC,MAAM,KAAK,OAAO,EAAE;MAC3B,MAAM,CAACgC,IAAI,CAAC,GAAG,MAAM,IAAI,CAAC9B,MAAM,CAACgB,KAAK,CAACS,GAAG,EAAEC,MAAM,CAAC;MACnD;MACA,IAAIU,KAAK,CAACC,OAAO,CAACP,IAAI,CAAC,EAAE,OAAO;QAAEnB,OAAO,EAAE,IAAI;QAAEC,IAAI,EAAE;UAAEkB;QAAK;MAAE,CAAC;MACjE,OAAO;QAAEnB,OAAO,EAAE,IAAI;QAAEC,IAAI,EAAEkB;MAAK,CAAC;IACtC;IAEA,MAAM,IAAIV,KAAK,CAAC,wBAAwB,CAAC;EAC3C;;EAEA;EACAW,IAAIA,CAACN,GAAG,EAAEC,MAAM,GAAG,EAAE,EAAE;IACrB,OAAO,IAAIpB,OAAO,CAAC,CAACC,OAAO,EAAEC,MAAM,KAAK;MACtC,IAAI,CAACR,MAAM,CAACsC,GAAG,CAACb,GAAG,EAAEC,MAAM,EAAE,CAACjB,GAAG,EAAEqB,IAAI,KAAMrB,GAAG,GAAGD,MAAM,CAACC,GAAG,CAAC,GAAGF,OAAO,CAACuB,IAAI,CAAE,CAAC;IAClF,CAAC,CAAC;EACJ;EAEApB,IAAIA,CAACe,GAAG,EAAEC,MAAM,GAAG,EAAE,EAAE;IACrB,OAAO,IAAIpB,OAAO,CAAC,CAACC,OAAO,EAAEC,MAAM,KAAK;MACtC,IAAI,CAACR,MAAM,CAACuC,GAAG,CAACd,GAAG,EAAEC,MAAM,EAAE,UAAUjB,GAAG,EAAE;QAC1C,IAAIA,GAAG,EAAE,OAAOD,MAAM,CAACC,GAAG,CAAC;QAC3BF,OAAO,CAAC;UAAE0B,MAAM,EAAE,IAAI,CAACA,MAAM;UAAED,OAAO,EAAE,IAAI,CAACA;QAAQ,CAAC,CAAC;MACzD,CAAC,CAAC;IACJ,CAAC,CAAC;EACJ;AACF;AAEAQ,MAAM,CAACC,OAAO,GAAG/C,UAAU","ignoreList":[]}