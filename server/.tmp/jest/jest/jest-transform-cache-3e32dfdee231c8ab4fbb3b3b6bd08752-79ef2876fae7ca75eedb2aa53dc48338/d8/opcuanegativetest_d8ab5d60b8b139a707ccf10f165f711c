6ec84f03b18ed0d940cc1068e30a5b32
const request = require('supertest');
const fs = require('fs');
const os = require('os');
const path = require('path');
jest.setTimeout(15000);
const tmpDir = fs.mkdtempSync(path.join(os.tmpdir(), 'unicon-opcua-neg-'));
process.env.CONNECTION_DATA_DIR = tmpDir;
process.env.PERSISTENCE = 'file';
process.env.PORT = '3110';
process.env.WS_PORT = '8190';
const {
  startServers
} = require('../universal-server');
let started;
let api;
beforeAll(async () => {
  started = await startServers();
  api = request(`http://localhost:${process.env.PORT}`);
});
afterAll(() => {
  if (started?.server) started.server.close();
  if (started?.wsServer) started.wsServer.close();
});
test('OPC UA connect fails for bad endpoint', async () => {
  const create = await api.post('/unicon/api/connections').send({
    name: 'opcua-bad',
    type: 'opcua',
    config: {
      endpointUrl: 'opc.tcp://127.0.0.1:1',
      timeoutMs: 1000
    }
  });
  expect(create.body.success).toBe(true);
  const id = create.body.connection.id;
  const con = await api.post('/unicon/api/connect').send({
    connectionId: id
  });
  expect(con.status).toBeGreaterThanOrEqual(400);
  expect(con.body.success).toBe(false);
});
test('OPC UA connect times out for unreachable host', async () => {
  const create = await api.post('/unicon/api/connections').send({
    name: 'opcua-timeout',
    type: 'opcua',
    config: {
      endpointUrl: 'opc.tcp://192.0.2.1:4840',
      timeoutMs: 1000
    } // 192.0.2.0/24 TEST-NET-1
  });
  expect(create.body.success).toBe(true);
  const id = create.body.connection.id;
  const con = await api.post('/unicon/api/connect').send({
    connectionId: id
  });
  expect(con.status).toBeGreaterThanOrEqual(400);
  expect(con.body.success).toBe(false);
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJyZXF1ZXN0IiwicmVxdWlyZSIsImZzIiwib3MiLCJwYXRoIiwiamVzdCIsInNldFRpbWVvdXQiLCJ0bXBEaXIiLCJta2R0ZW1wU3luYyIsImpvaW4iLCJ0bXBkaXIiLCJwcm9jZXNzIiwiZW52IiwiQ09OTkVDVElPTl9EQVRBX0RJUiIsIlBFUlNJU1RFTkNFIiwiUE9SVCIsIldTX1BPUlQiLCJzdGFydFNlcnZlcnMiLCJzdGFydGVkIiwiYXBpIiwiYmVmb3JlQWxsIiwiYWZ0ZXJBbGwiLCJzZXJ2ZXIiLCJjbG9zZSIsIndzU2VydmVyIiwidGVzdCIsImNyZWF0ZSIsInBvc3QiLCJzZW5kIiwibmFtZSIsInR5cGUiLCJjb25maWciLCJlbmRwb2ludFVybCIsInRpbWVvdXRNcyIsImV4cGVjdCIsImJvZHkiLCJzdWNjZXNzIiwidG9CZSIsImlkIiwiY29ubmVjdGlvbiIsImNvbiIsImNvbm5lY3Rpb25JZCIsInN0YXR1cyIsInRvQmVHcmVhdGVyVGhhbk9yRXF1YWwiXSwic291cmNlcyI6WyJvcGN1YS5uZWdhdGl2ZS50ZXN0LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHJlcXVlc3QgPSByZXF1aXJlKCdzdXBlcnRlc3QnKTtcclxuY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xyXG5jb25zdCBvcyA9IHJlcXVpcmUoJ29zJyk7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XHJcblxyXG5qZXN0LnNldFRpbWVvdXQoMTUwMDApO1xyXG5cclxuY29uc3QgdG1wRGlyID0gZnMubWtkdGVtcFN5bmMocGF0aC5qb2luKG9zLnRtcGRpcigpLCAndW5pY29uLW9wY3VhLW5lZy0nKSk7XHJcbnByb2Nlc3MuZW52LkNPTk5FQ1RJT05fREFUQV9ESVIgPSB0bXBEaXI7XHJcbnByb2Nlc3MuZW52LlBFUlNJU1RFTkNFID0gJ2ZpbGUnO1xyXG5wcm9jZXNzLmVudi5QT1JUID0gJzMxMTAnO1xyXG5wcm9jZXNzLmVudi5XU19QT1JUID0gJzgxOTAnO1xyXG5cclxuY29uc3QgeyBzdGFydFNlcnZlcnMgfSA9IHJlcXVpcmUoJy4uL3VuaXZlcnNhbC1zZXJ2ZXInKTtcclxuXHJcbmxldCBzdGFydGVkOyBsZXQgYXBpO1xyXG5cclxuYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcclxuICBzdGFydGVkID0gYXdhaXQgc3RhcnRTZXJ2ZXJzKCk7XHJcbiAgYXBpID0gcmVxdWVzdChgaHR0cDovL2xvY2FsaG9zdDoke3Byb2Nlc3MuZW52LlBPUlR9YCk7XHJcbn0pO1xyXG5cclxuYWZ0ZXJBbGwoKCkgPT4ge1xyXG4gIGlmIChzdGFydGVkPy5zZXJ2ZXIpIHN0YXJ0ZWQuc2VydmVyLmNsb3NlKCk7XHJcbiAgaWYgKHN0YXJ0ZWQ/LndzU2VydmVyKSBzdGFydGVkLndzU2VydmVyLmNsb3NlKCk7XHJcbn0pO1xyXG5cclxudGVzdCgnT1BDIFVBIGNvbm5lY3QgZmFpbHMgZm9yIGJhZCBlbmRwb2ludCcsIGFzeW5jICgpID0+IHtcclxuICBjb25zdCBjcmVhdGUgPSBhd2FpdCBhcGkucG9zdCgnL3VuaWNvbi9hcGkvY29ubmVjdGlvbnMnKS5zZW5kKHtcclxuICAgIG5hbWU6ICdvcGN1YS1iYWQnLFxyXG4gICAgdHlwZTogJ29wY3VhJyxcclxuICAgIGNvbmZpZzogeyBlbmRwb2ludFVybDogJ29wYy50Y3A6Ly8xMjcuMC4wLjE6MScsIHRpbWVvdXRNczogMTAwMCB9XHJcbiAgfSk7XHJcbiAgZXhwZWN0KGNyZWF0ZS5ib2R5LnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XHJcbiAgY29uc3QgaWQgPSBjcmVhdGUuYm9keS5jb25uZWN0aW9uLmlkO1xyXG5cclxuICBjb25zdCBjb24gPSBhd2FpdCBhcGkucG9zdCgnL3VuaWNvbi9hcGkvY29ubmVjdCcpLnNlbmQoeyBjb25uZWN0aW9uSWQ6IGlkIH0pO1xyXG4gIGV4cGVjdChjb24uc3RhdHVzKS50b0JlR3JlYXRlclRoYW5PckVxdWFsKDQwMCk7XHJcbiAgZXhwZWN0KGNvbi5ib2R5LnN1Y2Nlc3MpLnRvQmUoZmFsc2UpO1xyXG59KTtcclxuXHJcbnRlc3QoJ09QQyBVQSBjb25uZWN0IHRpbWVzIG91dCBmb3IgdW5yZWFjaGFibGUgaG9zdCcsIGFzeW5jICgpID0+IHtcclxuICBjb25zdCBjcmVhdGUgPSBhd2FpdCBhcGkucG9zdCgnL3VuaWNvbi9hcGkvY29ubmVjdGlvbnMnKS5zZW5kKHtcclxuICAgIG5hbWU6ICdvcGN1YS10aW1lb3V0JyxcclxuICAgIHR5cGU6ICdvcGN1YScsXHJcbiAgICBjb25maWc6IHsgZW5kcG9pbnRVcmw6ICdvcGMudGNwOi8vMTkyLjAuMi4xOjQ4NDAnLCB0aW1lb3V0TXM6IDEwMDAgfSAvLyAxOTIuMC4yLjAvMjQgVEVTVC1ORVQtMVxyXG4gIH0pO1xyXG4gIGV4cGVjdChjcmVhdGUuYm9keS5zdWNjZXNzKS50b0JlKHRydWUpO1xyXG4gIGNvbnN0IGlkID0gY3JlYXRlLmJvZHkuY29ubmVjdGlvbi5pZDtcclxuICBjb25zdCBjb24gPSBhd2FpdCBhcGkucG9zdCgnL3VuaWNvbi9hcGkvY29ubmVjdCcpLnNlbmQoeyBjb25uZWN0aW9uSWQ6IGlkIH0pO1xyXG4gIGV4cGVjdChjb24uc3RhdHVzKS50b0JlR3JlYXRlclRoYW5PckVxdWFsKDQwMCk7XHJcbiAgZXhwZWN0KGNvbi5ib2R5LnN1Y2Nlc3MpLnRvQmUoZmFsc2UpO1xyXG59KTsiXSwibWFwcGluZ3MiOiJBQUFBLE1BQU1BLE9BQU8sR0FBR0MsT0FBTyxDQUFDLFdBQVcsQ0FBQztBQUNwQyxNQUFNQyxFQUFFLEdBQUdELE9BQU8sQ0FBQyxJQUFJLENBQUM7QUFDeEIsTUFBTUUsRUFBRSxHQUFHRixPQUFPLENBQUMsSUFBSSxDQUFDO0FBQ3hCLE1BQU1HLElBQUksR0FBR0gsT0FBTyxDQUFDLE1BQU0sQ0FBQztBQUU1QkksSUFBSSxDQUFDQyxVQUFVLENBQUMsS0FBSyxDQUFDO0FBRXRCLE1BQU1DLE1BQU0sR0FBR0wsRUFBRSxDQUFDTSxXQUFXLENBQUNKLElBQUksQ0FBQ0ssSUFBSSxDQUFDTixFQUFFLENBQUNPLE1BQU0sQ0FBQyxDQUFDLEVBQUUsbUJBQW1CLENBQUMsQ0FBQztBQUMxRUMsT0FBTyxDQUFDQyxHQUFHLENBQUNDLG1CQUFtQixHQUFHTixNQUFNO0FBQ3hDSSxPQUFPLENBQUNDLEdBQUcsQ0FBQ0UsV0FBVyxHQUFHLE1BQU07QUFDaENILE9BQU8sQ0FBQ0MsR0FBRyxDQUFDRyxJQUFJLEdBQUcsTUFBTTtBQUN6QkosT0FBTyxDQUFDQyxHQUFHLENBQUNJLE9BQU8sR0FBRyxNQUFNO0FBRTVCLE1BQU07RUFBRUM7QUFBYSxDQUFDLEdBQUdoQixPQUFPLENBQUMscUJBQXFCLENBQUM7QUFFdkQsSUFBSWlCLE9BQU87QUFBRSxJQUFJQyxHQUFHO0FBRXBCQyxTQUFTLENBQUMsWUFBWTtFQUNwQkYsT0FBTyxHQUFHLE1BQU1ELFlBQVksQ0FBQyxDQUFDO0VBQzlCRSxHQUFHLEdBQUduQixPQUFPLENBQUMsb0JBQW9CVyxPQUFPLENBQUNDLEdBQUcsQ0FBQ0csSUFBSSxFQUFFLENBQUM7QUFDdkQsQ0FBQyxDQUFDO0FBRUZNLFFBQVEsQ0FBQyxNQUFNO0VBQ2IsSUFBSUgsT0FBTyxFQUFFSSxNQUFNLEVBQUVKLE9BQU8sQ0FBQ0ksTUFBTSxDQUFDQyxLQUFLLENBQUMsQ0FBQztFQUMzQyxJQUFJTCxPQUFPLEVBQUVNLFFBQVEsRUFBRU4sT0FBTyxDQUFDTSxRQUFRLENBQUNELEtBQUssQ0FBQyxDQUFDO0FBQ2pELENBQUMsQ0FBQztBQUVGRSxJQUFJLENBQUMsdUNBQXVDLEVBQUUsWUFBWTtFQUN4RCxNQUFNQyxNQUFNLEdBQUcsTUFBTVAsR0FBRyxDQUFDUSxJQUFJLENBQUMseUJBQXlCLENBQUMsQ0FBQ0MsSUFBSSxDQUFDO0lBQzVEQyxJQUFJLEVBQUUsV0FBVztJQUNqQkMsSUFBSSxFQUFFLE9BQU87SUFDYkMsTUFBTSxFQUFFO01BQUVDLFdBQVcsRUFBRSx1QkFBdUI7TUFBRUMsU0FBUyxFQUFFO0lBQUs7RUFDbEUsQ0FBQyxDQUFDO0VBQ0ZDLE1BQU0sQ0FBQ1IsTUFBTSxDQUFDUyxJQUFJLENBQUNDLE9BQU8sQ0FBQyxDQUFDQyxJQUFJLENBQUMsSUFBSSxDQUFDO0VBQ3RDLE1BQU1DLEVBQUUsR0FBR1osTUFBTSxDQUFDUyxJQUFJLENBQUNJLFVBQVUsQ0FBQ0QsRUFBRTtFQUVwQyxNQUFNRSxHQUFHLEdBQUcsTUFBTXJCLEdBQUcsQ0FBQ1EsSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQUNDLElBQUksQ0FBQztJQUFFYSxZQUFZLEVBQUVIO0VBQUcsQ0FBQyxDQUFDO0VBQzVFSixNQUFNLENBQUNNLEdBQUcsQ0FBQ0UsTUFBTSxDQUFDLENBQUNDLHNCQUFzQixDQUFDLEdBQUcsQ0FBQztFQUM5Q1QsTUFBTSxDQUFDTSxHQUFHLENBQUNMLElBQUksQ0FBQ0MsT0FBTyxDQUFDLENBQUNDLElBQUksQ0FBQyxLQUFLLENBQUM7QUFDdEMsQ0FBQyxDQUFDO0FBRUZaLElBQUksQ0FBQywrQ0FBK0MsRUFBRSxZQUFZO0VBQ2hFLE1BQU1DLE1BQU0sR0FBRyxNQUFNUCxHQUFHLENBQUNRLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDQyxJQUFJLENBQUM7SUFDNURDLElBQUksRUFBRSxlQUFlO0lBQ3JCQyxJQUFJLEVBQUUsT0FBTztJQUNiQyxNQUFNLEVBQUU7TUFBRUMsV0FBVyxFQUFFLDBCQUEwQjtNQUFFQyxTQUFTLEVBQUU7SUFBSyxDQUFDLENBQUM7RUFDdkUsQ0FBQyxDQUFDO0VBQ0ZDLE1BQU0sQ0FBQ1IsTUFBTSxDQUFDUyxJQUFJLENBQUNDLE9BQU8sQ0FBQyxDQUFDQyxJQUFJLENBQUMsSUFBSSxDQUFDO0VBQ3RDLE1BQU1DLEVBQUUsR0FBR1osTUFBTSxDQUFDUyxJQUFJLENBQUNJLFVBQVUsQ0FBQ0QsRUFBRTtFQUNwQyxNQUFNRSxHQUFHLEdBQUcsTUFBTXJCLEdBQUcsQ0FBQ1EsSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQUNDLElBQUksQ0FBQztJQUFFYSxZQUFZLEVBQUVIO0VBQUcsQ0FBQyxDQUFDO0VBQzVFSixNQUFNLENBQUNNLEdBQUcsQ0FBQ0UsTUFBTSxDQUFDLENBQUNDLHNCQUFzQixDQUFDLEdBQUcsQ0FBQztFQUM5Q1QsTUFBTSxDQUFDTSxHQUFHLENBQUNMLElBQUksQ0FBQ0MsT0FBTyxDQUFDLENBQUNDLElBQUksQ0FBQyxLQUFLLENBQUM7QUFDdEMsQ0FBQyxDQUFDIiwiaWdub3JlTGlzdCI6W119