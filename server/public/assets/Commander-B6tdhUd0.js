import{j as t,B as g,l as G,m as H,n as V,I as X,o as Q,f as Y}from"./index-BQRLusCx.js";import{R as f}from"./vendor-CnGqnXYo.js";import"./icons-oCSk50xQ.js";function W(){const[x,b]=f.useState(null),[p,F]=f.useState("."),[P,z]=f.useState([]),[h,y]=f.useState(new Set),[j,D]=f.useState(-1),[I,B]=f.useState(!1),C=f.useCallback(async r=>{if(!x||x.status!=="connected")return;const m=r??p;B(!0);try{const l=await Q(x.id,"list",{path:m});l!=null&&l.success&&(z(l.data||[]),F(m),y(new Set),D(-1))}finally{B(!1)}},[x,p]),M=()=>{if(!p||p==="."||p==="/"){C("/");return}const r=String(p).replace(/\\+/g,"/").split("/");r.pop(),C(r.join("/")||"/")},$=r=>{if(r.isDirectory===!0||r.type==="d"||r.type===1){const l=p==="/"?`/${r.name}`:`${p}/${r.name}`;C(l)}else{const l=new Set([r.name]);y(l)}};function R(r,m,l){if(m.isDirectory===!0||m.type==="d"||m.type===1)return;const A=r.ctrlKey||r.metaKey;if(r.shiftKey&&j!==-1){const w=Math.min(j,l),E=Math.max(j,l),O=P.slice(w,E+1).filter(k=>!(k.isDirectory===!0||k.type==="d"||k.type===1)).map(k=>k.name);y(new Set(O))}else if(A){const w=new Set(h);w.has(m.name)?w.delete(m.name):w.add(m.name),y(w),D(l)}else y(new Set([m.name])),D(l)}return{conn:x,setConn:b,cwd:p,setCwd:F,items:P,sel:h,setSel:y,lastIndex:j,setLastIndex:D,list:C,goUp:M,open:$,loading:I,onRowClick:R}}function se(){const x=W(),b=W(),[p,F]=f.useState([]),[P,z]=f.useState(!1),[h,y]=f.useState({totalFiles:0,doneFiles:0,totalBytes:0,doneBytes:0,running:!1,phase:""}),[j,D]=f.useState([]),[I,B]=f.useState(!1),C=f.useRef(!1),[M,$]=f.useState({jobId:null,bytes:0,total:0}),R=async()=>{const n=((await G()).connections||[]).filter(a=>["localfs","ftp","sftp"].includes(a.type));F(n)};f.useEffect(()=>{R()},[]),f.useEffect(()=>{const e=n=>{const a=n.detail||{};if(a.type!=="transfer")return;const s=a.data||{};$(o=>o.jobId&&s.jobId===o.jobId?{jobId:o.jobId,bytes:s.bytes||0,total:s.total||o.total}:o)};return window.addEventListener("unicon-ws",e),()=>window.removeEventListener("unicon-ws",e)},[]);const r=async e=>{e.conn&&(e.conn.status!=="connected"&&(await Y(e.conn.id),e.setConn({...e.conn,status:"connected"})),await e.list("."))};function m(e){return String(e||"").replace(/\\+/g,"/").replace(/\/+/,"/")}function l(e,n){return!e||e==="."?n||"":e.endsWith("/")?n?`${e}${n}`:e:n?`${e}/${n}`:e}function T(e){const a=m(e).split("/");return a.pop(),a.join("/")||"/"}async function A(e,n){const a=m(n);if(!a||a==="."||a==="/")return;const s=a.split("/");let o="";for(const i of s){o=o?`${o}/${i}`:i;try{await Q(e.conn.id,"mkdir",{path:o})}catch{}}}async function U(e,n,a){const s=[];let o=0;const i=m(e.cwd),c=new Map((e.items||[]).map(u=>[u.name,u]));async function d(u,N){const v=await Q(e.conn.id,"list",{path:u}),K=(v==null?void 0:v.data)||[];for(const S of K){const _=l(u,S.name),q=l(N,S.name);if(S.isDirectory===!0||S.type==="d"||S.type===1)await d(_,q);else{const J=Number(S.size||0);o+=J,s.push({srcPath:_,rel:q,size:J})}}}for(const u of a){const N=c.get(u),v=l(i,u);if(N&&(N.isDirectory===!0||N.type==="d"||N.type===1))await d(v,u);else{const S=Number((N==null?void 0:N.size)||0);o+=S,s.push({srcPath:v,rel:u,size:S})}}return{files:s,totalBytes:o}}async function w(e,n,a){y(c=>({...c,running:!0,phase:c.running?c.phase:"Queued",totalFiles:c.totalFiles,totalBytes:c.totalBytes}));const{files:s,totalBytes:o}=await U(e,n,a),i=s.map(c=>({jobId:`${Date.now()}-${Math.random().toString(36).slice(2)}`,srcConnId:e.conn.id,dstConnId:n.conn.id,srcPath:c.srcPath,dstPath:l(n.cwd,c.rel),size:c.size}));D(c=>[...c,...i]),y(c=>({...c,totalFiles:c.totalFiles+i.length,totalBytes:c.totalBytes+o})),!C.current&&!I&&E()}async function E(){for(C.current=!0,y(e=>({...e,running:!0,phase:"Copying…"}));!I;){let e=null;if(D(n=>n.length?(e=n[0],n.slice(1)):n),!e)break;try{await A({conn:{id:e.dstConnId}},T(e.dstPath.replace(/^\/+/,""))),$({jobId:e.jobId,bytes:0,total:e.size||0}),await fetch("/unicon/api/transfer/copy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jobId:e.jobId,src:{connectionId:e.srcConnId,path:e.srcPath},dst:{connectionId:e.dstConnId,path:e.dstPath},size:e.size||null})}).then(n=>n.json()).then(n=>{if(!(n!=null&&n.success))throw new Error((n==null?void 0:n.error)||"copy error")}),y(n=>({...n,doneFiles:n.doneFiles+1,doneBytes:Math.min(n.totalBytes,n.doneBytes+(e.size||0))}))}catch(n){alert(`Copy failed: ${n.message||n}`)}finally{$({jobId:null,bytes:0,total:0})}}C.current=!1,y(e=>({...e,phase:I?"Paused":j.length?"Queued":"Done",running:j.length>0||I}))}const O=async(e,n)=>{if(!e.conn||!n.conn)return;const a=Array.from(e.sel);if(a.length){z(!0);try{await w(e,n,a)}catch(s){alert(s.message||"enqueue failed")}finally{z(!1)}}},k=({pane:e})=>{var n;return t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs(H,{value:((n=e.conn)==null?void 0:n.id)||"",onChange:a=>{const s=a.target.value,o=p.find(i=>i.id===s)||null;e.setConn(o),(o==null?void 0:o.status)==="connected"&&e.list(".")},children:[t.jsx("option",{value:"",children:"Pick connection…"}),p.map(a=>t.jsxs("option",{value:a.id,children:[a.type.toUpperCase()," • ",a.name]},a.id))]}),t.jsx(g,{variant:"secondary",onClick:()=>r(e),disabled:!e.conn||e.conn.status==="connected",children:"Connect"}),t.jsx(g,{variant:"secondary",onClick:async()=>{e.conn&&(await V(e.conn.id),e.setConn({...e.conn,status:"disconnected"}))},disabled:!e.conn||e.conn.status!=="connected",children:"Disconnect"})]})},L=({pane:e,side:n,onDropFromOther:a})=>t.jsxs("div",{className:"flex-1 flex flex-col border rounded",children:[t.jsxs("div",{className:"flex items-center gap-2 p-2 border-b",children:[t.jsx(g,{variant:"secondary",onClick:e.goUp,children:"Up"}),t.jsx(g,{variant:"secondary",onClick:()=>e.list(e.cwd),children:"Refresh"}),t.jsx(X,{className:"flex-1",value:e.cwd,onChange:s=>e.setCwd(s.target.value)}),t.jsx("input",{type:"file",multiple:!0,onChange:async s=>{if(!e.conn||e.conn.status!=="connected")return;const o=Array.from(s.target.files||[]);for(const i of o){const c=new FormData;c.append("connectionId",e.conn.id),c.append("cwd",e.cwd||"."),c.append("file",i,i.name),await fetch("/unicon/api/stream/upload",{method:"POST",body:c})}try{await e.list(e.cwd)}catch{}s.target.value=""}}),t.jsx(g,{onClick:()=>e.list(e.cwd),disabled:!e.conn||e.conn.status!=="connected",children:"Go"}),t.jsx(g,{variant:"secondary",onClick:()=>{if(!e.conn||e.conn.status!=="connected")return;const s=Array.from(e.sel);if(s.length)for(const o of s){const i=e.cwd==="/"?`/${o}`:`${e.cwd}/${o}`,c=`/unicon/api/stream/download?connectionId=${encodeURIComponent(e.conn.id)}&path=${encodeURIComponent(i)}`,d=document.createElement("a");d.href=c,d.download="",d.target="_blank",document.body.appendChild(d),d.click(),d.remove()}},disabled:!e.sel.size,children:"Download"})]}),t.jsx("div",{className:"flex-1 overflow-auto",onDragOver:s=>s.preventDefault(),onDrop:s=>{try{const o=s.dataTransfer.getData("application/x-unicon");if(!o)return;const i=JSON.parse(o);i.from&&i.from!==n&&Array.isArray(i.names)&&i.names.length&&a(i.names,i.from)}catch{}},children:t.jsxs("table",{className:"w-full text-sm",children:[t.jsx("thead",{className:"bg-gray-50",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-2 py-1 w-6"}),t.jsx("th",{className:"text-left px-2 py-1",children:"Name"}),t.jsx("th",{className:"text-left px-2 py-1",children:"Type"}),t.jsx("th",{className:"text-left px-2 py-1",children:"Size"})]})}),t.jsxs("tbody",{children:[e.items.map((s,o)=>{const i=s.isDirectory===!0||s.type==="d"||s.type===1,c=e.sel.has(s.name);return t.jsxs("tr",{className:`border-b ${c?"bg-blue-50":""}`,draggable:!0,onDragStart:d=>{const u=e.sel.has(s.name)?Array.from(e.sel):[s.name];d.dataTransfer.setData("application/x-unicon",JSON.stringify({from:n,names:u}))},onClick:d=>e.onRowClick(d,s,o),children:[t.jsx("td",{className:"px-2 py-1",children:!i&&t.jsx("input",{type:"checkbox",checked:c,onChange:d=>{d.stopPropagation();const u=new Set(e.sel);u.has(s.name)?u.delete(s.name):u.add(s.name),e.setSel(u)}})}),t.jsx("td",{className:"px-2 py-1",children:t.jsx("button",{className:"hover:underline",onClick:d=>{d.stopPropagation(),e.open(s)},children:s.name})}),t.jsx("td",{className:"px-2 py-1",children:i?"dir":"file"}),t.jsx("td",{className:"px-2 py-1",children:s.size??""})]},o)}),!e.items.length&&t.jsx("tr",{children:t.jsx("td",{className:"px-3 py-6 text-center text-gray-500",colSpan:4,children:e.loading?"Loading…":"Empty"})})]})]})})]});return t.jsxs("div",{className:"h-full flex flex-col gap-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("div",{className:"flex items-center gap-2",children:t.jsx("b",{children:"File Commander"})}),t.jsx(g,{variant:"secondary",onClick:R,children:"Reload connections"})]}),t.jsxs("div",{className:"flex items-center gap-6",children:[t.jsx(k,{pane:x}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(g,{onClick:()=>O(b,x),disabled:P||!b.sel.size,children:"← Copy"}),t.jsx(g,{onClick:()=>O(x,b),disabled:P||!x.sel.size,children:"Copy →"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(g,{variant:"secondary",onClick:()=>{B(!0),y(e=>({...e,phase:"Paused",running:!0}))},disabled:I||!h.running&&!j.length,children:"Pause"}),t.jsx(g,{variant:"secondary",onClick:()=>{B(!1),C.current||E()},disabled:!I,children:"Resume"}),t.jsx(g,{variant:"secondary",onClick:()=>{D([]),y(e=>({...e,running:!1,phase:"Canceled"}))},disabled:!j.length&&!h.running,children:"Cancel"})]}),t.jsxs("div",{className:"min-w-[300px] text-xs text-gray-700",children:[t.jsx("div",{className:"w-full h-2 bg-gray-200 rounded overflow-hidden mb-1",children:t.jsx("div",{className:"h-2 bg-blue-600",style:{width:`${h.totalBytes>0?Math.floor(100*((h.doneBytes+(M.bytes||0))/Math.max(1,h.totalBytes))):Math.floor(100*(h.doneFiles/Math.max(1,h.totalFiles)))}%`}})}),t.jsxs("div",{children:[h.phase||(j.length?"Queued":"")," ",h.doneFiles,"/",h.totalFiles," files · ",Math.round((h.doneBytes+(M.bytes||0))/1024)," / ",Math.round(Math.max(1,h.totalBytes)/1024)," KB · Queue: ",j.length]})]})]}),t.jsx(k,{pane:b})]}),t.jsxs("div",{className:"flex gap-3 min-h-[400px]",children:[t.jsx(L,{side:"left",pane:x,onDropFromOther:e=>w(b,x,e)}),t.jsx(L,{side:"right",pane:b,onDropFromOther:e=>w(x,b,e)})]})]})}export{se as default};
//# sourceMappingURL=Commander-B6tdhUd0.js.map
