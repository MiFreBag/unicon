import{j as t,B as D,l as Y,p as Z,q as ee,I as X,o as J,k as te}from"./index-ByPSBARW.js";import{R as f}from"./vendor-CnGqnXYo.js";import"./icons-oCSk50xQ.js";function V(){const[i,b]=f.useState(null),[a,k]=f.useState("."),[O,v]=f.useState([]),[I,N]=f.useState(new Set),[T,p]=f.useState(-1),[$,B]=f.useState(!1),z=f.useCallback(async x=>{if(!i||i.status!=="connected")return;const C=x??a;B(!0);try{const w=await J(i.id,"list",{path:C});w!=null&&w.success&&(v(w.data||[]),k(C),N(new Set),p(-1))}finally{B(!1)}},[i,a]),U=()=>{if(!a||a==="."||a==="/"){z("/");return}const x=String(a).replace(/\\+/g,"/").split("/");x.pop(),z(x.join("/")||"/")},E=x=>{if(x.isDirectory===!0||x.type==="d"||x.type===1){const w=a==="/"?`/${x.name}`:`${a}/${x.name}`;z(w)}else{const w=new Set([x.name]);N(w)}};function L(x,C,w){if(C.isDirectory===!0||C.type==="d"||C.type===1)return;const K=x.ctrlKey||x.metaKey;if(x.shiftKey&&T!==-1){const c=Math.min(T,w),r=Math.max(T,w),g=O.slice(c,r+1).filter(o=>!(o.isDirectory===!0||o.type==="d"||o.type===1)).map(o=>o.name);N(new Set(g))}else if(K){const c=new Set(I);c.has(C.name)?c.delete(C.name):c.add(C.name),N(c),p(w)}else N(new Set([C.name])),p(w)}return{conn:i,setConn:b,cwd:a,setCwd:k,items:O,sel:I,setSel:N,lastIndex:T,setLastIndex:p,list:z,goUp:U,open:E,loading:$,onRowClick:L}}function le(){const i=V(),b=V(),a=se(),[k,O]=f.useState(!1),[v,I]=f.useState([]),[N,T]=f.useState(!1),[p,$]=f.useState({totalFiles:0,doneFiles:0,totalBytes:0,doneBytes:0,running:!1,phase:""}),[B,z]=f.useState([]),[U,E]=f.useState(!1),L=f.useRef(!1),[x,C]=f.useState({jobId:null,bytes:0,total:0}),w=async()=>{const s=((await Y()).connections||[]).filter(d=>["localfs","ftp","sftp"].includes(d.type));I(s)};f.useEffect(()=>{w()},[]),f.useEffect(()=>{const e=s=>{const d=s.detail||{};if(d.type!=="transfer")return;const j=d.data||{};C(n=>n.jobId&&j.jobId===n.jobId?{jobId:n.jobId,bytes:j.bytes||0,total:j.total||n.total}:n)};return window.addEventListener("unicon-ws",e),()=>window.removeEventListener("unicon-ws",e)},[]);const Q=async e=>{e.conn&&(e.conn.status!=="connected"&&(await te(e.conn.id),e.setConn({...e.conn,status:"connected"})),await e.list("."))};function K(e){return String(e||"").replace(/\\+/g,"/").replace(/\/+/,"/")}function R(e,s){return!e||e==="."?s||"":e.endsWith("/")?s?`${e}${s}`:e:s?`${e}/${s}`:e}function c(e){const d=K(e).split("/");return d.pop(),d.join("/")||"/"}async function r(e,s){const d=K(s);if(!d||d==="."||d==="/")return;const j=d.split("/");let n="";for(const y of j){n=n?`${n}/${y}`:y;try{await J(e.conn.id,"mkdir",{path:n})}catch{}}}async function g(e,s,d){const j=[];let n=0;const y=K(e.cwd),l=new Map((e.items||[]).map(u=>[u.name,u]));async function h(u,S){const H=await J(e.conn.id,"list",{path:u}),_=(H==null?void 0:H.data)||[];for(const A of _){const q=R(u,A.name),G=R(S,A.name);if(A.isDirectory===!0||A.type==="d"||A.type===1)await h(q,G);else{const W=Number(A.size||0);n+=W,j.push({srcPath:q,rel:G,size:W})}}}for(const u of d){const S=l.get(u),H=R(y,u);if(S&&(S.isDirectory===!0||S.type==="d"||S.type===1))await h(H,u);else{const A=Number((S==null?void 0:S.size)||0);n+=A,j.push({srcPath:H,rel:u,size:A})}}return{files:j,totalBytes:n}}async function o(e,s,d){$(l=>({...l,running:!0,phase:l.running?l.phase:"Queued",totalFiles:l.totalFiles,totalBytes:l.totalBytes}));const{files:j,totalBytes:n}=await g(e,s,d),y=j.map(l=>({jobId:`${Date.now()}-${Math.random().toString(36).slice(2)}`,srcConnId:e.conn.id,dstConnId:s.conn.id,srcPath:l.srcPath,dstPath:R(s.cwd,l.rel),size:l.size}));z(l=>[...l,...y]),$(l=>({...l,totalFiles:l.totalFiles+y.length,totalBytes:l.totalBytes+n})),!L.current&&!U&&m()}async function m(){for(L.current=!0,$(e=>({...e,running:!0,phase:"Copying…"}));!U;){let e=null;if(z(s=>s.length?(e=s[0],s.slice(1)):s),!e)break;try{await r({conn:{id:e.dstConnId}},c(e.dstPath.replace(/^\/+/,""))),C({jobId:e.jobId,bytes:0,total:e.size||0}),await fetch("/unicon/api/transfer/copy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jobId:e.jobId,src:{connectionId:e.srcConnId,path:e.srcPath},dst:{connectionId:e.dstConnId,path:e.dstPath},size:e.size||null})}).then(s=>s.json()).then(s=>{if(!(s!=null&&s.success))throw new Error((s==null?void 0:s.error)||"copy error")}),$(s=>({...s,doneFiles:s.doneFiles+1,doneBytes:Math.min(s.totalBytes,s.doneBytes+(e.size||0))}))}catch(s){alert(`Copy failed: ${s.message||s}`)}finally{C({jobId:null,bytes:0,total:0})}}L.current=!1,$(e=>({...e,phase:U?"Paused":B.length?"Queued":"Done",running:B.length>0||U}))}const M=async(e,s)=>{if(!e.conn||!s.conn)return;const d=Array.from(e.sel);if(d.length){T(!0);try{await o(e,s,d)}catch(j){alert(j.message||"enqueue failed")}finally{T(!1)}}},P=({pane:e})=>{var s;return t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs(Z,{value:((s=e.conn)==null?void 0:s.id)||"",onChange:d=>{const j=d.target.value,n=v.find(y=>y.id===j)||null;e.setConn(n),(n==null?void 0:n.status)==="connected"&&e.list(".")},children:[t.jsx("option",{value:"",children:"Pick connection…"}),v.map(d=>t.jsxs("option",{value:d.id,children:[d.type.toUpperCase()," • ",d.name]},d.id))]}),t.jsx(D,{variant:"secondary",onClick:()=>Q(e),disabled:!e.conn||e.conn.status==="connected",children:"Connect"}),t.jsx(D,{variant:"secondary",onClick:async()=>{e.conn&&(await ee(e.conn.id),e.setConn({...e.conn,status:"disconnected"}))},disabled:!e.conn||e.conn.status!=="connected",children:"Disconnect"})]})},F=({pane:e,side:s,onDropFromOther:d,onDropLocal:j})=>t.jsxs("div",{className:"flex-1 flex flex-col border rounded",children:[t.jsxs("div",{className:"flex items-center gap-2 p-2 border-b",children:[t.jsx(D,{variant:"secondary",onClick:e.goUp,children:"Up"}),t.jsx(D,{variant:"secondary",onClick:()=>e.list(e.cwd),children:"Refresh"}),t.jsx(X,{className:"flex-1",value:e.cwd,onChange:n=>e.setCwd(n.target.value)}),t.jsx("input",{type:"file",multiple:!0,onChange:async n=>{if(!e.conn||e.conn.status!=="connected")return;const y=Array.from(n.target.files||[]);for(const l of y){const h=new FormData;h.append("connectionId",e.conn.id),h.append("cwd",e.cwd||"."),h.append("file",l,l.name),await fetch("/unicon/api/stream/upload",{method:"POST",body:h})}try{await e.list(e.cwd)}catch{}n.target.value=""}}),t.jsx(D,{onClick:()=>e.list(e.cwd),disabled:!e.conn||e.conn.status!=="connected",children:"Go"}),t.jsx(D,{variant:"secondary",onClick:()=>{if(!e.conn||e.conn.status!=="connected")return;const n=Array.from(e.sel);if(n.length)for(const y of n){const l=e.cwd==="/"?`/${y}`:`${e.cwd}/${y}`,h=`/unicon/api/stream/download?connectionId=${encodeURIComponent(e.conn.id)}&path=${encodeURIComponent(l)}`,u=document.createElement("a");u.href=h,u.download="",u.target="_blank",document.body.appendChild(u),u.click(),u.remove()}},disabled:!e.sel.size,children:"Download"})]}),t.jsx("div",{className:"flex-1 overflow-auto",onDragOver:n=>n.preventDefault(),onDrop:n=>{try{const y=n.dataTransfer.getData("application/x-unicon-local");if(y){const h=JSON.parse(y);if(Array.isArray(h.relPaths)&&h.relPaths.length){j&&j(h.relPaths);return}}const l=n.dataTransfer.getData("application/x-unicon");if(l){const h=JSON.parse(l);if(h.from&&h.from!==s&&Array.isArray(h.names)&&h.names.length){d(h.names,h.from);return}}}catch{}},children:t.jsxs("table",{className:"w-full text-sm",children:[t.jsx("thead",{className:"bg-gray-50",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-2 py-1 w-6"}),t.jsx("th",{className:"text-left px-2 py-1",children:"Name"}),t.jsx("th",{className:"text-left px-2 py-1",children:"Type"}),t.jsx("th",{className:"text-left px-2 py-1",children:"Size"})]})}),t.jsxs("tbody",{children:[e.items.map((n,y)=>{const l=n.isDirectory===!0||n.type==="d"||n.type===1,h=e.sel.has(n.name);return t.jsxs("tr",{className:`border-b ${h?"bg-blue-50":""}`,draggable:!0,onDragStart:u=>{const S=e.sel.has(n.name)?Array.from(e.sel):[n.name];u.dataTransfer.setData("application/x-unicon",JSON.stringify({from:s,names:S}))},onClick:u=>e.onRowClick(u,n,y),children:[t.jsx("td",{className:"px-2 py-1",children:!l&&t.jsx("input",{type:"checkbox",checked:h,onChange:u=>{u.stopPropagation();const S=new Set(e.sel);S.has(n.name)?S.delete(n.name):S.add(n.name),e.setSel(S)}})}),t.jsx("td",{className:"px-2 py-1",children:t.jsx("button",{className:"hover:underline",onClick:u=>{u.stopPropagation(),e.open(n)},children:n.name})}),t.jsx("td",{className:"px-2 py-1",children:l?"dir":"file"}),t.jsx("td",{className:"px-2 py-1",children:n.size??""})]},y)}),!e.items.length&&t.jsx("tr",{children:t.jsx("td",{className:"px-3 py-6 text-center text-gray-500",colSpan:4,children:e.loading?"Loading…":"Empty"})})]})]})})]});return t.jsxs("div",{className:"h-full flex flex-col gap-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("div",{className:"flex items-center gap-2",children:t.jsx("b",{children:"File Commander"})}),t.jsx(D,{variant:"secondary",onClick:w,children:"Reload connections"})]}),t.jsxs("div",{className:"flex items-center gap-6",children:[k?t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(D,{variant:"secondary",onClick:async()=>{await a.pickRoot()&&await a.list(".")},children:"Pick folder…"}),t.jsx("div",{className:"text-sm text-gray-600",children:a.rootName||"No folder selected"}),t.jsx(D,{variant:"secondary",onClick:()=>a.goUp(),disabled:!a.canGoUp,children:"Up"})]}):t.jsx(P,{pane:i}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(D,{onClick:()=>M(b,i),disabled:N||!b.sel.size,children:"← Copy"}),t.jsx(D,{onClick:()=>M(i,b),disabled:N||!i.sel.size,children:"Copy →"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(D,{variant:"secondary",onClick:()=>{E(!0),$(e=>({...e,phase:"Paused",running:!0}))},disabled:U||!p.running&&!B.length,children:"Pause"}),t.jsx(D,{variant:"secondary",onClick:()=>{E(!1),L.current||m()},disabled:!U,children:"Resume"}),t.jsx(D,{variant:"secondary",onClick:()=>{z([]),$(e=>({...e,running:!1,phase:"Canceled"}))},disabled:!B.length&&!p.running,children:"Cancel"})]}),t.jsxs("div",{className:"min-w-[300px] text-xs text-gray-700",children:[t.jsx("div",{className:"w-full h-2 bg-gray-200 rounded overflow-hidden mb-1",children:t.jsx("div",{className:"h-2 bg-blue-600",style:{width:`${p.totalBytes>0?Math.floor(100*((p.doneBytes+(x.bytes||0))/Math.max(1,p.totalBytes))):Math.floor(100*(p.doneFiles/Math.max(1,p.totalFiles)))}%`}})}),t.jsxs("div",{children:[p.phase||(B.length?"Queued":"")," ",p.doneFiles,"/",p.totalFiles," files · ",Math.round((p.doneBytes+(x.bytes||0))/1024)," / ",Math.round(Math.max(1,p.totalBytes)/1024)," KB · Queue: ",B.length]})]})]}),t.jsx(P,{pane:b}),t.jsx(D,{variant:"secondary",onClick:()=>O(e=>!e),children:k?"Use connection on left":"Use Local (This computer) on left"})]}),t.jsxs("div",{className:"flex gap-3 min-h-[400px]",children:[k?t.jsx(ne,{pane:a,side:"left"}):t.jsx(F,{side:"left",pane:i,onDropFromOther:e=>o(b,i,e)}),t.jsx(F,{side:"right",pane:b,onDropFromOther:e=>o(i,b,e),onDropLocal:async e=>{!b.conn||b.conn.status!=="connected"||(await a.uploadTo(b,e),await b.list(b.cwd))}})]})]})}function se(){const[i,b]=f.useState(null),[a,k]=f.useState([]),[O,v]=f.useState([]),[I,N]=f.useState(new Set),[T,p]=f.useState(!1),$=f.useMemo(()=>i?i.name||"Folder":"",[i]),B=f.useMemo(()=>a.length?a.join("/"):".",[a]),z=a.length>0;async function U(){try{const c=await window.showDirectoryPicker();return b(c),k([]),N(new Set),!0}catch{return!1}}async function E(){if(!i)return null;let c=i;for(const r of a)c=await c.getDirectoryHandle(r);return c}async function L(c="."){if(i){p(!0);try{if(c!=="."&&c){const o=String(c).split("/").filter(Boolean);k(o)}const r=await E();if(!r)return;const g=[];for await(const[o,m]of r.entries())if(m.kind==="directory")g.push({name:o,isDirectory:!0,type:"d"});else try{const M=await m.getFile();g.push({name:o,isDirectory:!1,type:"f",size:M.size})}catch{g.push({name:o,isDirectory:!1,type:"f"})}g.sort((o,m)=>o.isDirectory===m.isDirectory?o.name.localeCompare(m.name):o.isDirectory?-1:1),v(g),N(new Set)}finally{p(!1)}}}function x(){if(!z)return;const c=a.slice(0,-1);k(c),L(c.join("/")||".")}async function C(c){if(c.isDirectory){const r=[...a,c.name];k(r),await L(r.join("/"))}else{const r=new Set([c.name]);N(r)}}function w(c,r,g){const o=c.ctrlKey||c.metaKey;if(c.shiftKey,!r.isDirectory)if(o){const m=new Set(I);m.has(r.name)?m.delete(r.name):m.add(r.name),N(m)}else N(new Set([r.name]))}async function Q(c){let r=await E();const g=String(c).split("/").filter(Boolean);for(let o=0;o<g.length;o++){const m=g[o];if(o===g.length-1)return r.getFileHandle(m);r=await r.getDirectoryHandle(m)}}async function K(c){const r=[];async function g(o){let M=await E();if(o&&o!=="."){const P=o.split("/").filter(Boolean);for(const F of P)M=await M.getDirectoryHandle(F)}for await(const[P,F]of M.entries())if(F.kind==="directory")await g(o&&o!=="."?`${o}/${P}`:P);else{const e=await F.getFile();r.push({rel:o&&o!=="."?`${o}/${P}`:P,file:e})}}try{const o=await Q(c).catch(()=>null);if(o){const m=await(await o).getFile();r.push({rel:c,file:m})}else await g(c)}catch{}return r}async function R(c,r){for(const g of r){const o=await K(g);for(const{rel:m,file:M}of o){const P=m.split("/").slice(0,-1).join("/");if(P)try{await J(c.conn.id,"mkdir",{path:P})}catch{}const F=new FormData;F.append("connectionId",c.conn.id),F.append("cwd",P||c.cwd||"."),F.append("file",M,m.split("/").pop()),await fetch("/unicon/api/stream/upload",{method:"POST",body:F})}}}return{root:i,rootName:$,items:O,sel:I,setSel:N,loading:T,cwd:B,canGoUp:z,pickRoot:U,list:L,goUp:x,open:C,onRowClick:w,uploadTo:R}}function ne({pane:i,side:b}){return t.jsxs("div",{className:"flex-1 flex flex-col border rounded",onDragOver:a=>a.preventDefault(),children:[t.jsxs("div",{className:"flex items-center gap-2 p-2 border-b",children:[t.jsx(X,{className:"flex-1",value:i.cwd,readOnly:!0}),t.jsx(D,{variant:"secondary",onClick:()=>i.goUp(),disabled:!i.canGoUp,children:"Up"})]}),t.jsx("div",{className:"flex-1 overflow-auto",children:t.jsxs("table",{className:"w-full text-sm",children:[t.jsx("thead",{className:"bg-gray-50",children:t.jsxs("tr",{children:[t.jsx("th",{className:"w-6"}),t.jsx("th",{className:"text-left px-2 py-1",children:"Name"}),t.jsx("th",{className:"text-left px-2 py-1",children:"Type"}),t.jsx("th",{className:"text-left px-2 py-1",children:"Size"})]})}),t.jsxs("tbody",{children:[i.items.map((a,k)=>{const O=i.sel.has(a.name);return t.jsxs("tr",{className:`border-b ${O?"bg-blue-50":""}`,draggable:!a.isDirectory,onDragStart:v=>{const I=i.sel.has(a.name)?Array.from(i.sel):[a.name];v.dataTransfer.setData("application/x-unicon-local",JSON.stringify({relPaths:I}))},onClick:v=>i.onRowClick(v,a,k),children:[t.jsx("td",{className:"px-2 py-1",children:!a.isDirectory&&t.jsx("input",{type:"checkbox",checked:O,onChange:v=>{v.stopPropagation();const I=new Set(i.sel);I.has(a.name)?I.delete(a.name):I.add(a.name),i.setSel(I)}})}),t.jsx("td",{className:"px-2 py-1",children:t.jsx("button",{className:"hover:underline",onClick:v=>{v.stopPropagation(),i.open(a)},children:a.name})}),t.jsx("td",{className:"px-2 py-1",children:a.isDirectory?"dir":"file"}),t.jsx("td",{className:"px-2 py-1",children:a.size??""})]},k)}),!i.items.length&&t.jsx("tr",{children:t.jsx("td",{className:"px-3 py-6 text-center text-gray-500",colSpan:4,children:i.loading?"Loading…":"Empty"})})]})]})})]})}export{le as default};
//# sourceMappingURL=Commander-ByuJmWGL.js.map
