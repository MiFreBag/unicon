import{j as s,B as g,l as _,o as z,m as G,n as W,I as H,f as V}from"./index-BCks31WA.js";import{R as f}from"./vendor-CnGqnXYo.js";import"./icons-oCSk50xQ.js";function J(){const[m,C]=f.useState(null),[p,M]=f.useState("."),[B,I]=f.useState([]),[d,h]=f.useState(new Set),[y,D]=f.useState(-1),[v,P]=f.useState(!1),w=f.useCallback(async i=>{if(!m||m.status!=="connected")return;const x=i??p;P(!0);try{const u=await z(m.id,"list",{path:x});u!=null&&u.success&&(I(u.data||[]),M(x),h(new Set),D(-1))}finally{P(!1)}},[m,p]),R=()=>{if(!p||p==="."||p==="/"){w("/");return}const i=String(p).replace(/\\+/g,"/").split("/");i.pop(),w(i.join("/")||"/")},O=i=>{if(i.isDirectory===!0||i.type==="d"||i.type===1){const u=p==="/"?`/${i.name}`:`${p}/${i.name}`;w(u)}else{const u=new Set([i.name]);h(u)}};function F(i,x,u){if(x.isDirectory===!0||x.type==="d"||x.type===1)return;const $=i.ctrlKey||i.metaKey;if(i.shiftKey&&y!==-1){const b=Math.min(y,u),Q=Math.max(y,u),A=B.slice(b,Q+1).filter(e=>!(e.isDirectory===!0||e.type==="d"||e.type===1)).map(e=>e.name);h(new Set(A))}else if($){const b=new Set(d);b.has(x.name)?b.delete(x.name):b.add(x.name),h(b),D(u)}else h(new Set([x.name])),D(u)}return{conn:m,setConn:C,cwd:p,setCwd:M,items:B,sel:d,setSel:h,lastIndex:y,setLastIndex:D,list:w,goUp:R,open:O,loading:v,onRowClick:F}}function se(){const m=J(),C=J(),[p,M]=f.useState([]),[B,I]=f.useState(!1),[d,h]=f.useState({totalFiles:0,doneFiles:0,totalBytes:0,doneBytes:0,running:!1,phase:""}),[y,D]=f.useState([]),[v,P]=f.useState(!1),w=f.useRef(!1),R=async()=>{const n=((await _()).connections||[]).filter(t=>["localfs","ftp","sftp"].includes(t.type));M(n)};f.useEffect(()=>{R()},[]);const O=async e=>{e.conn&&(e.conn.status!=="connected"&&(await V(e.conn.id),e.setConn({...e.conn,status:"connected"})),await e.list("."))};function F(e){return String(e||"").replace(/\\+/g,"/").replace(/\/+/,"/")}function i(e,n){return!e||e==="."?n||"":e.endsWith("/")?n?`${e}${n}`:e:n?`${e}/${n}`:e}function x(e){const t=F(e).split("/");return t.pop(),t.join("/")||"/"}async function u(e,n){const t=F(n);if(!t||t==="."||t==="/")return;const a=t.split("/");let o="";for(const l of a){o=o?`${o}/${l}`:l;try{await z(e.conn.id,"mkdir",{path:o})}catch{}}}async function K(e,n,t){const a=[];let o=0;const l=F(e.cwd),c=new Map((e.items||[]).map(r=>[r.name,r]));async function j(r,N){const k=await z(e.conn.id,"list",{path:r}),U=(k==null?void 0:k.data)||[];for(const S of U){const q=i(r,S.name),L=i(N,S.name);if(S.isDirectory===!0||S.type==="d"||S.type===1)await j(q,L);else{const T=Number(S.size||0);o+=T,a.push({srcPath:q,rel:L,size:T})}}}for(const r of t){const N=c.get(r),k=i(l,r);if(N&&(N.isDirectory===!0||N.type==="d"||N.type===1))await j(k,r);else{const S=Number((N==null?void 0:N.size)||0);o+=S,a.push({srcPath:k,rel:r,size:S})}}return{files:a,totalBytes:o}}async function $(e,n,t){h(c=>({...c,running:!0,phase:c.running?c.phase:"Queued",totalFiles:c.totalFiles,totalBytes:c.totalBytes}));const{files:a,totalBytes:o}=await K(e,n,t),l=a.map(c=>({srcConnId:e.conn.id,dstConnId:n.conn.id,srcPath:c.srcPath,dstPath:i(n.cwd,c.rel),size:c.size}));D(c=>[...c,...l]),h(c=>({...c,totalFiles:c.totalFiles+l.length,totalBytes:c.totalBytes+o})),!w.current&&!v&&E()}async function E(){var e;for(w.current=!0,h(n=>({...n,running:!0,phase:"Copying…"}));!v;){let n=null;if(D(t=>t.length?(n=t[0],t.slice(1)):t),!n)break;try{await u({conn:{id:n.dstConnId}},x(n.dstPath.replace(/^\/+/,"")));const t=await z(n.srcConnId,"download",{path:n.srcPath});if(!(t!=null&&t.success))throw new Error((t==null?void 0:t.error)||"download failed");await z(n.dstConnId,"upload",{path:n.dstPath,base64:(e=t.data)==null?void 0:e.base64}),h(a=>({...a,doneFiles:a.doneFiles+1,doneBytes:Math.min(a.totalBytes,a.doneBytes+(n.size||0))}))}catch(t){alert(`Copy failed: ${t.message||t}`)}}w.current=!1,h(n=>({...n,phase:v?"Paused":y.length?"Queued":"Done",running:y.length>0||v}))}const b=async(e,n)=>{if(!e.conn||!n.conn)return;const t=Array.from(e.sel);if(t.length){I(!0);try{await $(e,n,t)}catch(a){alert(a.message||"enqueue failed")}finally{I(!1)}}},Q=({pane:e})=>{var n;return s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(G,{value:((n=e.conn)==null?void 0:n.id)||"",onChange:t=>{const a=t.target.value,o=p.find(l=>l.id===a)||null;e.setConn(o),(o==null?void 0:o.status)==="connected"&&e.list(".")},children:[s.jsx("option",{value:"",children:"Pick connection…"}),p.map(t=>s.jsxs("option",{value:t.id,children:[t.type.toUpperCase()," • ",t.name]},t.id))]}),s.jsx(g,{variant:"secondary",onClick:()=>O(e),disabled:!e.conn||e.conn.status==="connected",children:"Connect"}),s.jsx(g,{variant:"secondary",onClick:async()=>{e.conn&&(await W(e.conn.id),e.setConn({...e.conn,status:"disconnected"}))},disabled:!e.conn||e.conn.status!=="connected",children:"Disconnect"})]})},A=({pane:e,side:n,onDropFromOther:t})=>s.jsxs("div",{className:"flex-1 flex flex-col border rounded",children:[s.jsxs("div",{className:"flex items-center gap-2 p-2 border-b",children:[s.jsx(g,{variant:"secondary",onClick:e.goUp,children:"Up"}),s.jsx(g,{variant:"secondary",onClick:()=>e.list(e.cwd),children:"Refresh"}),s.jsx(H,{className:"flex-1",value:e.cwd,onChange:a=>e.setCwd(a.target.value)}),s.jsx(g,{onClick:()=>e.list(e.cwd),disabled:!e.conn||e.conn.status!=="connected",children:"Go"})]}),s.jsx("div",{className:"flex-1 overflow-auto",onDragOver:a=>a.preventDefault(),onDrop:a=>{try{const o=a.dataTransfer.getData("application/x-unicon");if(!o)return;const l=JSON.parse(o);l.from&&l.from!==n&&Array.isArray(l.names)&&l.names.length&&t(l.names,l.from)}catch{}},children:s.jsxs("table",{className:"w-full text-sm",children:[s.jsx("thead",{className:"bg-gray-50",children:s.jsxs("tr",{children:[s.jsx("th",{className:"px-2 py-1 w-6"}),s.jsx("th",{className:"text-left px-2 py-1",children:"Name"}),s.jsx("th",{className:"text-left px-2 py-1",children:"Type"}),s.jsx("th",{className:"text-left px-2 py-1",children:"Size"})]})}),s.jsxs("tbody",{children:[e.items.map((a,o)=>{const l=a.isDirectory===!0||a.type==="d"||a.type===1,c=e.sel.has(a.name);return s.jsxs("tr",{className:`border-b ${c?"bg-blue-50":""}`,draggable:!0,onDragStart:j=>{const r=e.sel.has(a.name)?Array.from(e.sel):[a.name];j.dataTransfer.setData("application/x-unicon",JSON.stringify({from:n,names:r}))},onClick:j=>e.onRowClick(j,a,o),children:[s.jsx("td",{className:"px-2 py-1",children:!l&&s.jsx("input",{type:"checkbox",checked:c,onChange:j=>{j.stopPropagation();const r=new Set(e.sel);r.has(a.name)?r.delete(a.name):r.add(a.name),e.setSel(r)}})}),s.jsx("td",{className:"px-2 py-1",children:s.jsx("button",{className:"hover:underline",onClick:j=>{j.stopPropagation(),e.open(a)},children:a.name})}),s.jsx("td",{className:"px-2 py-1",children:l?"dir":"file"}),s.jsx("td",{className:"px-2 py-1",children:a.size??""})]},o)}),!e.items.length&&s.jsx("tr",{children:s.jsx("td",{className:"px-3 py-6 text-center text-gray-500",colSpan:4,children:e.loading?"Loading…":"Empty"})})]})]})})]});return s.jsxs("div",{className:"h-full flex flex-col gap-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("div",{className:"flex items-center gap-2",children:s.jsx("b",{children:"File Commander"})}),s.jsx(g,{variant:"secondary",onClick:R,children:"Reload connections"})]}),s.jsxs("div",{className:"flex items-center gap-6",children:[s.jsx(Q,{pane:m}),s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(g,{onClick:()=>b(C,m),disabled:B||!C.sel.size,children:"← Copy"}),s.jsx(g,{onClick:()=>b(m,C),disabled:B||!m.sel.size,children:"Copy →"}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(g,{variant:"secondary",onClick:()=>{P(!0),h(e=>({...e,phase:"Paused",running:!0}))},disabled:v||!d.running&&!y.length,children:"Pause"}),s.jsx(g,{variant:"secondary",onClick:()=>{P(!1),w.current||E()},disabled:!v,children:"Resume"}),s.jsx(g,{variant:"secondary",onClick:()=>{D([]),h(e=>({...e,running:!1,phase:"Canceled"}))},disabled:!y.length&&!d.running,children:"Cancel"})]}),s.jsxs("div",{className:"min-w-[260px] text-xs text-gray-700",children:[s.jsx("div",{className:"w-full h-2 bg-gray-200 rounded overflow-hidden mb-1",children:s.jsx("div",{className:"h-2 bg-blue-600",style:{width:`${d.totalBytes>0?Math.floor(100*(d.doneBytes/Math.max(1,d.totalBytes))):Math.floor(100*(d.doneFiles/Math.max(1,d.totalFiles)))}%`}})}),s.jsxs("div",{children:[d.phase||(y.length?"Queued":"")," ",d.doneFiles,"/",d.totalFiles," files · ",Math.round(d.doneBytes/1024)," / ",Math.round(Math.max(1,d.totalBytes)/1024)," KB · Queue: ",y.length]})]})]}),s.jsx(Q,{pane:C})]}),s.jsxs("div",{className:"flex gap-3 min-h-[400px]",children:[s.jsx(A,{side:"left",pane:m,onDropFromOther:e=>$(C,m,e)}),s.jsx(A,{side:"right",pane:C,onDropFromOther:e=>$(m,C,e)})]})]})}export{se as default};
//# sourceMappingURL=Commander-9fLv4-Sw.js.map
