
syntax = "proto3";

package core.cpd_adapter_subsStreamV1;


// Interface exported by the server.
service cpdSubsStream {
  
  rpc SubsStream(stream SubsStreamReq) returns (stream SubsStreamResp) {}
}


// Subscription 
//--------------
message SubsStreamReq {
    uint32 reqId = 1; //provided by calling client to assoiciate SubsStreamResp to original request
    oneof cmd {
        SubsStreamInit initialize = 2;
        SimpleSubscribeRequest simpleSubscribe = 3;
        SubscribeRequest subscribe = 4;
        UnsubscribeRequest unsubscribe = 5;  // remove by id
        bool unsubscribeAll = 6;             // remove all subscription of this Stream 
    }
}

message SubsStreamResp {
   
    oneof resp {
        StatusResp statusResp = 1; //resp to any normal cmd. e.g. initialize & unsubscribe
        SubsResp subsResp = 2;  //  resp to subs cmds (simpleSubscribe/subscribe) return a subsId (subs handler)
        TopicChange data = 3;    // continous flow of changed topics, also incl. assoiciated subsId
    }
}

message StatusResp {
    uint32 reqId = 1; // original req id from req
    uint32 code = 2; //0=ok, >0 = failure
    string message = 3;
}

message SubsResp {
    uint32 reqId = 1; // original req id from req
    uint32 code = 2; //0=ok, >0 = failure
    string message = 3;
    uint32 subsId = 4; // on failure, subsId must not to be interpreted
}


message SubsStreamInit {
    string clientClass = 1; // clientCall + clientName form a unique UID in context of all services in the system
    string clientName = 2;
}

message SimpleSubscribeRequest {
    repeated string topicpattern = 1;
}

message SubscribeRequest {
    FilterDef filterDef = 1;
    SubsConfig subsConfig = 2;
}


message UnsubscribeRequest {
    uint32 subsId = 1;
}


message TopicData {
    string topic = 1;
    string data = 2;
}


message TopicChange {
    uint32 subsId = 1; //subsId
    repeated TopicData topicData = 2;
}


message FilterDef {
    enum Mode {
        DEFAULT = 0;    //only direct Topicnames are matches
        MD = 1;         //Metadata Topics are automatically merged within cpd_adapter.
        DELTA = 2;      //DELTA Topics are automatically merged within cpd_adapter
    }
    Mode mode = 1;
    bool caseSensitive = 2;
    repeated string namespaces = 3;     // DEPRECATED! dont' use it anymore (set default)
    repeated string topicpattern = 4;   //e.g ["sw.sensor.#"] or ["sw.sensor.test1", "sw.sensor.test2"]
    repeated string topictext = 5;      //optional, typically not used on Subscription
    repeated string payload = 6;        //optional
    uint32 limit = 7; //optional

}

message SubsConfig {

    // typically FALSE, storeALL=true forces storage of all topicdata within cpd_adapter. 
    // If storeALL=false cpd_adapter only stores the data if really needed (e.g Delta-Data, AGGR-Data)
    // storAll=true might be usefull if you use the cpd_adapter as a storage to adhoc query the most recent data of a topic
    // please consider performance and resource usage if storAll=true.
    bool storeAll = 1; 

    // TRUE: (simple mode) only the exact topics currently available (as seen by TOM) are subscribed, 
    // FALSE: future topics that matches the FilterDef will also be received
    // please consider performance and resource usage if flatSubscribe=false.
    bool flatSubscribe = 2; 
    
    // TRUE: initially, the latest data from TOM will be sent to the client
    // FALSE: only actual event data on CPD will be sent to the client
    bool sendInitialData = 3;

    AggrMode aggrMode = 4;
    enum AggrMode {
        
        //standard mode, any subscribed Topic is individually send to client if data changed.
        ON_ANY = 0;
        
        //all subscribed topics are sent as a group. This mode waits until all topic are newely received since last send 
        //or aggrTime is expired. aggrTime basically defines a time window in which all associated topics should have updated theier data.
        ON_CAPTURETIME = 1;
        
        //on receive of aggrTriggerTopic all subscribed topics will be send as a group to the client
        ON_CAPTURETRIGGER = 2;
    };

    uint32 aggrTime = 5; //Time in ms, onMode CaptureTime this is captureTime
    string aggrTriggerTopic = 6;
}

